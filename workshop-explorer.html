<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'green-primary': '#27ae60',
                        'green-secondary': '#2ecc71',
                        'green-light': '#f4fff4',
                        'brand-dark': '#2c3e50',
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }

        .tab-panel {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- TOP NAVIGATION -->
    <header class="bg-brand-dark text-white shadow-md z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between h-auto md:h-20 items-center py-2 md:py-0">
                <div class="flex items-center gap-2 mb-2 md:mb-0 whitespace-nowrap">
                    <span class="text-2xl">üõ†Ô∏è</span>
                    <h1 class="text-xl font-bold tracking-wide">Workshop <span class="text-green-secondary">Explorer</span><sup class="text-xs text-gray-400 ml-1">¬© Maker Mindz</sup></h1>
                </div>
                <div class="flex flex-wrap justify-center gap-2" id="nav-buttons">
                    <!-- Buttons injected by JS -->
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- SIDEBAR: Lessons -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col overflow-y-auto z-10">
            <div class="p-4 border-b border-gray-100">
                <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Select Lesson</h2>
                <div id="lesson-list" class="space-y-2">
                    <!-- Lessons injected by JS -->
                </div>
            </div>
            <div class="p-4 mt-auto">
                <div class="text-xs text-gray-400 text-center">
                    Session Active<br>
                    <span id="session-status" class="text-green-500 font-bold">No Category Selected</span>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 overflow-y-auto p-6 md:p-10 relative" id="main-content">
            
            <!-- Welcome State -->
            <div id="welcome-view" class="h-full flex flex-col items-center justify-center text-center text-gray-500">
                <div class="text-6xl mb-4">üîê</div>
                <h2 class="text-2xl font-bold text-gray-700">Select a Workshop Category</h2>
                <p class="mt-2 max-w-md">Please select a category from the top menu. You will need a password to access the content.</p>
            </div>

            <!-- Topic View -->
            <div id="topic-view" class="hidden max-w-5xl mx-auto">
                <div class="mb-6 border-b pb-4">
                    <div class="flex items-center gap-2 text-sm text-green-primary font-bold uppercase tracking-wide mb-1">
                        <span id="crumb-category"></span>
                    </div>
                    <h1 id="topic-title" class="text-3xl font-extrabold text-gray-900"></h1>
                </div>

                <!-- TABS -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button onclick="App.setTab('lesson')" id="tab-lesson" class="px-6 py-3 font-medium text-gray-500 hover:text-green-primary border-b-2 border-transparent hover:border-green-primary focus:outline-none">üìñ Lesson</button>
                    <button onclick="App.setTab('simulation')" id="tab-simulation" class="px-6 py-3 font-medium text-gray-500 hover:text-green-primary border-b-2 border-transparent hover:border-green-primary focus:outline-none">üéÆ Simulation</button>
                    <button onclick="App.setTab('quiz')" id="tab-quiz" class="px-6 py-3 font-medium text-gray-500 hover:text-green-primary border-b-2 border-transparent hover:border-green-primary focus:outline-none">üìù Quiz</button>
                </div>

                <!-- CONTENT PANELS -->
                <div id="panel-lesson" class="tab-panel hidden prose max-w-none text-gray-700 leading-relaxed">
                    <!-- Lesson Content Injected Here -->
                </div>

                <div id="panel-simulation" class="tab-panel hidden">
                    <div id="sim-host" class="w-full bg-white rounded-xl shadow-sm border border-gray-200 min-h-[500px] p-4 relative">
                        <!-- Dynamic Simulation Injected Here -->
                    </div>
                </div>

                <div id="panel-quiz" class="tab-panel hidden">
                    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                        <h3 class="text-xl font-bold mb-6 text-gray-800">Knowledge Check</h3>
                        <div id="quiz-container" class="space-y-6">
                            <!-- Quiz Questions Injected Here -->
                        </div>
                        <div id="quiz-results" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg text-center"></div>
                        <button onclick="App.submitQuiz()" id="btn-submit-quiz" class="mt-8 w-full bg-green-primary text-white py-3 rounded-lg font-bold hover:bg-green-secondary transition shadow-md">Submit Answers</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 shadow-xl">
            <h3 class="text-lg font-bold mb-4 text-gray-800" id="modal-title">Enter Password</h3>
            <input type="password" id="modal-input" class="w-full border border-gray-300 p-2 rounded mb-4 focus:outline-none focus:border-green-primary" placeholder="Password">
            <div class="flex justify-end gap-2">
                <button onclick="App.cancelPassword()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded font-medium">Cancel</button>
                <button onclick="App.submitPassword()" class="px-4 py-2 bg-green-primary text-white rounded hover:bg-green-secondary font-medium">Submit</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-80 shadow-xl text-center">
            <div id="alert-icon" class="text-4xl mb-2"></div>
            <h3 id="alert-message" class="text-lg font-bold mb-4 text-gray-800"></h3>
            <button onclick="document.getElementById('alert-modal').classList.add('hidden'); document.getElementById('alert-modal').classList.remove('flex');" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded font-medium">Close</button>
        </div>
    </div>

    <script>
        // --- CURRICULUM DATA ---
        const curriculum = {
            'motion': {
                title: "Science of Motion",
                passwordHash: "3297106",
                lessons: [
                    { 
                        id: 'l1', 
                        title: 'Lesson 1: Introduction to Forces & Motion', 
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Introduction to Forces & Motion</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. The Scientific Method</h4>
                            <p class="mb-4">Scientists use a structured approach to understand the world:</p>
                            <ol class="list-decimal ml-8 mb-4 space-y-1">
                                <li><strong>Observation:</strong> Notice something interesting.</li>
                                <li><strong>Question:</strong> Ask "Why?" or "How?".</li>
                                <li><strong>Hypothesis:</strong> Make a prediction (an educated guess).</li>
                                <li><strong>Experiment:</strong> Test the hypothesis with a fair test.</li>
                                <li><strong>Analysis:</strong> Look at the data.</li>
                                <li><strong>Conclusion:</strong> Was the hypothesis correct?</li>
                            </ol>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. What is a Force?</h4>
                            <p class="mb-4">A <strong>Force</strong> is simply a <strong>Push</strong> or a <strong>Pull</strong> upon an object resulting from its interaction with another object. Forces have both magnitude (strength) and direction.</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Unit:</strong> Newton (N).</li>
                                <li><strong>1 Newton:</strong> The force required to accelerate a 1 kg mass by 1 m/s¬≤. (Approx. the weight of a small apple).</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Types of Forces</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm">
                                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                    <strong>Contact Forces</strong> (Touch required)<br>- Friction<br>- Tension<br>- Normal Force<br>- Air Resistance
                                </div>
                                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                                    <strong>Non-Contact Forces</strong> (Action at a distance)<br>- Gravitational Force<br>- Magnetic Force<br>- Electrical Force
                                </div>
                            </div>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Net Force & Motion</h4>
                            <p class="mb-4"><strong>Net Force</strong> is the sum of all forces acting on an object.</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Balanced Forces (Net Force = 0):</strong> Object stays at rest OR continues moving at constant velocity.</li>
                                <li><strong>Unbalanced Forces (Net Force ‚â† 0):</strong> Object accelerates (changes speed or direction). To change the direction of a moving object, an unbalanced force must act on it sideways.</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Friction</h4>
                            <p class="mb-4"><strong>Friction</strong> is a force that opposes motion between two surfaces in contact. It depends on the texture of the surfaces and how hard they are pressed together.</p>
                            <p class="mb-4"><strong>Real World Application:</strong> Friction allows us to walk without slipping and car brakes to stop a vehicle. However, it also causes wear and tear on machinery.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">6. Center of Mass</h4>
                            <p class="mb-4">The <strong>Center of Mass</strong> is the average position of all the mass in an object. It's the point where the object can be balanced. For a symmetrical object, it's in the center. For irregular objects, it shifts towards the heavier side.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">üè† Hands-On Activities</h4>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <ul class="list-disc ml-6 space-y-2">
                                    <li><strong>Measure Force:</strong> Attach a rubber band to an object (like a shoe). Pull it across a table. Measure how much the band stretches (this represents force) to start moving it vs keeping it moving.</li>
                                    <li><strong>Explore Friction:</strong> Pull the same object across different surfaces (carpet, tile, ice). Compare the rubber band stretch.</li>
                                    <li><strong>Find Center of Mass:</strong> Try to balance a broomstick on one finger. Move your finger until it stays level. That point is the center of mass!</li>
                                </ul>
                            </div>
                        `,
                        simType: 'motionLab',
                        quiz: [
                            { q: "What is the unit of force?", options: ["Joule", "Watt", "Newton", "Meter"], a: 2 },
                            { q: "Which is a non-contact force?", options: ["Friction", "Tension", "Gravity", "Air Resistance"], a: 2 },
                            { q: "If forces are balanced, an object:", options: ["Accelerates", "Stops immediately", "Maintains constant velocity", "Explodes"], a: 2 },
                            { q: "Friction acts in which direction?", options: ["Same as motion", "Opposite to motion", "Perpendicular to motion", "Downwards"], a: 1 },
                            { q: "The point where an object balances is called:", options: ["Center of Gravity/Mass", "Fulcrum", "Midpoint", "Vertex"], a: 0 }
                        ]
                    },
                    {
                        id: 'l2',
                        title: 'Lesson 2: Newton\'s Laws & Inertia',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Newton's Laws & Inertia</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. Inertia: The Resistance to Change</h4>
                            <p class="mb-4"><strong>Inertia</strong> is the tendency of an object to resist changes in its state of motion. If it's resting, it wants to stay resting. If it's moving, it wants to keep moving.</p>
                            <p class="mb-4"><strong>Mass</strong> is a measure of inertia. The more mass an object has, the harder it is to start moving it or stop it.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Newton's First Law (Law of Inertia)</h4>
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                                <p>"An object at rest stays at rest and an object in motion stays in motion with the same speed and in the same direction unless acted upon by an unbalanced force."</p>
                            </div>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Newton's Second Law (F=ma)</h4>
                            <p class="mb-4">The acceleration of an object depends on the <strong>Net Force</strong> acting on it and the <strong>Mass</strong> of the object.</p>
                            <p class="font-mono bg-gray-100 p-2 rounded text-center mb-4">Force = Mass √ó Acceleration</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li>More Force = More Acceleration.</li>
                                <li>More Mass = Less Acceleration (for the same force).</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Newton's Third Law (Action-Reaction)</h4>
                            <p class="mb-4">"For every action, there is an equal and opposite reaction."</p>
                            <p class="mb-4">Forces always come in pairs. If you push on a wall, the wall pushes back on you with the same force.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Rotational Inertia</h4>
                            <p class="mb-4">Just as mass resists linear motion, <strong>Rotational Inertia</strong> (Moment of Inertia) resists rotational motion. It depends on mass and <em>how far that mass is distributed from the center of rotation</em>.</p>
                            <p class="mb-4"><em>Example:</em> An ice skater spins faster when pulling arms in (reducing rotational inertia) and slower when extending arms.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">6. Gravity & Falling Objects</h4>
                            <p class="mb-4"><strong>Does gravity affect all objects equally?</strong> Yes! In a vacuum (no air resistance), a feather and a hammer fall at the same rate. Gravity accelerates everything at roughly <strong>9.8 m/s¬≤</strong> on Earth, regardless of mass.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">üè† Experiments to Try</h4>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <ul class="list-disc ml-6 space-y-2">
                                    <li><strong>Inertia Trick:</strong> Place a playing card over a cup and put a coin on top. Flick the card horizontally. The card flies away, but the coin (due to inertia) drops straight into the cup!</li>
                                    <li><strong>Balloon Rocket (3rd Law):</strong> Tape a straw to a balloon. Thread a string through the straw. Blow up the balloon and let go. Air shoots back (Action), balloon shoots forward (Reaction).</li>
                                    <li><strong>The Heavy Box (2nd Law):</strong> Try pushing an empty box vs. a box full of books with the same strength. The full box accelerates much slower.</li>
                                </ul>
                            </div>
                        `,
                        simType: 'newtonLab',
                        quiz: [
                            { q: "Newton's First Law is also known as the Law of:", options: ["Gravity", "Inertia", "Acceleration", "Action-Reaction"], a: 1 },
                            { q: "If you double the mass of an object but keep force constant, acceleration:", options: ["Doubles", "Halves", "Stays the same", "Triples"], a: 1 },
                            { q: "Action and Reaction forces are:", options: ["Equal and Opposite", "Unequal", "In the same direction", "Unrelated"], a: 0 },
                            { q: "Why does a feather fall slower than a hammer on Earth?", options: ["Less Gravity", "Air Resistance", "Less Mass", "Magnetic Force"], a: 1 },
                            { q: "Rotational Inertia depends on mass and:", options: ["Color", "Temperature", "Distribution of mass", "Velocity"], a: 2 }
                        ]
                    },
                    {
                        id: 'l3',
                        title: 'Lesson 3: Work, Energy & Inclined Planes',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Work, Energy & Inclined Planes</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. What is Energy & Work?</h4>
                            <p class="mb-4"><strong>Energy</strong> is the ability to cause change or do work. <strong>Work</strong> in physics is defined as a Force applied over a Distance (W = F &times; d). If you push a wall and it doesn't move, you've done no work!</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Potential & Kinetic Energy</h4>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Potential Energy (PE):</strong> Stored energy. Gravitational PE depends on Mass, Gravity, and Height (PE = mgh). The higher you are, the more PE you have.</li>
                                <li><strong>Kinetic Energy (KE):</strong> Energy of motion. It depends on Mass and Velocity (KE = &frac12;mv<sup>2</sup>). Going faster increases energy exponentially!</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Conservation of Energy</h4>
                            <p class="mb-4">Energy is never lost, just transformed. As a skater goes down a ramp, PE turns into KE. At the bottom, PE is lowest and KE is highest.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Forces on an Inclined Plane</h4>
                            <p class="mb-4">When an object is on a slope, Gravity (F<sub>g</sub>) pulls it straight down. We split this force into two <strong>components</strong>:</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Perpendicular Force (F<sub>&perp;</sub>):</strong> Pushes the object <em>into</em> the ramp (mg cos(&theta;)). Balanced by Normal Force.</li>
                                <li><strong>Parallel Force (F<sub>&parallel;</sub>):</strong> Pushes the object <em>down</em> the ramp (mg sin(&theta;)). This causes acceleration!</li>
                            </ul>
                            <p class="mb-4">As the slope angle increases, F<sub>&parallel;</sub> increases (faster slide) and F<sub>&perp;</sub> decreases (less grip).</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">üè† Hands-On Activities</h4>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <ul class="list-disc ml-6 space-y-2">
                                    <li><strong>Ramp Race (Force Components):</strong> Use a book as a ramp. Slide a coin at different angles. Notice how steeper angles make it slide faster (more Parallel Force).</li>
                                    <li><strong>Pendulum (PE & KE):</strong> Tie a weight to a string. Pull it back (High PE). Let go. Watch it speed up at the bottom (High KE) and slow down at the top.</li>
                                    <li><strong>The Heavy Drop (PE):</strong> Drop a ball into sand from different heights. Higher drop = deeper crater (More PE converted to Work on sand).</li>
                                </ul>
                            </div>
                        `,
                        simType: 'energyRampLab',
                        quiz: [
                            { q: "What is the formula for Work?", options: ["W = m x a", "W = F x d", "W = m x g", "W = v / t"], a: 1 },
                            { q: "Gravitational Potential Energy depends on:", options: ["Speed", "Height and Mass", "Friction", "Time"], a: 1 },
                            { q: "As a ramp gets steeper, the force pulling the object down ($F_{\\parallel}$):", options: ["Increases", "Decreases", "Stays the same", "Becomes zero"], a: 0 },
                            { q: "Energy of motion is called:", options: ["Potential Energy", "Kinetic Energy", "Thermal Energy", "Nuclear Energy"], a: 1 },
                            { q: "Conservation of Energy states that energy:", options: ["Is destroyed by friction", "Is created by motion", "Transforms but is not lost", "Disappears over time"], a: 2 }
                        ]
                    },
                    { 
                        id: 'l4', 
                        title: 'Lesson 4: Fluids, Pressure & Buoyancy', 
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Fluids, Pressure & Buoyancy</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. Density: Mass in a Given Space</h4>
                            <p class="mb-4"><strong>Density</strong> is a measure of how much "stuff" (mass) is packed into a certain space (volume). A block of lead is much denser than a block of wood of the same size.</p>
                            <p class="font-mono bg-gray-100 p-2 rounded text-center mb-4">Density = Mass / Volume</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Pressure: Force over an Area</h4>
                            <p class="mb-4"><strong>Pressure</strong> is the amount of force applied over a specific area. A sharp needle creates high pressure because the force is concentrated on a tiny point.</p>
                            <p class="font-mono bg-gray-100 p-2 rounded text-center mb-4">Pressure = Force / Area</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Fluid Pressure:</strong> Increases with depth. The deeper you go, the more weight of the fluid is on top of you.</li>
                                <li><strong>Atmospheric Pressure:</strong> The pressure exerted by the weight of the air in the atmosphere.</li>
                                <li><strong>High to Low:</strong> Fluids (liquids and gases) always move from an area of high pressure to an area of low pressure.</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Pascal's Principle & Hydraulics</h4>
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                                <p><strong>Pascal's Principle</strong> states that a pressure change at any point in a confined, incompressible fluid is transmitted equally to all points throughout the fluid.</p>
                            </div>
                            <p class="mb-4">This is the magic behind <strong>hydraulic lifts</strong>. A small force on a small piston creates a pressure that acts on a large piston, generating a much larger output force. It's a force multiplier!</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Archimedes' Principle & Buoyancy</h4>
                            <p class="mb-4"><strong>Archimedes' Principle</strong> states that the upward <strong>buoyant force</strong> exerted on a body immersed in a fluid is equal to the weight of the fluid that the body displaces.</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li>If Buoyant Force > Object's Weight &rarr; It Floats.</li>
                                <li>If Buoyant Force < Object's Weight &rarr; It Sinks.</li>
                                <li>This is why a heavy steel ship floats: its shape displaces a huge volume of water, creating a massive buoyant force.</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Bernoulli's Principle & Lift</h4>
                            <p class="mb-4"><strong>Bernoulli's Principle</strong> states that for a fluid, an increase in speed occurs simultaneously with a decrease in pressure.</p>
                            <p class="mb-4"><strong>How Airplanes Fly:</strong> An airplane wing (airfoil) is shaped so that air travels faster over the top than the bottom. This creates lower pressure on top and higher pressure on the bottom, resulting in an upward force called <strong>Lift</strong>.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">üè† Home Experiments</h4>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <ul class="list-disc ml-6 space-y-2">
                                    <li><strong>The Floating Egg (Density):</strong> An egg sinks in fresh water. Add salt to the water, increasing its density. The egg will float!</li>
                                    <li><strong>Leaky Bottle (Fluid Pressure):</strong> Poke three holes in a plastic bottle at different heights. Fill it with water. The water from the lowest hole will shoot out the farthest because pressure is greatest at the bottom.</li>
                                    <li><strong>Paper Lift (Bernoulli):</strong> Hold a strip of paper just under your bottom lip and blow hard over the top. The paper will lift up because the fast-moving air you create has lower pressure.</li>
                                </ul>
                            </div>
                        `, 
                        simType: 'forcesLab', 
                        quiz: [
                            { q: "Buoyant force on an object is equal to the:", options: ["Weight of the object", "Volume of the object", "Weight of the fluid displaced", "Density of the fluid"], a: 2 },
                            { q: "An object will float if its density is ___ the density of the fluid.", options: ["Greater than", "Less than", "Equal to", "Twice"], a: 1 },
                            { q: "Pascal's principle is the basis for:", options: ["Airplanes", "Hydraulic lifts", "Submarines", "Sailing"], a: 1 },
                            { q: "As you go deeper in a fluid, the pressure:", options: ["Decreases", "Stays the same", "Increases", "Becomes zero"], a: 2 },
                            { q: "Bernoulli's principle states that faster moving fluid has:", options: ["Higher pressure", "Lower pressure", "Higher temperature", "Lower density"], a: 1 }
                        ] 
                    }
                ]
            },
            'matter': {
                title: "Matter & Energy",
                passwordHash: "-1111714016",
                lessons: [
                    {
                        id: 'l1',
                        title: 'Lesson 1: Matter & Energy',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Matter & Energy: The Building Blocks</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. What is Matter?</h4>
                            <p class="mb-4"><strong>Matter</strong> is anything that has mass and takes up space (volume). Everything around you - air, water, rocks, even you - is made of matter.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Properties of Matter</h4>
                            <p class="mb-4">Matter has properties that help us identify it:</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Physical Properties:</strong> Can be observed without changing the substance (e.g., Color, Density, Melting Point, Conductivity).</li>
                                <li><strong>Chemical Properties:</strong> Describe how a substance changes into a new substance (e.g., Flammability, Reactivity with acid).</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. States of Matter</h4>
                            <p class="mb-4">Matter exists in different states depending on how much <strong>Energy</strong> (heat) it has:</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Solid:</strong> Particles vibrate in place. Fixed shape and volume.</li>
                                <li><strong>Liquid:</strong> Particles slide past each other. Fixed volume, takes shape of container.</li>
                                <li><strong>Gas:</strong> Particles move fast and far apart. No fixed shape or volume.</li>
                                <li><strong>Plasma:</strong> Super-heated gas where electrons are stripped from atoms (ionized). Found in stars, lightning, and neon signs.</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. The Atom</h4>
                            <p class="mb-4">The smallest unit of matter. It consists of:</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Protons (+):</strong> Positive charge, in the nucleus.</li>
                                <li><strong>Neutrons (0):</strong> Neutral charge, in the nucleus.</li>
                                <li><strong>Electrons (-):</strong> Negative charge, orbiting the nucleus. Per the quantum model, instead of following a specific circular path, electrons exist in a fuzzy, 3D region of space called a "cloud".</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Changes in Matter</h4>
                            <p class="mb-4"><strong>Physical Change:</strong> Appearance changes, but substance stays the same (e.g., Melting ice, Tearing paper).<br>
                            <strong>Chemical Change:</strong> A new substance is formed (e.g., Rusting iron, Burning wood). Look for bubbles, color change, or heat.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">6. Conservation of Mass</h4>
                            <p class="mb-4">Matter cannot be created or destroyed, only changed in form. In a chemical reaction, the mass of reactants equals the mass of products.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">üè† Home Experiments</h4>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <ul class="list-disc ml-6 space-y-2">
                                    <li><strong>Oobleck (Non-Newtonian Fluid):</strong> Mix cornstarch and water. It acts like a solid when hit, but a liquid when poured.</li>
                                    <li><strong>Vinegar & Baking Soda:</strong> Mix them to see a chemical change (gas bubbles) that inflates a balloon.</li>
                                    <li><strong>Ice Melting:</strong> Watch ice melt (physical change) and measure the temperature stay constant at 0¬∞C until fully melted.</li>
                                </ul>
                            </div>
                        `,
                        simType: 'matterLab',
                        quiz: [
                            { q: "What is the fourth state of matter found in stars?", options: ["Solid", "Liquid", "Gas", "Plasma"], a: 3 },
                            { q: "Which particle has a negative charge?", options: ["Proton", "Neutron", "Electron", "Photon"], a: 2 },
                            { q: "Melting ice is an example of what kind of change?", options: ["Chemical", "Physical", "Nuclear", "Magnetic"], a: 1 },
                            { q: "The Law of Conservation of Mass states that matter cannot be:", options: ["Heated", "Cooled", "Created or Destroyed", "Moved"], a: 2 },
                            { q: "Which is a chemical property?", options: ["Color", "Density", "Flammability", "Mass"], a: 2 }
                        ]
                    },
                    {
                        id: 'l2',
                        title: 'Lesson 2: Energy Forms & Transformations',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Energy: The Mover & Shaker</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. What is Energy?</h4>
                            <p class="mb-4"><strong>Energy</strong> is defined as the ability to do work or cause change. It makes things move, heat up, or light up. The standard unit of energy is the <strong>Joule (J)</strong>.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Kinetic vs. Potential Energy</h4>
                            <p class="mb-4">Energy exists in two main states:</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Kinetic Energy (KE):</strong> The energy of motion. The faster an object moves or the heavier it is, the more KE it has. (KE = &frac12;mv<sup>2</sup>)</li>
                                <li><strong>Potential Energy (PE):</strong> Stored energy based on position or condition.
                                    <ul class="list-disc ml-4 mt-1">
                                        <li><em>Gravitational PE:</em> Stored by height (e.g., a rock on a cliff). (PE = mgh)</li>
                                        <li><em>Elastic PE:</em> Stored in stretched springs or rubber bands.</li>
                                        <li><em>Chemical PE:</em> Stored in bonds of atoms (e.g., fuel, food).</li>
                                    </ul>
                                </li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Forms of Energy</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm">
                                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                                    <strong>Mechanical:</strong> Sum of PE and KE (moving gears).<br>
                                    <strong>Thermal (Heat):</strong> Vibration of particles.<br>
                                    <strong>Radiant (Light/Solar):</strong> Electromagnetic waves.
                                </div>
                                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                    <strong>Electrical:</strong> Flow of electrons.<br>
                                    <strong>Chemical:</strong> Stored in batteries/food.<br>
                                    <strong>Nuclear:</strong> Stored in atomic nuclei.
                                </div>
                            </div>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Energy Sources</h4>
                            <p class="mb-4">
                                <strong>Renewable:</strong> Naturally replenished (Solar, Wind, Hydro, Geothermal).<br>
                                <strong>Non-Renewable:</strong> Finite supply (Fossil Fuels like Coal, Oil, Natural Gas; Nuclear Uranium).
                            </p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Conservation & Transformation</h4>
                            <p class="mb-4"><strong>Law of Conservation of Energy:</strong> Energy cannot be created or destroyed, only transformed from one form to another.</p>
                            <p class="mb-4"><em>Example:</em> A battery (Chemical) powers a flashlight (Electrical &rarr; Light + Heat).</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">6. Efficiency</h4>
                            <p class="mb-4">No conversion is 100% efficient. Some energy is always "lost" as waste heat (due to friction or resistance). <br><strong>Efficiency</strong> = (Useful Energy Output / Total Energy Input) √ó 100%.</p>
                        `,
                        simType: 'energyLab',
                        quiz: [
                            { q: "Energy stored in a stretched rubber band is:", options: ["Kinetic", "Gravitational Potential", "Elastic Potential", "Thermal"], a: 2 },
                            { q: "Which is a non-renewable energy source?", options: ["Solar", "Wind", "Coal", "Hydro"], a: 2 },
                            { q: "The Law of Conservation of Energy states:", options: ["Energy is created by the sun", "Energy is destroyed by friction", "Energy cannot be created or destroyed", "Energy is infinite"], a: 2 },
                            { q: "A solar panel converts ___ energy into ___ energy.", options: ["Light -> Electrical", "Heat -> Chemical", "Electrical -> Light", "Wind -> Mechanical"], a: 0 },
                            { q: "Kinetic Energy depends on:", options: ["Height and Gravity", "Mass and Velocity", "Heat and Volume", "Charge and Distance"], a: 1 }
                        ]
                    },
                    {
                        id: 'l3',
                        title: 'Lesson 3: Matter, Energy & Gas Laws',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Matter, Energy & Gas Laws</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. How Energy Affects Matter</h4>
                            <p class="mb-4">Energy is the driver of change in matter. Adding energy (heat) increases particle motion (Kinetic Energy), causing phase changes (Solid ‚Üí Liquid ‚Üí Gas) or chemical reactions. Removing energy causes particles to slow down and organize.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Why Freezing Releases Energy</h4>
                            <p class="mb-4">It seems counterintuitive, but <strong>freezing is an exothermic process</strong> (releases heat). When water turns to ice, molecules slow down and form stable hydrogen bonds. This formation releases stored potential energy as heat into the surroundings. This is why farmers sometimes spray water on crops before a freeze; the freezing water releases heat that protects the plants.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Heat Transfer Methods</h4>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Conduction:</strong> Heat transfer through direct contact. Fast-moving particles bump into slower ones (e.g., touching a hot stove).</li>
                                <li><strong>Convection:</strong> Heat transfer by the movement of fluids (liquids or gases). Hot fluid rises (less dense), cold fluid sinks (more dense), creating a cycle (e.g., boiling water).</li>
                                <li><strong>Radiation:</strong> Heat transfer via electromagnetic waves. No medium required (e.g., heat from the Sun).</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Properties of Gases</h4>
                            <p class="mb-4">Gases are described by four variables: <strong>Pressure (P)</strong>, <strong>Volume (V)</strong>, <strong>Temperature (T)</strong>, and Amount (n).</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. The Gas Laws</h4>
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                                <p><strong>Boyle's Law (P‚ÇÅV‚ÇÅ = P‚ÇÇV‚ÇÇ):</strong> Pressure and Volume are <em>inversely</em> related (at constant T). Squeeze a balloon (lower V) -> Pressure goes up.</p>
                                <p class="mt-2"><strong>Charles's Law (V‚ÇÅ/T‚ÇÅ = V‚ÇÇ/T‚ÇÇ):</strong> Volume and Temperature are <em>directly</em> related (at constant P). Heat a balloon -> It expands.</p>
                                <p class="mt-2"><strong>Combined Gas Law (P‚ÇÅV‚ÇÅ/T‚ÇÅ = P‚ÇÇV‚ÇÇ/T‚ÇÇ):</strong> Relates P, V, and T when amount of gas is constant.</p>
                            </div>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">üè† Fun Home Experiments</h4>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <ul class="list-disc ml-6 space-y-2">
                                    <li><strong>The Crushing Can (Charles's Law):</strong> Heat a small amount of water in an empty soda can until steam comes out. Quickly invert it into a bowl of ice water. The steam condenses instantly, creating a vacuum, and atmospheric pressure crushes the can!</li>
                                    <li><strong>Convection Currents:</strong> Place a cup of hot water with red dye into a bowl of cold water. Watch the red water rise and spread.</li>
                                    <li><strong>Balloon in the Freezer:</strong> Blow up a balloon and put it in the freezer. Come back in an hour to see it shrunken (Charles's Law).</li>
                                </ul>
                            </div>
                        `,
                        simType: 'heatGasLab',
                        quiz: [
                            { q: "Freezing water releases heat into the surroundings.", options: ["True", "False"], a: 0 },
                            { q: "Heat transfer through the movement of fluids is called:", options: ["Conduction", "Convection", "Radiation", "Insulation"], a: 1 },
                            { q: "Boyle's Law states that if Volume decreases, Pressure:", options: ["Decreases", "Increases", "Stays the same", "Disappears"], a: 1 },
                            { q: "Which law explains why a balloon shrinks in the cold?", options: ["Boyle's Law", "Charles's Law", "Newton's Law", "Ohm's Law"], a: 1 },
                            { q: "Heat from the sun reaches Earth via:", options: ["Conduction", "Convection", "Radiation", "Wires"], a: 2 }
                        ]
                    },
                    {
                        id: 'l4',
                        title: 'Lesson 4: Atoms, Bonding & Reactions',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Atoms, Bonding & Reactions</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. Atoms & The Periodic Table</h4>
                            <p class="mb-4"><strong>Atoms</strong> are the basic building blocks of matter. They consist of <strong>Protons</strong> (+), <strong>Neutrons</strong> (0), and <strong>Electrons</strong> (-).</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Atomic Number (Z):</strong> The number of protons. This defines the element (e.g., Carbon always has 6 protons).</li>
                                <li><strong>Atomic Mass:</strong> Roughly the sum of protons and neutrons.</li>
                            </ul>
                            <p class="mb-4">The <strong>Periodic Table</strong> organizes elements by increasing atomic number. Vertical columns are <strong>Groups</strong> (elements with similar properties/valence electrons), and horizontal rows are <strong>Periods</strong>.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Electrons & Bonding</h4>
                            <p class="mb-4">Electrons orbit the nucleus in shells. The outermost electrons are called <strong>Valence Electrons</strong>. These determine how an atom bonds.</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Ionic Bonding:</strong> Atoms transfer electrons. One becomes positive (Cation), one negative (Anion). Opposites attract (e.g., NaCl).</li>
                                <li><strong>Covalent Bonding:</strong> Atoms share electrons to fill their outer shells (e.g., H‚ÇÇO, CO‚ÇÇ).</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Chemical Reactions & Equations</h4>
                            <p class="mb-4">A <strong>Chemical Reaction</strong> rearranges atoms to form new substances. We write this as a <strong>Chemical Equation</strong>:</p>
                            <div class="bg-gray-100 p-2 rounded text-center font-mono mb-4">Reactants &rarr; Products</div>
                            <p class="mb-4"><strong>Balancing Equations:</strong> Because mass is conserved, we must have the same number of each type of atom on both sides. We adjust <strong>coefficients</strong> (the big numbers in front) to balance them.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">üè† Home Experiments</h4>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <ul class="list-disc ml-6 space-y-2">
                                    <li><strong>Cabbage Chemistry:</strong> Boil red cabbage to make a pH indicator. Add vinegar (acid) to turn it pink, or baking soda (base) to turn it blue/green. This shows chemical changes!</li>
                                    <li><strong>Rusting Steel Wool:</strong> Wet a piece of steel wool and leave it in a jar. Over days, it reacts with oxygen (oxidation) to form rust (Iron Oxide).</li>
                                    <li><strong>Elephant Toothpaste (Safe Version):</strong> Mix yeast, warm water, dish soap, and hydrogen peroxide. The yeast acts as a catalyst to break down peroxide rapidly, releasing oxygen gas and foam!</li>
                                </ul>
                            </div>
                        `,
                        simType: 'chemistryLab',
                        quiz: [
                            { q: "The atomic number tells you the number of:", options: ["Neutrons", "Electrons", "Protons", "Isotopes"], a: 2 },
                            { q: "Which bond involves sharing electrons?", options: ["Ionic", "Covalent", "Metallic", "James Bond"], a: 1 },
                            { q: "In a chemical equation, the substances on the left are:", options: ["Products", "Reactants", "Catalysts", "Solvents"], a: 1 },
                            { q: "Valence electrons are found in the:", options: ["Nucleus", "Innermost shell", "Outermost shell", "Proton"], a: 2 },
                            { q: "Why do we balance chemical equations?", options: ["To make them look nice", "Conservation of Mass", "To increase energy", "To change the elements"], a: 1 }
                        ]
                    }
                ]
            },
            'electricity': {
                title: "Electricity & Magnetism",
                passwordHash: "109352483",
                lessons: [
                    {
                        id: 'l1',
                        title: 'Lesson 1: Static Electricity',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Understanding Static Electricity</h3>
                            <p class="mb-4"><strong>Static electricity</strong> is an imbalance of electric charges within or on the surface of a material. The charge remains until it is able to move away by means of an electric current or electrical discharge.</p>
                            
                            <h4 class="text-xl font-bold mb-2 text-gray-700">The Atom & Charges</h4>
                            <p class="mb-4">Everything is made of atoms. Atoms contain:</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Protons:</strong> Positive (+) charge, inside the nucleus.</li>
                                <li><strong>Electrons:</strong> Negative (-) charge, orbiting outside the nucleus. Per the quantum model, instead of following a specific circular path, electrons exist in a fuzzy, 3D region of space called a "cloud".</li>
                                <li><strong>Neutrons:</strong> Neutral (0) charge, inside the nucleus.</li>
                            </ul>
                            <p class="mb-4">Usually, atoms have the same number of protons and electrons, making them neutral. However, electrons can be rubbed off one material and onto another.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">Attraction and Repulsion</h4>
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                                <p><strong>The Golden Rule:</strong> Opposites Attract, Likes Repel.</p>
                                <ul class="list-disc ml-6 mt-2">
                                    <li>(+) and (-) pull together.</li>
                                    <li>(+) and (+) push apart.</li>
                                    <li>(-) and (-) push apart.</li>
                                </ul>
                            </div>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">Triboelectric Effect</h4>
                            <p class="mb-4">When you rub a balloon on a sweater, the balloon "steals" electrons from the sweater. The balloon becomes negatively charged (excess electrons), and the sweater becomes positively charged (lost electrons). They will now stick together because opposites attract!</p>
                        `,
                        simType: 'staticElectricity',
                        quiz: [
                            { q: "What charge do electrons have?", options: ["Positive", "Negative", "Neutral", "Variable"], a: 1 },
                            { q: "If an object gains electrons, it becomes:", options: ["Positively charged", "Negatively charged", "Neutral", "Magnetic"], a: 1 },
                            { q: "Two positive charges will:", options: ["Attract", "Repel", "Do nothing", "Spin"], a: 1 },
                            { q: "Static electricity is caused by an imbalance of:", options: ["Heat", "Electric charges", "Air pressure", "Light"], a: 1 },
                            { q: "Rubbing a balloon on a sweater is an example of:", options: ["The Triboelectric Effect", "Magnetism", "Gravity", "Fusion"], a: 0 }
                        ]
                    },
                    {
                        id: 'l2',
                        title: 'Lesson 2: Electric Circuits & Phenomena',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Electric Circuits & Phenomena</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. Conductors & Insulators</h4>
                            <p class="mb-4"><strong>Conductors</strong> (like copper, gold, water) allow electrons to flow easily. <strong>Insulators</strong> (like rubber, glass, plastic) stop the flow of electrons.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Lightning & Electric Potential</h4>
                            <p class="mb-4"><strong>Lightning</strong> is a massive static discharge between clouds and the ground. It happens when the <strong>Electric Potential</strong> (Voltage) difference becomes so great that air (normally an insulator) breaks down and conducts electricity.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Polar Water Molecules</h4>
                            <p class="mb-4">Water (H‚ÇÇO) is a <strong>polar molecule</strong>. It has a positive side (Hydrogen) and a negative side (Oxygen). This allows it to dissolve salts and conduct electricity when ions are present.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Current, Voltage, & Resistance</h4>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Voltage (V):</strong> The "push" or pressure moving electrons (measured in Volts).</li>
                                <li><strong>Current (I):</strong> The flow rate of electrons (measured in Amps).</li>
                                <li><strong>Resistance (R):</strong> How hard it is for current to flow (measured in Ohms).</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Ohm's Law</h4>
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                                <p class="font-bold text-lg text-center">V = I √ó R</p>
                                <p class="text-center text-sm">Voltage = Current √ó Resistance</p>
                            </div>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">6. Circuits: Series vs. Parallel</h4>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Series:</strong> One path. If one bulb breaks, all go out.</li>
                                <li><strong>Parallel:</strong> Multiple paths. If one bulb breaks, others stay on.</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">7. AC vs. DC</h4>
                            <p class="mb-4"><strong>DC (Direct Current):</strong> Electrons flow in one direction (Batteries).<br><strong>AC (Alternating Current):</strong> Electrons switch direction back and forth (Wall outlets). While electrons don't travel long distances, their synchronized back-and-forth movement transfers energy through the circuit, similar to how a wave moves energy in water.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">8. Capacitors</h4>
                            <p class="mb-4">A <strong>Capacitor</strong> stores electrical energy in an electric field, like a temporary battery. It releases energy quickly when needed.</p>
                        `,
                        simType: 'circuitBuilder',
                        quiz: [
                            { q: "Which material is a good conductor?", options: ["Copper", "Rubber", "Glass", "Wood"], a: 0 },
                            { q: "What is the formula for Ohm's Law?", options: ["V=IR", "I=VR", "R=VI", "V=I/R"], a: 0 },
                            { q: "In which circuit type does current have only one path?", options: ["Series", "Parallel", "Open", "Short"], a: 0 },
                            { q: "What does a capacitor do?", options: ["Generates power", "Stores energy", "Resists flow", "Measures voltage"], a: 1 },
                            { q: "Lightning is an example of:", options: ["Static Discharge", "AC Current", "Magnetic Field", "Chemical Reaction"], a: 0 }
                        ]
                    },
                    {
                        id: 'l3',
                        title: 'Lesson 3: Magnetism & Electromagnetism',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Magnetism & Electromagnetism</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. Magnets & Magnetic Fields</h4>
                            <p class="mb-4">A <strong>Magnet</strong> is an object that produces a magnetic field. This invisible field is responsible for the force that pulls on other ferromagnetic materials, such as iron, steel, nickel, and cobalt.</p>
                            <p class="mb-4"><strong>Magnetic Field:</strong> The region around a magnet where the magnetic force is exerted. Field lines exit the North pole and enter the South pole.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Types of Magnets</h4>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Permanent Magnets:</strong> Materials that retain their magnetism for a long time. Examples include Neodymium (strong rare-earth magnets) and Alnico (Aluminum-Nickel-Cobalt).</li>
                                <li><strong>Temporary Magnets:</strong> Materials that act like magnets only while within a strong magnetic field. Soft iron paperclips are a common example; they lose magnetism once removed from the field.</li>
                                <li><strong>Electromagnets:</strong> Magnets created by an electric current flowing through a coil of wire. The magnetism can be turned on and off.</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Diamagnetism</h4>
                            <p class="mb-4"><strong>Diamagnetic</strong> materials are weakly repelled by a magnetic field. Unlike ferromagnetic materials that are attracted, diamagnetic materials (like water, wood, copper, and gold) create an induced magnetic field in opposition to an externally applied magnetic field.</p>

                            
                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Current Creates Magnetism</h4>
                            <p class="mb-4">In 1820, Hans Christian Oersted discovered that <strong>electric current causes a magnetic field</strong>. When electrons flow through a wire, they generate a magnetic field that circles around the wire.</p>
                            <p class="mb-4"><strong>The Connection:</strong>
                                <ul class="list-disc ml-8">
                                    <li><strong>Electric Fields</strong> are created by electric charges (protons/electrons), whether they are moving or sitting still.</li>
                                    <li><strong>Magnetic Fields</strong> are created <em>only</em> when electric charges move (electric current).</li>
                                </ul>
                            </p>
                            <p class="mb-4">This is why electricity and magnetism are two sides of the same coin: <strong>Electromagnetism</strong>.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Electromagnets & Solenoids</h4>
                            <p class="mb-4">A <strong>Solenoid</strong> is a long coil of wire wrapped in many turns. When current flows through it, it creates a nearly uniform magnetic field inside, similar to a bar magnet.</p>
                            <p class="mb-4">An <strong>Electromagnet</strong> is usually a solenoid wrapped around a ferromagnetic core (like an iron nail). The core amplifies the magnetic field significantly.</p>
                        `,
                        simType: 'emFieldLab',
                        quiz: [
                            { q: "Which material is diamagnetic?", options: ["Iron", "Water", "Nickel", "Cobalt"], a: 1 },
                            { q: "A solenoid acts like a ___ when current flows.", options: ["Resistor", "Capacitor", "Bar Magnet", "Switch"], a: 2 },
                            { q: "What creates a magnetic field?", options: ["Stationary charges", "Moving charges (Current)", "Plastic", "Wood"], a: 1 },
                            { q: "Magnetic field lines travel from:", options: ["South to North", "North to South", "East to West", "Inside out"], a: 1 },
                            { q: "An electromagnet requires ___ to work.", options: ["Heat", "Light", "Electric Current", "Sound"], a: 2 }
                        ]
                    },
                    {
                        id: 'l4',
                        title: 'Lesson 4: Electromechanical Systems',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Electromechanical Systems</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. Electricity & Magnetism Relationship</h4>
                            <p class="mb-4">As discovered by Oersted and Faraday, electricity and magnetism are linked. A changing electric field creates a magnetic field, and a changing magnetic field creates an electric field. This principle powers the modern world.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Faraday's Law of Induction</h4>
                            <p class="mb-4"><strong>Faraday's Law</strong> states that moving a magnet near a wire (or changing the magnetic field) induces an electric current in the wire. The faster the change, the more voltage is produced.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Motors & Generators</h4>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Electric Motor:</strong> Converts <em>Electrical Energy</em> into <em>Kinetic Energy</em> (motion). Current flowing through a coil in a magnetic field experiences a force (Lorentz Force) that makes it spin.</li>
                                <li><strong>Generator:</strong> Converts <em>Kinetic Energy</em> into <em>Electrical Energy</em>. Spinning a coil in a magnetic field induces current (Faraday's Law).</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Transformers & Power Transmission</h4>
                            <p class="mb-4">A <strong>Transformer</strong> uses induction to change the voltage of AC electricity. It has two coils (Primary and Secondary) wrapped around an iron core.</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Step-Up:</strong> Increases voltage for efficient long-distance transmission.</li>
                                <li><strong>Step-Down:</strong> Decreases voltage for safe home use.</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Electrical vs. Electronics</h4>
                            <p class="mb-4"><strong>Electrical</strong> devices primarily use electricity for energy (heating, lighting, motors). <strong>Electronics</strong> use electricity to process information (computers, sensors, phones) using components like transistors and microchips.</p>
                        `,
                        simType: 'electromechanicalLab',
                        quiz: [
                            { q: "A generator converts ___ energy into ___ energy.", options: ["Electrical -> Kinetic", "Kinetic -> Electrical", "Thermal -> Kinetic", "Solar -> Wind"], a: 1 },
                            { q: "Which device changes the voltage of AC electricity?", options: ["Motor", "Battery", "Transformer", "Resistor"], a: 2 },
                            { q: "Faraday's Law relates to:", options: ["Static Friction", "Induction of Current", "Ohm's Law", "Gravity"], a: 1 },
                            { q: "Electronics primarily use electricity to:", options: ["Create Heat", "Process Information", "Spin Wheels", "Light Rooms"], a: 1 },
                            { q: "In a motor, current in a magnetic field creates:", options: ["Motion (Torque)", "Cold", "Silence", "Gravity"], a: 0 }
                        ]
                    }
                ]
            },
            'sound': {
                title: "Sound & Light",
                passwordHash: "3610392",
                lessons: [
                    {
                        id: 'l1',
                        title: 'Lesson 1: The Science of Sound',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">The Science of Sound</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. Sound & Vibration</h4>
                            <p class="mb-4"><strong>Sound is vibration.</strong> When an object vibrates (moves back and forth quickly), it pushes against the air molecules around it. These molecules bump into their neighbors, passing the energy along.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. How Sound Travels</h4>
                            <p class="mb-4">Sound needs a <strong>medium</strong> to travel through, such as air, water, or solids. It cannot travel through a vacuum (like space) because there are no particles to carry the vibration.</p>
                            <p class="mb-4">It travels as a <strong>Longitudinal Wave</strong>, consisting of:</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Compressions:</strong> Areas where particles are bunched together (High Pressure).</li>
                                <li><strong>Rarefactions:</strong> Areas where particles are spread apart (Low Pressure).</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Wave Properties</h4>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Wavelength:</strong> The distance between two compressions (or peaks).</li>
                                <li><strong>Frequency:</strong> How many waves pass a point in one second (measured in Hertz, Hz).</li>
                                <li><strong>Amplitude:</strong> The height of the wave (or density of compression), representing energy/loudness.</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Pitch & Loudness</h4>
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                                <p><strong>Pitch</strong> is determined by <strong>Frequency</strong>. High Frequency = High Pitch (squeaky). Low Frequency = Low Pitch (deep).</p>
                                <p class="mt-2"><strong>Loudness</strong> is determined by <strong>Amplitude</strong>. High Amplitude = Loud sound. Low Amplitude = Quiet sound.</p>
                            </div>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Sound Energy</h4>
                            <p class="mb-4">Yes, sound has energy! It is a form of <strong>mechanical energy</strong>. Higher amplitude waves carry more energy. This is why loud sounds can shake windows or even break glass.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">6. How We Hear</h4>
                            <p class="mb-4">Our ears act like funnels catching sound waves. The waves hit the <strong>eardrum</strong>, making it vibrate. These vibrations travel through tiny bones to the cochlea, which converts them into electrical signals for the brain.</p>
                        `,
                        simType: 'soundLab',
                        quiz: [
                            { q: "Sound is produced by:", options: ["Heat", "Vibration", "Light", "Magnetism"], a: 1 },
                            { q: "Sound cannot travel through:", options: ["Water", "Air", "Vacuum (Space)", "Steel"], a: 2 },
                            { q: "Which property determines Pitch?", options: ["Amplitude", "Frequency", "Speed", "Color"], a: 1 },
                            { q: "Which property determines Loudness?", options: ["Amplitude", "Frequency", "Wavelength", "Phase"], a: 0 },
                            { q: "Sound travels as a ___ wave.", options: ["Transverse", "Longitudinal", "Electromagnetic", "Static"], a: 1 }
                        ]
                    },
                    {
                        id: 'l2',
                        title: 'Lesson 2: Advanced Sound Physics',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Advanced Sound Physics</h3>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. Sound vs. Light</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm">
                                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                    <strong class="block text-blue-800 mb-1">Sound Waves</strong>
                                    <ul class="list-disc ml-4 space-y-1">
                                        <li>Mechanical Wave (Needs medium)</li>
                                        <li>Longitudinal (Compression/Rarefaction)</li>
                                        <li>Slow (~343 m/s in air)</li>
                                    </ul>
                                </div>
                                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                                    <strong class="block text-yellow-800 mb-1">Light Waves</strong>
                                    <ul class="list-disc ml-4 space-y-1">
                                        <li>Electromagnetic Wave (No medium)</li>
                                        <li>Transverse (Up/Down)</li>
                                        <li>Fast (~300,000,000 m/s)</li>
                                    </ul>
                                </div>
                            </div>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Speed & Propagation</h4>
                            <p class="mb-4">The speed of sound depends on the <strong>medium</strong> and <strong>temperature</strong>. It travels fastest in solids (molecules are tightly packed), slower in liquids, and slowest in gases.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. The Doppler Effect</h4>
                            <p class="mb-4">The change in frequency of a wave for an observer moving relative to its source. Think of a siren passing by: <strong>High Pitch</strong> as it approaches (waves bunch up), <strong>Low Pitch</strong> as it leaves (waves spread out).</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Interference & Noise Cancellation</h4>
                            <p class="mb-4"><strong>Constructive Interference:</strong> Waves align (peak meets peak) ‚Üí Louder sound.<br><strong>Destructive Interference:</strong> Waves misalign (peak meets trough) ‚Üí Silence. <br><em>Noise-canceling headphones</em> use destructive interference by creating an "anti-noise" wave to cancel out background noise.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Resonance & Sonic Boom</h4>
                            <p class="mb-4"><strong>Resonance:</strong> When an object is forced to vibrate at its natural frequency, amplitude increases dramatically (e.g., shattering glass with voice).<br><strong>Sonic Boom:</strong> When an object travels faster than sound, it breaks the sound barrier, creating a shockwave heard as a loud boom.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">6. Reflection & Echolocation</h4>
                            <p class="mb-4">Sound bounces off surfaces (Echo). Bats and submarines use <strong>Echolocation (Sonar)</strong> to navigate by listening for these reflections.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">7. Types of Sound</h4>
                            <p class="mb-4"><strong>Infrasound:</strong> < 20 Hz (Elephants). <strong>Audible:</strong> 20 Hz - 20 kHz (Humans). <strong>Ultrasound:</strong> > 20 kHz (Bats, Medical imaging).</p>
                        `,
                        simType: 'advancedSoundLab',
                        quiz: [
                            { q: "Sound travels fastest in:", options: ["Gases", "Liquids", "Solids", "Vacuum"], a: 2 },
                            { q: "The Doppler Effect explains a change in:", options: ["Loudness", "Pitch/Frequency", "Speed", "Timbre"], a: 1 },
                            { q: "Noise canceling headphones use:", options: ["Constructive Interference", "Destructive Interference", "Resonance", "Reflection"], a: 1 },
                            { q: "Frequencies above human hearing are called:", options: ["Infrasound", "Supersonic", "Ultrasound", "Hypersonic"], a: 2 },
                            { q: "A Sonic Boom occurs when an object:", options: ["Stops moving", "Travels faster than sound", "Vibrates", "Hits water"], a: 1 }
                        ]
                    },
                    {
                        id: 'l3',
                        title: 'Lesson 3: The Nature of Light',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">The Nature of Light</h3>
                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. What is Light?</h4>
                            <p class="mb-4">Light is a form of energy that travels as an <strong>Electromagnetic Wave</strong>. Unlike sound, it does not need a medium (air, water) to travel; it can move through the vacuum of space.</p>
                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. The Electromagnetic Spectrum</h4>
                            <p class="mb-4">Visible light is just a tiny part of the <strong>Electromagnetic (EM) Spectrum</strong>. The spectrum includes Radio Waves (lowest energy), Microwaves, Infrared, Visible Light, Ultraviolet, X-rays, and Gamma Rays (highest energy).</p>
                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Wave-Particle Duality</h4>
                            <p class="mb-4">Is light a wave or a particle? It's both! Light behaves like a wave (interference, diffraction) but is made of tiny packets of energy called <strong>Photons</strong> (particles). Photons carry energy proportional to their frequency (E=hf).</p>
                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. How Light Travels</h4>
                            <p class="mb-4">Light travels in straight lines (Rectilinear Propagation) until it interacts with an object.</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1"><li><strong>Reflection:</strong> Light bounces off surfaces (e.g., mirrors). Angle of Incidence = Angle of Reflection.</li><li><strong>Refraction:</strong> Light bends when passing from one medium to another (e.g., air to water) because its speed changes.</li><li><strong>Absorption:</strong> Light energy is taken in by the object and converted to heat.</li></ul>
                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Color & Composition</h4>
                            <p class="mb-4"><strong>White Light</strong> is a mixture of all visible colors (ROYGBIV). You can see this when a prism splits white light into a rainbow.</p>
                            <p class="mb-4"><strong>Why are objects colored?</strong> An object's color is determined by the light it <em>reflects</em>. A red apple absorbs all colors except red, which it reflects to your eyes.</p>
                        `,
                        simType: 'lightLab',
                        quiz: [
                            { q: "Light is a form of:", options: ["Mechanical Wave", "Electromagnetic Radiation", "Sound", "Static Electricity"], a: 1 },
                            { q: "Which has the highest energy?", options: ["Radio Waves", "Visible Light", "Gamma Rays", "Microwaves"], a: 2 },
                            { q: "When light bounces off a mirror, it is called:", options: ["Refraction", "Reflection", "Diffraction", "Absorption"], a: 1 },
                            { q: "Why does a leaf look green?", options: ["It absorbs green light", "It reflects green light", "It emits green light", "It is transparent"], a: 1 },
                            { q: "Light consists of particles called:", options: ["Electrons", "Protons", "Photons", "Neutrons"], a: 2 }
                        ]
                    },
                    {
                        id: 'l4',
                        title: 'Lesson 4: Properties of Light & Optics',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Properties of Light & Optics</h3>
                            
                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. Wave Properties of Light</h4>
                            <p class="mb-4">Light behaves as a transverse electromagnetic wave.</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Amplitude:</strong> Determines the <strong>Intensity (Brightness)</strong> of the light. Higher amplitude = Brighter light.</li>
                                <li><strong>Frequency:</strong> Determines the <strong>Color</strong> (Energy). Higher frequency = Blue/Violet (High Energy). Lower frequency = Red (Low Energy).</li>
                                <li><strong>Speed of Light (c):</strong> In a vacuum, light travels at approximately <strong>300,000,000 m/s</strong>. It is the cosmic speed limit.</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Reflection vs. Refraction</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-gray-50 p-3 rounded border"><strong>Reflection</strong><br>Light bounces off a surface. <br><em>Law of Reflection:</em> Angle of Incidence = Angle of Reflection.</div>
                                <div class="bg-blue-50 p-3 rounded border"><strong>Refraction</strong><br>Light bends when passing into a different medium (e.g., Air to Glass) because its speed changes.</div>
                            </div>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. Refractive Index (n)</h4>
                            <p class="mb-4">The <strong>Refractive Index</strong> measures how much a material slows down light. <br>Formula: n = c / v (Speed in vacuum / Speed in medium). <br>Higher n means light travels slower and bends more.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">4. Diffraction</h4>
                            <p class="mb-4"><strong>Diffraction</strong> is the bending of waves around obstacles or through openings. It is most noticeable when the opening size is close to the wavelength of the light. This creates interference patterns (light and dark bands).</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">5. Curved Mirrors</h4>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Concave Mirror (Converging):</strong> Curves inward (like a cave). Can focus light to a point. Can create magnified or inverted images depending on distance. (e.g., Makeup mirrors, Headlights).</li>
                                <li><strong>Convex Mirror (Diverging):</strong> Curves outward. Always creates a smaller, upright, virtual image. Offers a wider field of view. (e.g., Security mirrors, Car side mirrors).</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">üî¨ Experiments to Try at Home</h4>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <ul class="list-disc ml-6 space-y-2">
                                    <li><strong>The Broken Pencil:</strong> Place a pencil in a clear glass of water. Look from the side. The pencil appears broken or shifted due to <strong>Refraction</strong>.</li>
                                    <li><strong>CD Rainbow:</strong> Shine a flashlight on the back of an old CD/DVD. The tiny tracks act as a diffraction grating, splitting light into a rainbow via <strong>Diffraction</strong>.</li>
                                    <li><strong>Spoon Optics:</strong> Look at your reflection in a shiny spoon. The inside (Concave) flips you upside down. The back (Convex) makes you look small and upright.</li>
                                </ul>
                            </div>
                        `,
                        simType: 'opticsLab',
                        quiz: [
                            { q: "Which property of a light wave determines its brightness?", options: ["Frequency", "Wavelength", "Amplitude", "Speed"], a: 2 },
                            { q: "Refractive Index is a measure of:", options: ["How much light bends/slows", "The color of light", "The reflection angle", "Diffraction"], a: 0 },
                            { q: "A Convex mirror always produces an image that is:", options: ["Upside down", "Larger", "Smaller and upright", "Real"], a: 2 },
                            { q: "The bending of light around a corner is called:", options: ["Refraction", "Reflection", "Diffraction", "Dispersion"], a: 2 },
                            { q: "Light travels fastest in:", options: ["Water", "Glass", "Vacuum", "Diamond"], a: 2 }
                        ]
                    }
                ]
            },
            'math': {
                title: "Math & Money",
                passwordHash: "3014482",
                lessons: [
                    {
                        id: 'l1',
                        title: 'Can Math Help You Save Money?',
                        lesson: `
                            <h3 class="text-2xl font-bold mb-4 text-blue-800">Can Math Help You Save Money?</h3>
                            <p class="mb-4">Absolutely! Understanding the math behind money - specifically <strong>percentages</strong> and <strong>interest</strong> - is the key to building wealth and avoiding debt traps.</p>
                            
                            <h4 class="text-xl font-bold mb-2 text-gray-700">1. The Power of Percentages</h4>
                            <p class="mb-4">Percentages are everywhere in finance. A small difference in percentage rates can mean thousands of dollars over time.</p>
                            <ul class="list-disc ml-8 mb-4 space-y-1">
                                <li><strong>Interest Rates:</strong> The cost of borrowing money or the reward for saving it.</li>
                                <li><strong>Inflation:</strong> The rate at which prices rise, reducing your purchasing power (usually ~2-3% per year).</li>
                            </ul>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">2. Simple vs. Compound Interest</h4>
                            <p class="mb-4">This is the most important concept in finance.</p>
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                                <p><strong>Simple Interest:</strong> Calculated only on the principal amount. <br><em>Formula:</em> A = P(1 + rt)</p>
                                <p class="mt-2"><strong>Compound Interest:</strong> Calculated on the principal amount AND the accumulated interest. "Interest on interest." <br><em>Formula:</em> A = P(1 + r/n)<sup>(nt)</sup></p>
                            </div>
                            <p class="mb-4"><strong>For Investments:</strong> Compound interest is your best friend. It allows your money to grow exponentially.</p>
                            <p class="mb-4"><strong>For Loans:</strong> Compound interest is your enemy. Credit cards often compound daily, causing debt to spiral out of control.</p>

                            <h4 class="text-xl font-bold mb-2 text-gray-700">3. The Rule of 72</h4>
                            <p class="mb-4">A quick mental math trick to estimate how long it takes to double your money.</p>
                            <p class="font-mono bg-gray-100 p-2 rounded text-center">Years to Double ‚âà 72 / Interest Rate</p>
                            <p class="mb-4"><em>Example:</em> At 6% interest, your money doubles in 72/6 = 12 years.</p>
                        `,
                        simType: 'financialCalculator',
                        quiz: [
                            { q: "Which type of interest grows faster?", options: ["Simple Interest", "Compound Interest", "Fixed Interest", "Linear Interest"], a: 1 },
                            { q: "The Rule of 72 estimates:", options: ["Inflation rate", "Time to double investment", "Tax percentage", "Loan payments"], a: 1 },
                            { q: "If you have a loan, you want the interest rate to be:", options: ["High", "Low", "Variable", "Negative"], a: 1 },
                            { q: "Simple interest is calculated on:", options: ["Principal only", "Principal + Interest", "Time only", "Rate only"], a: 0 },
                            { q: "At 8% interest, how many years to double your money (Rule of 72)?", options: ["8", "9", "72", "6"], a: 1 }
                        ]
                    }
                ]
            }
        };

        // --- APP STATE & UI LOGIC ---
        const App = {
            state: {
                category: null,
                lessonId: null,
                tab: 'lesson',
                unlocked: [], // Stores IDs of unlocked categories
                pendingCategory: null
            },

            init: function() {
                this.renderNav();
                // Add Enter key support for password modal
                document.getElementById('modal-input').addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') App.submitPassword();
                });
            },

            renderNav: function() {
                const container = document.getElementById('nav-buttons');
                const categories = Object.keys(curriculum);
                container.innerHTML = '';
                
                categories.forEach(catKey => {
                    const cat = curriculum[catKey];
                    const btn = document.createElement('button');
                    const isSelected = this.state.category === catKey;
                    const isUnlocked = this.state.unlocked.includes(catKey);
                    
                    let classes = "px-2 py-2 rounded-lg text-sm font-bold transition-all border-2 ";
                    if (isSelected) {
                        classes += "bg-green-primary text-white border-green-primary shadow-lg";
                    } else {
                        classes += "bg-brand-dark text-gray-300 border-gray-600 hover:border-white hover:text-white";
                    }
                    
                    btn.className = classes;
                    btn.innerHTML = `${isUnlocked ? 'üîì' : 'üîí'} ${cat.title}`;
                    btn.onclick = () => this.selectCategory(catKey);
                    container.appendChild(btn);
                });
            },

            selectCategory: function(catKey) {
                // Check if already unlocked
                if (this.state.unlocked.includes(catKey)) {
                    this.loadCategory(catKey);
                } else {
                    this.state.pendingCategory = catKey;
                    this.showPasswordModal(curriculum[catKey].title);
                }
            },

            loadCategory: function(catKey) {
                this.state.category = catKey;
                this.state.lessonId = null;
                document.getElementById('session-status').textContent = curriculum[catKey].title;
                this.renderNav();
                this.renderLessonList();
                
                // Auto-load first lesson
                this.loadLesson(curriculum[catKey].lessons[0]);
            },

            showPasswordModal: function(title) {
                document.getElementById('modal-title').textContent = `Enter password for ${title}`;
                document.getElementById('modal-input').value = '';
                const modal = document.getElementById('password-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => document.getElementById('modal-input').focus(), 50);
            },

            closeModal: function() {
                const modal = document.getElementById('password-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                this.state.pendingCategory = null;
            },

            cancelPassword: function() {
                this.closeModal();
                this.showAlert("Sign-up for Workshop to Receive Password.", "error");
            },

            simpleHash: function(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = (hash << 5) - hash + char;
                    hash |= 0; // Convert to 32bit integer
                }
                return hash.toString();
            },

            submitPassword: function() {
                const password = document.getElementById('modal-input').value;
                const catKey = this.state.pendingCategory;
                
                if (catKey) {
                    const inputHash = this.simpleHash(password);
                    if (inputHash === curriculum[catKey].passwordHash) {
                        this.state.unlocked.push(catKey);
                        this.closeModal();
                        this.showAlert("Access Granted!", "success");
                        this.loadCategory(catKey);
                    } else {
                        this.showAlert("Incorrect Password.", "error");
                    }
                } else {
                    this.showAlert("Incorrect Password.", "error");
                }
            },

            showAlert: function(msg, type) {
                const modal = document.getElementById('alert-modal');
                const icon = document.getElementById('alert-icon');
                const message = document.getElementById('alert-message');
                
                message.textContent = msg;
                if (type === 'success') {
                    icon.textContent = '‚úÖ';
                    icon.className = 'text-4xl mb-2 text-green-500';
                } else {
                    icon.textContent = '‚ùå';
                    icon.className = 'text-4xl mb-2 text-red-500';
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            },

            renderLessonList: function() {
                const container = document.getElementById('lesson-list');
                container.innerHTML = '';
                
                if (!this.state.category) return;

                const lessons = curriculum[this.state.category].lessons;
                lessons.forEach(l => {
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-lg border cursor-pointer transition hover:shadow-md ${this.state.lessonId === l.id ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'}`;
                    div.innerHTML = `<div class="font-bold text-sm text-gray-800">${l.title}</div>`;
                    div.onclick = () => this.loadLesson(l);
                    container.appendChild(div);
                });
            },

            loadLesson: function(lesson) {
                this.state.lessonId = lesson.id;
                this.renderLessonList(); // Update active styling

                // Hide Welcome, Show Topic
                document.getElementById('welcome-view').classList.add('hidden');
                document.getElementById('topic-view').classList.remove('hidden');

                // Set Header Info
                document.getElementById('crumb-category').textContent = curriculum[this.state.category].title;
                document.getElementById('topic-title').textContent = lesson.title;

                // Inject Content
                document.getElementById('panel-lesson').innerHTML = lesson.lesson;
                
                // Setup Quiz
                this.renderQuiz(lesson.quiz);

                // Setup Simulation
                this.loadSimulation(lesson.simType);

                // Default to Lesson Tab
                this.setTab('lesson');
            },

            setTab: function(tabName) {
                this.state.tab = tabName;
                // Update Tab Buttons
                ['lesson', 'simulation', 'quiz'].forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    const panel = document.getElementById(`panel-${t}`);
                    if (t === tabName) {
                        btn.classList.add('text-green-primary', 'border-green-primary');
                        btn.classList.remove('text-gray-500', 'border-transparent');
                        panel.classList.remove('hidden');
                    } else {
                        btn.classList.remove('text-green-primary', 'border-green-primary');
                        btn.classList.add('text-gray-500', 'border-transparent');
                        panel.classList.add('hidden');
                    }
                });
                
                if (tabName === 'simulation' && Simulations.active === 'staticElectricity') {
                    Simulations.staticElectricity.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'opticsLab') {
                    Simulations.opticsLab.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'matterLab') {
                    Simulations.matterLab.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'energyLab') {
                    Simulations.energyLab.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'heatGasLab') {
                    Simulations.heatGasLab.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'chemistryLab') {
                    Simulations.chemistryLab.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'motionLab') {
                    Simulations.motionLab.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'forcesLab') {
                    Simulations.forcesLab.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'forcesLab') {
                    Simulations.forcesLab.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'newtonLab') {
                    Simulations.newtonLab.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'energyRampLab') {
                    Simulations.energyRampLab.start();
                }
                if (tabName === 'simulation' && Simulations.active === 'financialCalculator') {
                    Simulations.financialCalculator.update();
                }
            },

            renderQuiz: function(questions) {
                const container = document.getElementById('quiz-container');
                const resultDiv = document.getElementById('quiz-results');
                const submitBtn = document.getElementById('btn-submit-quiz');
                
                container.innerHTML = '';
                resultDiv.classList.add('hidden');
                resultDiv.innerHTML = '';
                
                if (!questions || questions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 italic">No quiz available for this lesson.</p>';
                    submitBtn.classList.add('hidden');
                    return;
                }

                submitBtn.classList.remove('hidden');
                questions.forEach((q, idx) => {
                    const qDiv = document.createElement('div');
                    qDiv.className = 'border-b border-gray-100 pb-4';
                    let html = `<p class="font-bold text-gray-800 mb-3">${idx + 1}. ${q.q}</p><div class="space-y-2">`;
                    q.options.forEach((opt, oIdx) => {
                        html += `
                            <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-50">
                                <input type="radio" name="q${idx}" value="${oIdx}" class="form-radio text-green-600 h-4 w-4">
                                <span class="text-gray-700">${opt}</span>
                            </label>
                        `;
                    });
                    html += '</div>';
                    qDiv.innerHTML = html;
                    container.appendChild(qDiv);
                });

                submitBtn.onclick = () => {
                    let score = 0;
                    questions.forEach((q, idx) => {
                        const allOptions = document.querySelectorAll(`input[name="q${idx}"]`);
                        allOptions.forEach(opt => {
                            opt.parentElement.classList.remove('bg-green-100', 'bg-red-100', 'border-green-500', 'border-red-500', 'border');
                        });

                        const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                        const correctInput = document.querySelector(`input[name="q${idx}"][value="${q.a}"]`);
                        
                        if (selected) {
                            if (parseInt(selected.value) === q.a) {
                                score++;
                                selected.parentElement.classList.add('bg-green-100', 'border', 'border-green-500');
                            } else {
                                selected.parentElement.classList.add('bg-red-100', 'border', 'border-red-500');
                                if(correctInput) correctInput.parentElement.classList.add('bg-green-100', 'border', 'border-green-500');
                            }
                        } else if(correctInput) {
                            correctInput.parentElement.classList.add('bg-green-100', 'border', 'border-green-500');
                        }
                    });
                    resultDiv.innerHTML = `<span class="text-2xl font-bold ${score === questions.length ? 'text-green-600' : 'text-orange-500'}">You scored ${score} / ${questions.length}</span>`;
                    resultDiv.classList.remove('hidden');
                };
            },

            loadSimulation: function(type) {
                const host = document.getElementById('sim-host');
                host.innerHTML = ''; 
                Simulations.active = type;

                if (type === 'placeholder') {
                    host.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 py-10"><div class="text-4xl mb-2">üöß</div><p>Interactive simulation coming soon.</p></div>`;
                } else if (Simulations[type]) {
                    Simulations[type].render(host);
                }
            }
        };

        // --- SIMULATION ENGINES ---
        const Simulations = {
            active: null,

            // STATIC ELECTRICITY SIMULATION
            staticElectricity: {
                canvas: null,
                ctx: null,
                animId: null,
                balloon: { x: 250, y: 200, r: 40, charge: 0 },
                sweater: { x: 100, y: 200, w: 150, h: 300, charges: [] },
                wall: { x: 600, y: 200, w: 50, h: 300, charges: [] },
                isDragging: false,

                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Static Electricity Lab</h3>
                            <div class="relative bg-gray-100 border-2 border-gray-300 rounded-lg shadow-inner cursor-crosshair overflow-hidden">
                                <canvas id="se-canvas" width="700" height="400"></canvas>
                                <div class="absolute top-2 left-1/2 -translate-x-1/2 text-xs text-gray-500 bg-white/80 p-2 rounded pointer-events-none">
                                    Drag the balloon.<br>Rub on sweater to gain electrons.<br>Move near wall to see polarization.
                                </div>
                            </div>
                            <div class="flex gap-4 mt-4">
                                <button onclick="Simulations.staticElectricity.reset()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded font-bold text-gray-700">Reset Balloon</button>
                            </div>
                        </div>
                    `;
                    this.init();
                },

                init: function() {
                    this.canvas = document.getElementById('se-canvas');
                    this.ctx = this.canvas.getContext('2d');
                    this.reset();

                    // Event Listeners
                    this.canvas.addEventListener('mousedown', (e) => this.handleDown(e));
                    this.canvas.addEventListener('mousemove', (e) => this.handleMove(e));
                    window.addEventListener('mouseup', () => this.handleUp());
                    
                    this.start();
                },

                reset: function() {
                    this.balloon = { x: 350, y: 200, r: 45, charge: 0, vx: 0, vy: 0 };
                    this.sweater.charges = [];
                    // Populate sweater with +/- pairs
                    const pad = 15;
                    for(let i=0; i<30; i++) {
                        this.sweater.charges.push({
                            x: this.sweater.x - this.sweater.w/2 + pad + Math.random()*(this.sweater.w - pad*2 - 10),
                            y: this.sweater.y - this.sweater.h/2 + pad + Math.random()*(this.sweater.h - pad*2),
                            type: 'pair' // Contains both + and - initially
                        });
                    }
                    this.wall.charges = [];
                    // Populate wall with +/- pairs
                    for(let i=0; i<20; i++) {
                        this.wall.charges.push({
                            x: this.wall.x + 5 + Math.random()*(this.wall.w - 25),
                            y: this.wall.y - this.wall.h/2 + pad + Math.random()*(this.wall.h - pad*2),
                            baseX: 0 // Will be set relative to wall
                        });
                    }
                    this.wall.charges.forEach(c => c.baseX = c.x);
                },

                start: function() {
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                handleDown: function(e) {
                    const rect = this.canvas.getBoundingClientRect();
                    const mx = e.clientX - rect.left;
                    const my = e.clientY - rect.top;
                    const dx = mx - this.balloon.x;
                    const dy = my - this.balloon.y;
                    if (dx*dx + dy*dy < this.balloon.r * this.balloon.r) {
                        this.isDragging = true;
                        this.balloon.vx = 0; this.balloon.vy = 0;
                    }
                },

                handleMove: function(e) {
                    if (!this.isDragging) return;
                    const rect = this.canvas.getBoundingClientRect();
                    this.balloon.x = e.clientX - rect.left;
                    this.balloon.y = e.clientY - rect.top;

                    // Boundary checks
                    this.balloon.x = Math.max(this.balloon.r, Math.min(this.canvas.width - this.balloon.r, this.balloon.x));
                    this.balloon.y = Math.max(this.balloon.r, Math.min(this.canvas.height - this.balloon.r, this.balloon.y));

                    // Rubbing logic
                    this.checkSweaterInteraction();
                },

                handleUp: function() {
                    this.isDragging = false;
                },

                checkSweaterInteraction: function() {
                    // If balloon overlaps sweater charges, pick up electrons
                    this.sweater.charges.forEach(c => {
                        if (c.type === 'pair') {
                            const dx = this.balloon.x - c.x;
                            const dy = this.balloon.y - c.y;
                            if (dx*dx + dy*dy < this.balloon.r * this.balloon.r) {
                                c.type = 'pos'; // Electron left
                                this.balloon.charge++; // Balloon gains electron
                            }
                        }
                    });
                },

                loop: function() {
                    this.updatePhysics();
                    this.draw();
                    this.animId = requestAnimationFrame(() => this.loop());
                },

                updatePhysics: function() {
                    if (this.isDragging) return;

                    // Attraction to Sweater (Positive)
                    if (this.balloon.charge > 0) {
                        const dx = this.sweater.x - this.balloon.x;
                        const dy = this.sweater.y - this.balloon.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist > this.balloon.r + this.sweater.w/2) {
                            this.balloon.vx += (dx / dist) * 0.5;
                            this.balloon.vy += (dy / dist) * 0.5;
                        }
                    }

                    // Attraction to Wall (Induced Polarization)
                    if (this.balloon.charge > 0) {
                        const dx = this.wall.x - this.balloon.x;
                        const dist = Math.abs(dx);
                        if (dist < 150) {
                            this.balloon.vx += 0.8; // Pull towards wall
                        }
                    }

                    // Friction / Damping
                    this.balloon.vx *= 0.92;
                    this.balloon.vy *= 0.92;

                    this.balloon.x += this.balloon.vx;
                    this.balloon.y += this.balloon.vy;

                    // Wall Collision
                    if (this.balloon.x + this.balloon.r > this.wall.x) {
                        this.balloon.x = this.wall.x - this.balloon.r;
                        this.balloon.vx = 0;
                    }
                    // Sweater Collision (Soft)
                    if (this.balloon.x - this.balloon.r < this.sweater.x + this.sweater.w/2) {
                         // Just let it stick
                    }
                },

                draw: function() {
                    const ctx = this.ctx;
                    const w = this.canvas.width;
                    const h = this.canvas.height;

                    ctx.clearRect(0, 0, w, h);

                    // Draw Sweater
                    ctx.fillStyle = '#fca5a5'; // Pink sweater
                    ctx.fillRect(this.sweater.x - this.sweater.w/2, this.sweater.y - this.sweater.h/2, this.sweater.w, this.sweater.h);
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 18px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText("Sweater", this.sweater.x, this.sweater.y + this.sweater.h / 2 + 20);
                    ctx.textAlign = 'start'; // Reset

                    // Draw Sweater Charges
                    this.sweater.charges.forEach(c => {
                        ctx.font = 'bold 18px sans-serif';
                        ctx.fillStyle = '#e11d48';
                        ctx.fillText('+', c.x, c.y);
                        if (c.type === 'pair') {
                            ctx.fillStyle = '#3b82f6';
                            ctx.fillText('-', c.x + 8, c.y);
                            ctx.fillStyle = '#2563eb';
                            ctx.fillText('-', c.x + 10, c.y);
                        }
                    });

                    // Draw Wall
                    ctx.fillStyle = '#fde047'; // Yellow wall
                    ctx.fillRect(this.wall.x, this.wall.y - this.wall.h/2, this.wall.w, this.wall.h);
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 18px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText("Wall", this.wall.x + this.wall.w / 2, this.wall.y + this.wall.h / 2 + 20);
                    ctx.textAlign = 'start'; // Reset

                    // Draw Wall Charges (Polarization)
                    this.wall.charges.forEach(c => {
                        // Calculate repulsion of electrons if balloon is near
                        let offsetX = 0;
                        if (this.balloon.charge > 0) {
                            const dist = Math.abs(this.balloon.x - c.baseX);
                            if (dist < 200) {
                                offsetX = (200 - dist) * 0.2; // Move right
                            }
                        }
                        
                        const maxX = this.wall.x + this.wall.w - 15;
                        let ex = c.baseX + 10 + offsetX;
                        if (ex > maxX) ex = maxX;
                        
                        ctx.font = 'bold 18px sans-serif';
                        ctx.fillStyle = '#e11d48'; ctx.fillText('+', c.baseX, c.y);
                        ctx.fillStyle = '#2563eb'; ctx.fillText('-', ex, c.y);
                    });

                    // Draw Balloon
                    ctx.fillStyle = '#fcd34d'; // Yellow balloon
                    ctx.beginPath();
                    ctx.ellipse(this.balloon.x, this.balloon.y, this.balloon.r, this.balloon.r * 1.1, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();
                    // String
                    ctx.beginPath(); ctx.moveTo(this.balloon.x, this.balloon.y + this.balloon.r * 1.05);
                    ctx.quadraticCurveTo(this.balloon.x + 10, this.balloon.y + 100, this.balloon.x - 5, this.balloon.y + 150);
                    ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.stroke();

                    // Draw Balloon Charges
                    ctx.font = 'bold 18px sans-serif';
                    // Initial pairs
                    ctx.fillStyle = '#e11d48'; ctx.fillText('+', this.balloon.x - 12, this.balloon.y - 10);
                    ctx.fillStyle = '#2563eb'; ctx.fillText('-', this.balloon.x + 5, this.balloon.y - 10);
                    ctx.fillStyle = '#e11d48'; ctx.fillText('+', this.balloon.x - 12, this.balloon.y + 20);
                    ctx.fillStyle = '#2563eb'; ctx.fillText('-', this.balloon.x + 5, this.balloon.y + 20);

                    // Extra electrons
                    for (let i = 0; i < this.balloon.charge; i++) {
                        const angle = i * (Math.PI * 2 / Math.max(1, this.balloon.charge));
                        const r = this.balloon.r - 5;
                        const ex = this.balloon.x + Math.cos(angle) * r;
                        const ey = this.balloon.y + Math.sin(angle) * r;
                        ctx.fillStyle = '#2563eb'; ctx.fillText('-', ex, ey);
                    }
                }
            },

            // CIRCUIT BUILDER SIMULATION
            circuitBuilder: {
                mode: 'simple', // simple, series, parallel, acdc
                switchClosed: false,
                acMode: false, // false = DC, true = AC
                animId: null,
                
                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Circuit Lab Explorer</h3>
                            
                            <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.circuitBuilder.setMode('simple')" id="cb-btn-simple" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Simple</button>
                                <button onclick="Simulations.circuitBuilder.setMode('series')" id="cb-btn-series" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Series</button>
                                <button onclick="Simulations.circuitBuilder.setMode('parallel')" id="cb-btn-parallel" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Parallel</button>
                                <button onclick="Simulations.circuitBuilder.setMode('acdc')" id="cb-btn-acdc" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">AC vs DC</button>
                            </div>

                            <div class="relative w-full max-w-lg h-64 bg-gray-50 border-2 border-gray-400 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="cb-canvas" width="500" height="250"></canvas>
                                <div id="cb-controls" class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-4"></div>
                            </div>
                            
                            <div id="cb-desc" class="mt-4 text-sm text-gray-600 font-medium text-center h-10 max-w-md"></div>
                        </div>
                    `;
                    this.setMode('simple');
                },

                setMode: function(m) {
                    this.mode = m;
                    this.switchClosed = false;
                    this.acMode = false;
                    
                    // Update buttons
                    ['simple', 'series', 'parallel', 'acdc'].forEach(k => {
                        const btn = document.getElementById(`cb-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });

                    // Update controls
                    const controls = document.getElementById('cb-controls');
                    if (m === 'acdc') {
                        controls.innerHTML = `
                            <button onclick="Simulations.circuitBuilder.toggleACDC()" id="cb-acdc-toggle" class="px-4 py-2 bg-blue-600 text-white font-bold rounded shadow hover:bg-blue-700">Switch to AC</button>
                        `;
                        document.getElementById('cb-desc').textContent = "Direct Current (DC) flows one way. Alternating Current (AC) switches direction.";
                    } else {
                        controls.innerHTML = `
                            <button onclick="Simulations.circuitBuilder.toggleSwitch()" id="cb-switch-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-bold rounded shadow hover:bg-gray-300 border border-gray-400">Close Switch</button>
                        `;
                        if (m === 'simple') document.getElementById('cb-desc').textContent = "A simple circuit has a single path for electrons to flow.";
                        if (m === 'series') document.getElementById('cb-desc').textContent = "In Series, components are lined up. If one breaks, the circuit opens.";
                        if (m === 'parallel') document.getElementById('cb-desc').textContent = "In Parallel, components have separate branches. Current splits.";
                    }

                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.animate();
                },

                toggleSwitch: function() {
                    this.switchClosed = !this.switchClosed;
                    const btn = document.getElementById('cb-switch-btn');
                    if(this.switchClosed) {
                        btn.textContent = "Open Switch";
                        btn.className = "px-4 py-2 bg-green-600 text-white font-bold rounded shadow hover:bg-green-700 border border-green-800";
                    } else {
                        btn.textContent = "Close Switch";
                        btn.className = "px-4 py-2 bg-gray-200 text-gray-800 font-bold rounded shadow hover:bg-gray-300 border border-gray-400";
                    }
                },

                toggleACDC: function() {
                    this.acMode = !this.acMode;
                    const btn = document.getElementById('cb-acdc-toggle');
                    if(this.acMode) {
                        btn.textContent = "Switch to DC";
                        btn.className = "px-4 py-2 bg-purple-600 text-white font-bold rounded shadow hover:bg-purple-700";
                    } else {
                        btn.textContent = "Switch to AC";
                        btn.className = "px-4 py-2 bg-blue-600 text-white font-bold rounded shadow hover:bg-blue-700";
                    }
                },

                animate: function() {
                    const canvas = document.getElementById('cb-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    const time = Date.now() / 1000;

                    ctx.clearRect(0,0,w,h);
                    ctx.lineWidth = 4;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';

                    const drawBattery = (x, y, vertical=true) => {
                        ctx.strokeStyle = '#374151';
                        if(vertical) {
                            ctx.beginPath(); ctx.moveTo(x-10, y-10); ctx.lineTo(x+10, y-10); ctx.stroke(); // Long (Pos)
                            ctx.beginPath(); ctx.moveTo(x-5, y+10); ctx.lineTo(x+5, y+10); ctx.stroke(); // Short (Neg)
                            ctx.font = "12px Arial"; ctx.fillStyle = "#374151"; ctx.fillText("+", x+15, y-5);
                        }
                    };

                    const drawACSource = (x, y) => {
                        ctx.strokeStyle = '#374151';
                        ctx.beginPath(); ctx.arc(x, y, 15, 0, Math.PI*2); ctx.stroke();
                        ctx.font = "16px Arial"; ctx.fillStyle = "#374151"; ctx.fillText("~", x-5, y+5);
                    };

                    const drawBulb = (x, y, on) => {
                        ctx.strokeStyle = '#374151';
                        ctx.fillStyle = on ? '#fef08a' : '#e5e7eb';
                        ctx.beginPath(); ctx.arc(x, y, 15, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                        // Filament
                        ctx.beginPath(); ctx.moveTo(x-8, y+8); ctx.lineTo(x-3, y); ctx.lineTo(x+3, y); ctx.lineTo(x+8, y+8); ctx.stroke();
                        if(on) {
                            ctx.shadowBlur = 20; ctx.shadowColor = '#facc15';
                            ctx.fillStyle = 'rgba(253, 224, 71, 0.5)'; ctx.fill();
                            ctx.shadowBlur = 0;
                        }
                    };

                    const drawSwitch = (x, y, closed) => {
                        ctx.strokeStyle = '#374151';
                        ctx.beginPath(); ctx.arc(x-15, y, 3, 0, Math.PI*2); ctx.fill();
                        ctx.beginPath(); ctx.arc(x+15, y, 3, 0, Math.PI*2); ctx.fill();
                        ctx.beginPath(); ctx.moveTo(x-15, y); 
                        if(closed) ctx.lineTo(x+15, y);
                        else ctx.lineTo(x+12, y-15);
                        ctx.stroke();
                    };

                    const drawElectron = (x, y) => {
                        ctx.fillStyle = '#3b82f6';
                        ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
                    };

                    // Circuit Paths
                    ctx.strokeStyle = '#9ca3af'; // Wire color
                    
                    let path = [];
                    let bulbs = [];
                    let sourcePos = {x: 50, y: h/2};
                    let switchPos = {x: w/2, y: 30};

                    if (this.mode === 'simple') {
                        // Rectangular loop
                        ctx.beginPath();
                        ctx.moveTo(50, 30); ctx.lineTo(450, 30); // Top
                        ctx.lineTo(450, 220); // Right
                        ctx.lineTo(50, 220); // Bottom
                        ctx.lineTo(50, 30); // Left
                        ctx.stroke();
                        
                        drawBattery(50, h/2);
                        drawSwitch(w/2, 30, this.switchClosed);
                        drawBulb(450, h/2, this.switchClosed);
                        
                        if(this.switchClosed) {
                            // Animate electrons
                            const speed = 100;
                            const perimeter = (400 + 190) * 2;
                            const count = 20;
                            for(let i=0; i<count; i++) {
                                let dist = (time * speed + i * (perimeter/count)) % perimeter;
                                let ex, ey;
                                if(dist < 400) { ex = 50 + dist; ey = 30; }
                                else if(dist < 400 + 190) { ex = 450; ey = 30 + (dist - 400); }
                                else if(dist < 800 + 190) { ex = 450 - (dist - 590); ey = 220; }
                                else { ex = 50; ey = 220 - (dist - 990); }
                                drawElectron(ex, ey);
                            }
                        }
                    } else if (this.mode === 'series') {
                        ctx.beginPath();
                        ctx.moveTo(50, 30); ctx.lineTo(450, 30);
                        ctx.lineTo(450, 220);
                        ctx.lineTo(50, 220);
                        ctx.lineTo(50, 30);
                        ctx.stroke();

                        drawBattery(50, h/2);
                        drawSwitch(w/2, 30, this.switchClosed);
                        drawBulb(450, h/3 + 20, this.switchClosed);
                        drawBulb(450, h*2/3 - 20, this.switchClosed);

                        if(this.switchClosed) {
                            const speed = 100;
                            const perimeter = (400 + 190) * 2;
                            const count = 20;
                            for(let i=0; i<count; i++) {
                                let dist = (time * speed + i * (perimeter/count)) % perimeter;
                                let ex, ey;
                                if(dist < 400) { ex = 50 + dist; ey = 30; }
                                else if(dist < 400 + 190) { ex = 450; ey = 30 + (dist - 400); }
                                else if(dist < 800 + 190) { ex = 450 - (dist - 590); ey = 220; }
                                else { ex = 50; ey = 220 - (dist - 990); }
                                drawElectron(ex, ey);
                            }
                        }
                    } else if (this.mode === 'parallel') {
                        // Main loop
                        ctx.beginPath();
                        ctx.moveTo(50, 30); ctx.lineTo(350, 30); // Top main
                        ctx.moveTo(350, 220); ctx.lineTo(50, 220); // Bottom main
                        ctx.lineTo(50, 30); // Left source
                        ctx.stroke();

                        // Branch 1
                        ctx.beginPath(); ctx.moveTo(350, 30); ctx.lineTo(350, 220); ctx.stroke();
                        // Branch 2
                        ctx.beginPath(); ctx.moveTo(450, 30); ctx.lineTo(450, 220); ctx.stroke();
                        // Connect branches top/bottom
                        ctx.beginPath(); ctx.moveTo(350, 30); ctx.lineTo(450, 30); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(350, 220); ctx.lineTo(450, 220); ctx.stroke();

                        drawBattery(50, h/2);
                        drawSwitch(200, 30, this.switchClosed);
                        drawBulb(350, h/2, this.switchClosed);
                        drawBulb(450, h/2, this.switchClosed);

                        if(this.switchClosed) {
                            const speed = 100;
                            // Main loop electrons
                            for(let i=0; i<10; i++) {
                                let dist = (time * speed + i * 40) % 300;
                                drawElectron(50 + dist, 30); // Top
                                drawElectron(350 - dist, 220); // Bottom
                            }
                            // Source vertical
                            for(let i=0; i<6; i++) {
                                let dist = (time * speed + i * 40) % 190;
                                drawElectron(50, 220 - dist);
                            }
                            // Branch 1
                            for(let i=0; i<6; i++) {
                                let dist = (time * speed + i * 40) % 190;
                                drawElectron(350, 30 + dist);
                            }
                            // Branch 2
                            for(let i=0; i<6; i++) {
                                let dist = (time * speed + i * 40) % 190;
                                drawElectron(450, 30 + dist);
                            }
                        }
                    } else if (this.mode === 'acdc') {
                        ctx.beginPath();
                        ctx.moveTo(50, 30); ctx.lineTo(450, 30);
                        ctx.lineTo(450, 220);
                        ctx.lineTo(50, 220);
                        ctx.lineTo(50, 30);
                        ctx.stroke();

                        if(this.acMode) drawACSource(50, h/2);
                        else drawBattery(50, h/2);
                        
                        drawBulb(450, h/2, true); // Always on in this demo mode

                        const perimeter = (400 + 190) * 2;
                        const count = 20;
                        for(let i=0; i<count; i++) {
                            let dist;
                            if (this.acMode) {
                                // Oscillate
                                let offset = Math.sin(time * 5) * 50;
                                dist = (i * (perimeter/count) + offset + perimeter) % perimeter;
                            } else {
                                // Flow
                                dist = (time * 100 + i * (perimeter/count)) % perimeter;
                            }

                            let ex, ey;
                            if(dist < 400) { ex = 50 + dist; ey = 30; }
                            else if(dist < 400 + 190) { ex = 450; ey = 30 + (dist - 400); }
                            else if(dist < 800 + 190) { ex = 450 - (dist - 590); ey = 220; }
                            else { ex = 50; ey = 220 - (dist - 990); }
                            drawElectron(ex, ey);
                        }
                    }

                    this.animId = requestAnimationFrame(() => this.animate());
                }
            }
            ,

            // EM FIELD LAB SIMULATION
            emFieldLab: {
                current: 0,
                animId: null,
                electrons: [],
                
                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full justify-center select-none">
                            <h3 class="font-bold text-lg mb-4 text-gray-700">Electromagnetism Explorer</h3>
                            <div class="relative w-full max-w-lg h-64 bg-gray-900 rounded-lg border-2 border-gray-700 shadow-inner overflow-hidden">
                                <canvas id="em-canvas" width="500" height="250"></canvas>
                                <div class="absolute top-2 left-2 text-xs text-gray-400">
                                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-400"></div> Electron</div>
                                    <div class="flex items-center gap-2"><div class="w-8 h-1 bg-green-500"></div> B-Field</div>
                                    <div class="flex items-center gap-2"><div class="w-8 h-1 bg-yellow-500"></div> E-Field (Force)</div>
                                </div>
                            </div>
                            
                            <div class="w-full max-w-md mt-6 bg-gray-100 p-4 rounded-lg border border-gray-300">
                                <div class="flex justify-between mb-2 font-bold text-sm text-gray-700">
                                    <span>Current (I)</span>
                                    <span id="em-current-val">0 A</span>
                                </div>
                                <input type="range" id="em-slider" min="-10" max="10" value="0" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="Simulations.emFieldLab.update()">
                                <div class="text-center mt-2 text-xs text-gray-500">
                                    Move slider to flow electrons.
                                </div>
                            </div>
                            <div class="mt-4 text-sm text-gray-600 max-w-lg bg-blue-50 p-3 rounded border border-blue-200 text-center">
                                <p class="mb-2"><strong>Current & Fields:</strong> Increasing current (I) strengthens the Magnetic Field (B-Field). Reversing current reverses the field direction.</p>
                                <p><strong>B-Field (Green):</strong> The magnetic field circles around the wire. <br>‚äô = Field coming OUT of screen. <br>√ó = Field going INTO screen.</p>
                            </div>
                        </div>
                    `;
                    this.current = 0;
                    this.electrons = [];
                    for(let i=0; i<20; i++) this.electrons.push({x: Math.random()*500, y: 125 + (Math.random()-0.5)*10});
                    this.start();
                },
                
                update: function() {
                    this.current = parseInt(document.getElementById('em-slider').value);
                    document.getElementById('em-current-val').textContent = this.current + " A";
                },

                start: function() {
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                loop: function() {
                    const canvas = document.getElementById('em-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width;
                    const h = canvas.height;

                    ctx.clearRect(0, 0, w, h);

                    // Draw Wire
                    ctx.fillStyle = '#4b5563';
                    ctx.fillRect(0, h/2 - 15, w, 30);
                    
                    // Draw E-Field (Driving Force) inside wire
                    if (this.current !== 0) {
                        ctx.strokeStyle = '#eab308'; // Yellow
                        ctx.lineWidth = 2;
                        const arrowSize = 5;
                        const dir = this.current > 0 ? 1 : -1;
                        
                        for(let x=20; x<w; x+=60) {
                            const y = h/2;
                            ctx.beginPath();
                            ctx.moveTo(x, y);
                            ctx.lineTo(x + 30 * dir, y);
                            ctx.stroke();
                            // Arrowhead
                            ctx.beginPath();
                            ctx.moveTo(x + 30 * dir, y);
                            ctx.lineTo(x + 30 * dir - arrowSize * dir, y - arrowSize);
                            ctx.lineTo(x + 30 * dir - arrowSize * dir, y + arrowSize);
                            ctx.fill();
                        }
                    }

                    // Draw Electrons
                    ctx.fillStyle = '#60a5fa'; // Blue
                    const speed = this.current * -0.5; // Electrons move opposite to current
                    this.electrons.forEach(e => {
                        e.x += speed;
                        if(e.x > w) e.x = 0;
                        if(e.x < 0) e.x = w;
                        ctx.beginPath();
                        ctx.arc(e.x, e.y, 4, 0, Math.PI*2);
                        ctx.fill();
                    });

                    // Draw Magnetic Field (B-Field) Rings
                    if (this.current !== 0) {
                        ctx.lineWidth = Math.abs(this.current) / 3;
                        ctx.strokeStyle = '#22c55e'; // Green
                        const intensity = Math.abs(this.current);
                        
                        for(let x=50; x<w; x+=100) {
                            ctx.beginPath();
                            ctx.ellipse(x, h/2, 20, 60, 0, 0, Math.PI*2);
                            ctx.stroke();
                        }
                        
                        // Draw Field Indicators (X and Dots)
                        ctx.font = "20px Arial";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        const symbolTop = this.current > 0 ? "‚äô" : "√ó";
                        const symbolBot = this.current > 0 ? "√ó" : "‚äô";
                        
                        for(let x=50; x<w; x+=50) {
                            ctx.fillStyle = `rgba(34, 197, 94, ${intensity/10})`;
                            ctx.fillText(symbolTop, x, h/2 - 50);
                            ctx.fillText(symbolBot, x, h/2 + 50);
                        }
                    }

                    this.animId = requestAnimationFrame(() => this.loop());
                }
            }
            ,

            // ELECTROMECHANICAL LAB SIMULATION
            electromechanicalLab: {
                mode: 'motor', // motor, generator, transformer
                animId: null,
                angle: 0,
                speed: 0,
                
                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Electromechanical Systems</h3>
                            
                            <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.electromechanicalLab.setMode('motor')" id="eml-btn-motor" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Electric Motor</button>
                                <button onclick="Simulations.electromechanicalLab.setMode('generator')" id="eml-btn-generator" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Generator</button>
                                <button onclick="Simulations.electromechanicalLab.setMode('transformer')" id="eml-btn-transformer" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Transformer</button>
                            </div>

                            <div class="relative w-full max-w-lg h-64 bg-gray-50 border-2 border-gray-400 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="eml-canvas" width="500" height="250"></canvas>
                                <div id="eml-overlay" class="absolute inset-0 pointer-events-none"></div>
                            </div>
                            
                            <div id="eml-controls" class="mt-4 w-full max-w-md flex flex-col items-center gap-2"></div>
                            <div id="eml-desc" class="mt-2 text-sm text-gray-600 font-medium text-center h-12 max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.setMode('motor');
                },

                setMode: function(m) {
                    this.mode = m;
                    this.angle = 0;
                    this.speed = 0;
                    
                    ['motor', 'generator', 'transformer'].forEach(k => {
                        const btn = document.getElementById(`eml-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });

                    const controls = document.getElementById('eml-controls');
                    const desc = document.getElementById('eml-desc');

                    if (m === 'motor') {
                        controls.innerHTML = `<div class="flex items-center gap-4"><label class="font-bold text-sm">Battery Voltage:</label><input type="range" id="eml-slider" min="0" max="10" value="0" class="accent-blue-600" oninput="Simulations.electromechanicalLab.update()"></div>`;
                        desc.textContent = "Motor: Electrical Energy (Battery) ‚Üí Kinetic Energy (Spinning). Current in a magnetic field creates torque (Lorentz Force).";
                    } else if (m === 'generator') {
                        controls.innerHTML = `<div class="flex items-center gap-4"><label class="font-bold text-sm">Crank Speed:</label><input type="range" id="eml-slider" min="0" max="10" value="0" class="accent-green-600" oninput="Simulations.electromechanicalLab.update()"></div>`;
                        desc.textContent = "Generator: Kinetic Energy (Spinning) ‚Üí Electrical Energy (Light). Moving a coil in a magnetic field induces current (Faraday's Law).";
                    } else {
                        controls.innerHTML = `<div class="flex items-center gap-4"><label class="font-bold text-sm">Secondary Turns:</label><input type="range" id="eml-slider" min="1" max="5" value="2" class="accent-purple-600" oninput="Simulations.electromechanicalLab.update()"><span id="eml-val">2x</span></div>`;
                        desc.textContent = "Transformer: AC Electricity ‚Üí Magnetic Field ‚Üí AC Electricity. Changes voltage based on turns ratio (Step-up/Step-down).";
                    }

                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                update: function() {
                    const slider = document.getElementById('eml-slider');
                    if (this.mode === 'transformer') {
                        document.getElementById('eml-val').textContent = slider.value + "x";
                    }
                },

                loop: function() {
                    const canvas = document.getElementById('eml-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    const cx = w/2; const cy = h/2;
                    const slider = document.getElementById('eml-slider');
                    const val = slider ? parseFloat(slider.value) : 0;

                    ctx.clearRect(0,0,w,h);

                    if (this.mode === 'motor' || this.mode === 'generator') {
                        ctx.fillStyle = '#ef4444'; ctx.fillRect(cx - 150, cy - 60, 40, 120); ctx.fillStyle = '#fff'; ctx.font = "bold 20px Arial"; ctx.fillText("N", cx - 135, cy + 7);
                        ctx.fillStyle = '#3b82f6'; ctx.fillRect(cx + 110, cy - 60, 40, 120); ctx.fillStyle = '#fff'; ctx.fillText("S", cx + 125, cy + 7);
                        ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.lineWidth = 1; for(let i=-40; i<=40; i+=10) { ctx.beginPath(); ctx.moveTo(cx-110, cy+i); ctx.lineTo(cx+110, cy+i); ctx.stroke(); }
                        if (this.mode === 'motor') this.speed = val * 2; else this.speed = val * 2;
                        this.angle += this.speed * 0.05;
                        ctx.save(); ctx.translate(cx, cy); ctx.rotate(this.angle); ctx.strokeStyle = '#d97706'; ctx.lineWidth = 4; ctx.strokeRect(-60, -30, 120, 60); ctx.fillStyle = '#b45309'; ctx.beginPath(); ctx.arc(60, 0, 10, 0, Math.PI*2); ctx.fill(); ctx.restore();
                        ctx.strokeStyle = '#374151'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(cx+60, cy); ctx.lineTo(cx+60, cy+100); ctx.lineTo(cx-60, cy+100); ctx.lineTo(cx-60, cy); ctx.stroke();
                        if (this.mode === 'motor') {
                            ctx.fillStyle = '#fff'; ctx.fillRect(cx-20, cy+90, 40, 20); ctx.strokeRect(cx-20, cy+90, 40, 20); ctx.fillStyle = '#000'; ctx.fillText(val > 0 ? "‚ö°" : "", cx-8, cy+107);
                            if(val > 0) { ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.arc(cx, cy+100, 4, 0, Math.PI*2); ctx.fill(); }
                        } else {
                            ctx.fillStyle = val > 0 ? `rgba(253, 224, 71, ${val/10})` : '#e5e7eb'; ctx.beginPath(); ctx.arc(cx, cy+100, 15, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                            if(val > 0) { ctx.shadowBlur = val * 2; ctx.shadowColor = '#facc15'; ctx.fillStyle = '#facc15'; ctx.fill(); ctx.shadowBlur = 0; }
                        }
                    } else if (this.mode === 'transformer') {
                        ctx.fillStyle = '#9ca3af'; ctx.fillRect(cx-80, cy-80, 160, 160); ctx.clearRect(cx-50, cy-50, 100, 100); ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 2; ctx.strokeRect(cx-80, cy-80, 160, 160); ctx.strokeRect(cx-50, cy-50, 100, 100);
                        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3; const pTurns = 5; for(let i=0; i<pTurns; i++) { const y = cy - 60 + (i * 25); ctx.beginPath(); ctx.moveTo(cx-90, y); ctx.lineTo(cx-50, y+10); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx-90, y+10); ctx.lineTo(cx-50, y+20); ctx.stroke(); }
                        const time = Date.now() / 500; const inputV = Math.sin(time) * 20; ctx.fillStyle = '#ef4444'; ctx.font = "14px Arial"; ctx.fillText("Input AC", cx-140, cy); ctx.fillRect(cx-140, cy+10, 40, inputV);
                        ctx.strokeStyle = '#3b82f6'; const sTurns = val * 2; const step = 120 / sTurns; for(let i=0; i<sTurns; i++) { const y = cy - 60 + (i * step); ctx.beginPath(); ctx.moveTo(cx+50, y); ctx.lineTo(cx+90, y+step/2); ctx.stroke(); }
                        const outputV = inputV * (sTurns / pTurns); ctx.fillStyle = '#3b82f6'; ctx.fillText("Output AC", cx+100, cy); ctx.fillRect(cx+100, cy+10, 40, outputV);
                        ctx.strokeStyle = `rgba(255, 255, 0, ${Math.abs(Math.sin(time)) * 0.5})`; ctx.lineWidth = 5; ctx.strokeRect(cx-65, cy-65, 130, 130);
                    }
                    this.animId = requestAnimationFrame(() => this.loop());
                }
            }
            ,

            // SOUND LAB SIMULATION
            soundLab: {
                mode: 'propagation', // propagation, waveform
                animId: null,
                freq: 2,
                amp: 50,
                particles: [],

                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Sound Wave Laboratory</h3>
                            
                            <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.soundLab.setMode('propagation')" id="sl-btn-prop" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Particle Propagation</button>
                                <button onclick="Simulations.soundLab.setMode('waveform')" id="sl-btn-wave" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Wave Properties</button>
                            </div>

                            <div class="relative w-full max-w-lg h-64 bg-gray-900 border-2 border-gray-700 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="sl-canvas" width="500" height="250"></canvas>
                                <div id="sl-overlay" class="absolute top-2 left-2 text-xs text-gray-400 pointer-events-none"></div>
                            </div>
                            
                            <div class="w-full max-w-md mt-6 bg-gray-100 p-4 rounded-lg border border-gray-300">
                                <div class="flex flex-col gap-4">
                                    <div>
                                        <div class="flex justify-between mb-1 font-bold text-sm text-gray-700">
                                            <span>Frequency (Pitch)</span>
                                            <span id="sl-freq-val">Low</span>
                                        </div>
                                        <input type="range" id="sl-slider-freq" min="1" max="10" value="2" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="Simulations.soundLab.update()">
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1 font-bold text-sm text-gray-700">
                                            <span>Amplitude (Loudness)</span>
                                            <span id="sl-amp-val">Medium</span>
                                        </div>
                                        <input type="range" id="sl-slider-amp" min="10" max="100" value="50" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-green-600" oninput="Simulations.soundLab.update()">
                                    </div>
                                </div>
                            </div>
                            <div id="sl-desc" class="mt-4 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.initParticles();
                    this.setMode('propagation');
                },

                initParticles: function() {
                    this.particles = [];
                    for(let x=0; x<500; x+=10) {
                        for(let y=20; y<230; y+=20) {
                            this.particles.push({baseX: x, y: y, x: x});
                        }
                    }
                },

                setMode: function(m) {
                    this.mode = m;
                    ['prop', 'wave'].forEach(k => {
                        const btn = document.getElementById(`sl-btn-${k}`);
                        if((k === 'prop' && m === 'propagation') || (k === 'wave' && m === 'waveform')) {
                            btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        } else {
                            btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                        }
                    });

                    const desc = document.getElementById('sl-desc');
                    const overlay = document.getElementById('sl-overlay');
                    if (m === 'propagation') {
                        desc.textContent = "Visualizing Sound as a Longitudinal Wave. Particles vibrate back and forth, creating compressions and rarefactions.";
                        overlay.innerHTML = "Dots = Air Molecules";
                    } else {
                        desc.textContent = "Visualizing Sound as a Transverse Waveform. This graph represents pressure over time/distance.";
                        overlay.innerHTML = "Line = Pressure Level";
                    }

                    this.update();
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                update: function() {
                    this.freq = parseInt(document.getElementById('sl-slider-freq').value);
                    this.amp = parseInt(document.getElementById('sl-slider-amp').value);
                    document.getElementById('sl-freq-val').textContent = this.freq < 4 ? "Low" : (this.freq > 7 ? "High" : "Medium");
                    document.getElementById('sl-amp-val').textContent = this.amp < 40 ? "Quiet" : (this.amp > 70 ? "Loud" : "Medium");
                },

                loop: function() {
                    const canvas = document.getElementById('sl-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    const time = Date.now() / 1000;

                    ctx.clearRect(0,0,w,h);

                    if (this.mode === 'propagation') {
                        ctx.fillStyle = '#60a5fa';
                        const coneX = 20 + Math.sin(time * this.freq * 2) * (this.amp / 5);
                        ctx.fillStyle = '#374151';
                        ctx.beginPath(); ctx.moveTo(0, 50); ctx.lineTo(coneX, 80); ctx.lineTo(coneX, 170); ctx.lineTo(0, 200); ctx.fill();

                        ctx.fillStyle = '#60a5fa';
                        this.particles.forEach(p => {
                            const phase = p.baseX * 0.05; 
                            const displacement = Math.sin(time * this.freq * 2 - phase) * (this.amp / 3);
                            let effectiveDisp = displacement;
                            if (p.baseX < 50) effectiveDisp *= (p.baseX / 50);
                            p.x = p.baseX + effectiveDisp;
                            ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                        });
                    } else {
                        ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 3; ctx.beginPath();
                        for(let x=0; x<w; x++) {
                            const phase = x * 0.02 * this.freq;
                            const y = h/2 + Math.sin(time * this.freq * 2 - phase) * this.amp;
                            if(x===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                        }
                        ctx.stroke();
                        ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
                        ctx.fillStyle = '#fff'; ctx.font = "12px Arial";
                        ctx.fillText("Amplitude: " + this.amp, 10, 20); ctx.fillText("Frequency: " + this.freq + " Hz (simulated)", 10, 40);
                    }
                    this.animId = requestAnimationFrame(() => this.loop());
                }
            },

            // ADVANCED SOUND LAB SIMULATION
            advancedSoundLab: {
                mode: 'doppler', // doppler, interference, reflection
                animId: null,
                sourceX: 0,
                waves: [],
                lastEmit: 0,
                pulse: null,
                
                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Advanced Wave Physics</h3>
                            
                            <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.advancedSoundLab.setMode('doppler')" id="asl-btn-doppler" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Doppler Effect</button>
                                <button onclick="Simulations.advancedSoundLab.setMode('interference')" id="asl-btn-interference" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Interference</button>
                                <button onclick="Simulations.advancedSoundLab.setMode('reflection')" id="asl-btn-reflection" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Reflection (Sonar)</button>
                            </div>

                            <div class="relative w-full max-w-lg h-64 bg-gray-900 border-2 border-gray-700 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="asl-canvas" width="500" height="250"></canvas>
                            </div>
                            
                            <div id="asl-desc" class="mt-4 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.setMode('doppler');
                },

                setMode: function(m) {
                    this.mode = m;
                    this.waves = [];
                    this.sourceX = 50;
                    this.pulse = null;

                    ['doppler', 'interference', 'reflection'].forEach(k => {
                        const btn = document.getElementById(`asl-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });

                    const desc = document.getElementById('asl-desc');
                    if (m === 'doppler') desc.textContent = "Doppler Effect: As the source moves, waves bunch up in front (High Pitch) and spread out behind (Low Pitch).";
                    if (m === 'interference') desc.textContent = "Interference: Two sources create patterns of Constructive (loud) and Destructive (quiet) interference.";
                    if (m === 'reflection') desc.textContent = "Reflection: Sound waves bounce off surfaces. This is the principle behind Echoes and Sonar.";

                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                loop: function() {
                    const canvas = document.getElementById('asl-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    const time = Date.now() / 1000;

                    ctx.clearRect(0,0,w,h);
                    ctx.lineWidth = 2;

                    if (this.mode === 'doppler') {
                        this.sourceX = (this.sourceX + 1.5) % (w + 50);
                        if(this.sourceX > w) this.sourceX = 0;
                        if (!this.lastEmit || time - this.lastEmit > 0.2) {
                            this.waves.push({x: this.sourceX, y: h/2, r: 1, age: 0});
                            this.lastEmit = time;
                        }
                        ctx.strokeStyle = '#60a5fa';
                        for (let i = this.waves.length - 1; i >= 0; i--) {
                            let wave = this.waves[i]; wave.r += 2; wave.age += 0.02;
                            ctx.globalAlpha = Math.max(0, 1 - wave.age);
                            ctx.beginPath(); ctx.arc(wave.x, wave.y, wave.r, 0, Math.PI*2); ctx.stroke();
                            if (wave.age > 1) this.waves.splice(i, 1);
                        }
                        ctx.globalAlpha = 1; ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(this.sourceX, h/2, 5, 0, Math.PI*2); ctx.fill();
                    } else if (this.mode === 'interference') {
                        const s1 = {x: w/3, y: h/2}; const s2 = {x: 2*w/3, y: h/2};
                        if (!this.lastEmit || time - this.lastEmit > 0.3) { this.waves.push({x: s1.x, y: s1.y, r: 1, age: 0}); this.waves.push({x: s2.x, y: s2.y, r: 1, age: 0}); this.lastEmit = time; }
                        ctx.strokeStyle = '#60a5fa';
                        for (let i = this.waves.length - 1; i >= 0; i--) { let wave = this.waves[i]; wave.r += 1.5; wave.age += 0.01; ctx.globalAlpha = Math.max(0, 1 - wave.age); ctx.beginPath(); ctx.arc(wave.x, wave.y, wave.r, 0, Math.PI*2); ctx.stroke(); if (wave.age > 1) this.waves.splice(i, 1); }
                        ctx.globalAlpha = 1; ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(s1.x, s1.y, 5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(s2.x, s2.y, 5, 0, Math.PI*2); ctx.fill();
                    } else if (this.mode === 'reflection') {
                        const wallX = w - 50; ctx.fillStyle = '#9ca3af'; ctx.fillRect(wallX, 50, 10, h-100);
                        if (!this.pulse) this.pulse = {x: 50, dir: 1};
                        this.pulse.x += 3 * this.pulse.dir;
                        if (this.pulse.x >= wallX && this.pulse.dir === 1) { this.pulse.dir = -1; ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(wallX, h/2, 20, 0, Math.PI*2); ctx.fill(); }
                        if (this.pulse.x < 0) { this.pulse.x = 50; this.pulse.dir = 1; }
                        ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(this.pulse.x, h/2, 20, -Math.PI/2, Math.PI/2, this.pulse.dir === -1); ctx.stroke();
                        ctx.fillStyle = '#ef4444'; ctx.fillRect(40, h/2 - 10, 20, 20);
                    }
                    this.animId = requestAnimationFrame(() => this.loop());
                }
            },

            // LIGHT LAB SIMULATION
            lightLab: {
                mode: 'reflection',
                animId: null,
                angle: 45,
                wavelength: 500,
                r: 255, g: 255, b: 255,
                
                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Light & Optics Lab</h3>
                            <div class="flex flex-wrap justify-center gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.lightLab.setMode('reflection')" id="ll-btn-reflection" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Reflection</button>
                                <button onclick="Simulations.lightLab.setMode('refraction')" id="ll-btn-refraction" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Refraction</button>
                                <button onclick="Simulations.lightLab.setMode('spectrum')" id="ll-btn-spectrum" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">EM Spectrum</button>
                                <button onclick="Simulations.lightLab.setMode('colors')" id="ll-btn-colors" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Color Mixing</button>
                            </div>
                            <div class="relative w-full max-w-lg h-64 bg-gray-900 border-2 border-gray-700 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="ll-canvas" width="500" height="250"></canvas>
                            </div>
                            <div id="ll-controls" class="w-full max-w-md mt-4 bg-gray-100 p-4 rounded-lg border border-gray-300"></div>
                            <div id="ll-desc" class="mt-4 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.setMode('reflection');
                },
                setMode: function(m) {
                    this.mode = m;
                    ['reflection', 'refraction', 'spectrum', 'colors'].forEach(k => {
                        const btn = document.getElementById(`ll-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });
                    const controls = document.getElementById('ll-controls');
                    const desc = document.getElementById('ll-desc');
                    if (m === 'reflection') {
                        controls.innerHTML = `<div class="flex items-center gap-4"><label class="font-bold text-sm text-gray-700 w-24">Angle:</label><input type="range" id="ll-slider" min="10" max="80" value="45" class="w-full accent-blue-600" oninput="Simulations.lightLab.update()"><span id="ll-val" class="text-sm font-mono w-12">45¬∞</span></div>`;
                        desc.textContent = "Reflection: Light bounces off a mirror. The Angle of Incidence equals the Angle of Reflection.";
                    } else if (m === 'refraction') {
                        controls.innerHTML = `<div class="flex items-center gap-4"><label class="font-bold text-sm text-gray-700 w-24">Incidence:</label><input type="range" id="ll-slider" min="0" max="80" value="45" class="w-full accent-blue-600" oninput="Simulations.lightLab.update()"><span id="ll-val" class="text-sm font-mono w-12">45¬∞</span></div>`;
                        desc.textContent = "Refraction: Light bends when passing from Air (fast) to Water (slow). It bends towards the normal.";
                    } else if (m === 'spectrum') {
                        controls.innerHTML = `<div class="flex items-center gap-4"><label class="font-bold text-sm text-gray-700 w-24">Wavelength:</label><input type="range" id="ll-slider" min="380" max="750" value="500" class="w-full accent-purple-600" oninput="Simulations.lightLab.update()"><span id="ll-val" class="text-sm font-mono w-16">500nm</span></div>`;
                        desc.textContent = "Visible Spectrum: Different wavelengths correspond to different colors. Shorter = Violet/Blue, Longer = Red.";
                    } else if (m === 'colors') {
                        controls.innerHTML = `
                            <div class="flex gap-4 justify-center">
                                <div class="text-center"><div class="text-red-600 font-bold text-xs">Red</div><input type="range" id="ll-r" min="0" max="255" value="${this.r}" class="h-2 w-20 accent-red-600" oninput="Simulations.lightLab.update()"></div>
                                <div class="text-center"><div class="text-green-600 font-bold text-xs">Green</div><input type="range" id="ll-g" min="0" max="255" value="${this.g}" class="h-2 w-20 accent-green-600" oninput="Simulations.lightLab.update()"></div>
                                <div class="text-center"><div class="text-blue-600 font-bold text-xs">Blue</div><input type="range" id="ll-b" min="0" max="255" value="${this.b}" class="h-2 w-20 accent-blue-600" oninput="Simulations.lightLab.update()"></div>
                            </div>
                        `;
                        desc.textContent = "Additive Color Mixing: Adjust intensities to create different colors. All max = White.";
                    }
                    this.update();
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },
                update: function() {
                    if (this.mode === 'colors') {
                        this.r = parseInt(document.getElementById('ll-r').value);
                        this.g = parseInt(document.getElementById('ll-g').value);
                        this.b = parseInt(document.getElementById('ll-b').value);
                    } else {
                        const slider = document.getElementById('ll-slider');
                        if (slider) {
                            const val = parseInt(slider.value);
                            document.getElementById('ll-val').textContent = this.mode === 'spectrum' ? val + "nm" : val + "¬∞";
                            if (this.mode === 'spectrum') this.wavelength = val; else this.angle = val;
                        }
                    }
                },
                loop: function() {
                    const canvas = document.getElementById('ll-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height; const cx = w/2; const cy = h/2;
                    ctx.clearRect(0,0,w,h);
                    if (this.mode === 'reflection') {
                        ctx.fillStyle = '#94a3b8'; ctx.fillRect(0, h-20, w, 20);
                        ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0, h-20); ctx.lineTo(w, h-20); ctx.stroke();
                        ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.setLineDash([5,5]); ctx.beginPath(); ctx.moveTo(cx, h-20); ctx.lineTo(cx, 20); ctx.stroke(); ctx.setLineDash([]);
                        const rad = (90 - this.angle) * Math.PI / 180; const len = 300;
                        const startX = cx - Math.cos(rad) * len; const startY = (h-20) - Math.sin(rad) * len;
                        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(cx, h-20); ctx.stroke();
                        const endX = cx + Math.cos(rad) * len;
                        ctx.beginPath(); ctx.moveTo(cx, h-20); ctx.lineTo(endX, startY); ctx.stroke();
                        ctx.fillStyle = '#fff'; ctx.font = "14px Arial"; ctx.fillText(`i = ${this.angle}¬∞`, cx - 40, h - 40); ctx.fillText(`r = ${this.angle}¬∞`, cx + 20, h - 40);
                    } else if (this.mode === 'refraction') {
                        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h/2); ctx.fillStyle = '#1e3a8a'; ctx.fillRect(0, h/2, w, h/2);
                        ctx.fillStyle = '#fff'; ctx.font = "12px Arial"; ctx.fillText("Air (n=1.0)", 10, 20); ctx.fillText("Water (n=1.33)", 10, h-10);
                        ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.setLineDash([5,5]); ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, h); ctx.stroke(); ctx.setLineDash([]);
                        const rad = (90 - this.angle) * Math.PI / 180; const len = 200;
                        const startX = cx - Math.cos(rad) * len; const startY = (h/2) - Math.sin(rad) * len;
                        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(cx, h/2); ctx.stroke();
                        const theta1Rad = this.angle * Math.PI / 180; const sinTheta2 = (1.0 / 1.33) * Math.sin(theta1Rad); const theta2Rad = Math.asin(sinTheta2);
                        const endX = cx + Math.sin(theta2Rad) * len; const endY = (h/2) + Math.cos(theta2Rad) * len;
                        ctx.beginPath(); ctx.moveTo(cx, h/2); ctx.lineTo(endX, endY); ctx.stroke();
                        ctx.fillStyle = '#fff'; ctx.fillText(`Angle: ${this.angle}¬∞`, cx - 60, h/2 - 20); ctx.fillText(`Refracted: ${(theta2Rad * 180 / Math.PI).toFixed(1)}¬∞`, cx + 10, h/2 + 40);
                    } else if (this.mode === 'spectrum') {
                        ctx.strokeStyle = this.wavelengthToColor(this.wavelength); ctx.lineWidth = 4; ctx.beginPath();
                        const freq = 1000 / this.wavelength;
                        for(let x=0; x<w; x++) { const y = h/2 + Math.sin(x * freq * 0.1 - Date.now()/100) * 50; if(x===0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
                        ctx.stroke();
                        const grad = ctx.createLinearGradient(50, h-40, w-50, h-40);
                        grad.addColorStop(0, '#8b00ff'); grad.addColorStop(0.2, '#0000ff'); grad.addColorStop(0.4, '#00ff00'); grad.addColorStop(0.6, '#ffff00'); grad.addColorStop(0.8, '#ff7f00'); grad.addColorStop(1, '#ff0000');
                        ctx.fillStyle = grad; ctx.fillRect(50, h-50, w-100, 20);
                        const pos = 50 + ((this.wavelength - 380) / (750 - 380)) * (w-100);
                        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.moveTo(pos, h-55); ctx.lineTo(pos-5, h-65); ctx.lineTo(pos+5, h-65); ctx.fill();
                    } else if (this.mode === 'colors') {
                        ctx.globalCompositeOperation = 'screen';
                        ctx.fillStyle = `rgb(${this.r}, 0, 0)`; ctx.beginPath(); ctx.arc(cx, cy-40, 60, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = `rgb(0, ${this.g}, 0)`; ctx.beginPath(); ctx.arc(cx-50, cy+40, 60, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = `rgb(0, 0, ${this.b})`; ctx.beginPath(); ctx.arc(cx+50, cy+40, 60, 0, Math.PI*2); ctx.fill();
                        ctx.globalCompositeOperation = 'source-over';
                        ctx.fillStyle = '#fff'; ctx.font = "14px Arial"; ctx.fillText("Red", cx-10, cy-110); ctx.fillText("Green", cx-100, cy+110); ctx.fillText("Blue", cx+70, cy+110); ctx.fillStyle = '#000'; ctx.fillText("Mix", cx-15, cy+15);
                    }
                    this.animId = requestAnimationFrame(() => this.loop());
                },
                wavelengthToColor: function(l) {
                    let r, g, b; if (l >= 380 && l < 440) { r = -(l - 440) / (440 - 380); g = 0; b = 1; } else if (l >= 440 && l < 490) { r = 0; g = (l - 440) / (490 - 440); b = 1; } else if (l >= 490 && l < 510) { r = 0; g = 1; b = -(l - 510) / (510 - 490); } else if (l >= 510 && l < 580) { r = (l - 510) / (580 - 510); g = 1; b = 0; } else if (l >= 580 && l < 645) { r = 1; g = -(l - 645) / (645 - 580); b = 0; } else if (l >= 645 && l <= 750) { r = 1; g = 0; b = 0; } else { r = 0; g = 0; b = 0; }
                    return `rgb(${Math.round(r * 255)}, ${Math.round(g * 255)}, ${Math.round(b * 255)})`;
                }
            },

            // OPTICS LAB SIMULATION (Lesson 4)
            opticsLab: {
                mode: 'mirrors', // mirrors, diffraction, properties
                animId: null,
                // Mirror props
                mirrorType: 'concave', // concave, convex
                objDist: 100,
                focalLen: 40,
                // Diffraction props
                slitWidth: 50,
                wavelength: 500, // nm
                // Properties props
                amp: 50,
                freq: 5, // relative

                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Advanced Optics Laboratory</h3>
                            <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.opticsLab.setMode('mirrors')" id="ol-btn-mirrors" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Curved Mirrors</button>
                                <button onclick="Simulations.opticsLab.setMode('diffraction')" id="ol-btn-diffraction" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Diffraction</button>
                                <button onclick="Simulations.opticsLab.setMode('properties')" id="ol-btn-properties" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Wave Properties</button>
                            </div>
                            <div class="relative w-full max-w-lg h-64 bg-gray-900 border-2 border-gray-700 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="ol-canvas" width="500" height="250"></canvas>
                            </div>
                            <div id="ol-controls" class="w-full max-w-md mt-4 bg-gray-100 p-4 rounded-lg border border-gray-300"></div>
                            <div id="ol-desc" class="mt-4 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.setMode('mirrors');
                },

                setMode: function(m) {
                    this.mode = m;
                    ['mirrors', 'diffraction', 'properties'].forEach(k => {
                        const btn = document.getElementById(`ol-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });

                    const controls = document.getElementById('ol-controls');
                    const desc = document.getElementById('ol-desc');

                    if (m === 'mirrors') {
                        controls.innerHTML = `<div class="flex flex-col gap-3"><div class="flex justify-center gap-4"><label><input type="radio" name="mtype" value="concave" checked onchange="Simulations.opticsLab.mirrorType='concave';Simulations.opticsLab.update()"> Concave</label><label><input type="radio" name="mtype" value="convex" onchange="Simulations.opticsLab.mirrorType='convex';Simulations.opticsLab.update()"> Convex</label></div><div class="flex items-center gap-2"><span class="text-xs font-bold w-20">Object Dist:</span><input type="range" min="20" max="200" value="${this.objDist}" class="flex-1" oninput="Simulations.opticsLab.objDist=parseInt(this.value);Simulations.opticsLab.update()"></div></div>`;
                        desc.textContent = "Ray Tracing: See how light rays reflect off curved mirrors to form images. Concave focuses; Convex diverges.";
                    } else if (m === 'diffraction') {
                        controls.innerHTML = `<div class="flex items-center gap-2"><span class="text-xs font-bold w-20">Slit Width:</span><input type="range" min="10" max="150" value="${this.slitWidth}" class="flex-1" oninput="Simulations.opticsLab.slitWidth=parseInt(this.value);Simulations.opticsLab.update()"></div>`;
                        desc.textContent = "Diffraction: Light bends through a slit. Narrower slit = Wider spread pattern.";
                    } else if (m === 'properties') {
                        controls.innerHTML = `<div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="text-xs font-bold w-20">Amplitude:</span><input type="range" min="10" max="100" value="${this.amp}" class="flex-1" oninput="Simulations.opticsLab.amp=parseInt(this.value);Simulations.opticsLab.update()"></div><div class="flex items-center gap-2"><span class="text-xs font-bold w-20">Frequency:</span><input type="range" min="1" max="10" value="${this.freq}" class="flex-1" oninput="Simulations.opticsLab.freq=parseInt(this.value);Simulations.opticsLab.update()"></div></div>`;
                        desc.textContent = "Properties: Amplitude controls Brightness. Frequency controls Color.";
                    }
                    this.start();
                },

                update: function() { /* Trigger loop redraw */ },

                start: function() {
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                loop: function() {
                    const canvas = document.getElementById('ol-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height; const cx = w/2; const cy = h/2;

                    ctx.clearRect(0,0,w,h);

                    if (this.mode === 'mirrors') {
                        ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.setLineDash([5,5]); ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(w, cy); ctx.stroke(); ctx.setLineDash([]);
                        
                        // Draw Mirror (Arc)
                        ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 4; ctx.beginPath();
                        const mh = 70; // Half height
                        const R = this.focalLen * 2; // Radius of curvature
                        
                        if (this.mirrorType === 'concave') {
                            // Concave ) - Center of curvature on Left
                            const angle = Math.asin(mh / R);
                            ctx.arc(cx - R, cy, R, -angle, angle);
                        } else {
                            // Convex ( - Center of curvature on Right
                            const angle = Math.asin(mh / R);
                            ctx.arc(cx + R, cy, R, Math.PI - angle, Math.PI + angle);
                        }
                        ctx.stroke();

                        // Object
                        const objX = cx - this.objDist; const objH = 40;
                        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(objX, cy); ctx.lineTo(objX, cy - objH); ctx.stroke();
                        ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.moveTo(objX, cy - objH); ctx.lineTo(objX - 5, cy - objH + 5); ctx.lineTo(objX + 5, cy - objH + 5); ctx.fill();
                        
                        // Image Calculation
                        let f = this.focalLen; 
                        if (this.mirrorType === 'convex') f = -f;
                        
                        // Avoid singularity
                        let dist = this.objDist;
                        if (Math.abs(dist - Math.abs(f)) < 2 && this.mirrorType === 'concave') dist = Math.abs(f) + 2;

                        const di = (f * dist) / (dist - f); 
                        const m = -di / dist; 
                        const imgH = m * objH; 
                        const imgX = cx - di;
                        
                        // Draw Image (Arrow)
                        ctx.strokeStyle = 'rgba(100, 255, 100, 0.8)'; ctx.lineWidth = 3; 
                        ctx.beginPath(); ctx.moveTo(imgX, cy); ctx.lineTo(imgX, cy - imgH); ctx.stroke();
                        
                        // Image Arrowhead
                        ctx.fillStyle = 'rgba(100, 255, 100, 0.8)';
                        const sign = Math.sign(imgH);
                        ctx.beginPath(); 
                        ctx.moveTo(imgX, cy - imgH); 
                        ctx.lineTo(imgX - 5, cy - imgH + 5 * sign); 
                        ctx.lineTo(imgX + 5, cy - imgH + 5 * sign); 
                        ctx.fill();

                        // Rays (Simplified)
                        ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)'; ctx.lineWidth = 1;
                        ctx.beginPath(); ctx.moveTo(objX, cy - objH); ctx.lineTo(cx, cy - objH); ctx.lineTo(imgX, cy - imgH); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(objX, cy - objH); ctx.lineTo(cx, cy); ctx.lineTo(imgX, cy - imgH); ctx.stroke();
                        
                        // Labels
                        ctx.fillStyle = '#fff'; ctx.font = "12px Arial"; 
                        ctx.fillText("Object", objX - 15, cy + 20); 
                        if (imgX > 10 && imgX < w - 10) ctx.fillText("Image", imgX - 15, cy + 20); 
                        
                        // Focal Point
                        const fX = this.mirrorType === 'concave' ? cx - this.focalLen : cx + this.focalLen;
                        ctx.fillStyle = '#fca5a5'; ctx.beginPath(); ctx.arc(fX, cy, 3, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = '#fff'; ctx.fillText("F", fX - 5, cy + 15);
                    } else if (this.mode === 'diffraction') {
                        ctx.fillStyle = '#374151'; ctx.fillRect(cx - 5, 0, 10, cy - this.slitWidth/2); ctx.fillRect(cx - 5, cy + this.slitWidth/2, 10, h - (cy + this.slitWidth/2));
                        ctx.strokeStyle = '#60a5fa'; ctx.lineWidth = 2; const time = Date.now() / 200;
                        for(let i=0; i<cx; i+=20) { const x = (i + time * 10) % cx; ctx.beginPath(); ctx.moveTo(x, 50); ctx.lineTo(x, h-50); ctx.stroke(); }
                        const spread = (this.wavelength / 10) / this.slitWidth; 
                        for(let r=0; r<w-cx; r+=20) { const radius = (r + time * 10) % (w-cx); const alpha = 1 - (radius / (w-cx)); ctx.strokeStyle = `rgba(96, 165, 250, ${alpha})`; ctx.beginPath(); const angle = Math.PI/2 + spread * 2; ctx.arc(cx, cy, radius, -angle/2, angle/2); ctx.stroke(); }
                        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2; ctx.beginPath();
                        for(let y=0; y<h; y++) { const distY = Math.abs(y - cy); const beta = (distY * this.slitWidth) / 2000; let intensity = 1; if (beta !== 0) intensity = Math.pow(Math.sin(beta)/beta, 2); const plotX = w - 10 - intensity * 50; if (y===0) ctx.moveTo(plotX, y); else ctx.lineTo(plotX, y); }
                        ctx.stroke();
                    } else if (this.mode === 'properties') {
                        ctx.strokeStyle = this.freqToColor(this.freq); ctx.lineWidth = 3; ctx.beginPath(); const time = Date.now() / 500;
                        for(let x=0; x<w; x++) { const y = cy + Math.sin(x * this.freq * 0.02 - time * 5) * this.amp; if(x===0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
                        ctx.stroke();
                        ctx.fillStyle = '#fff'; ctx.font = "14px Arial"; ctx.fillText(`Amplitude (Brightness): ${this.amp}`, 20, 30); ctx.fillText(`Frequency (Color): ${this.freq}`, 20, 50);
                        ctx.fillStyle = this.freqToColor(this.freq);
                        for(let i=0; i<5; i++) { const px = (time * 100 + i * 100) % w; const py = cy + 80; ctx.beginPath(); ctx.arc(px, py, 3 + this.amp/20, 0, Math.PI*2); ctx.fill(); }
                        ctx.fillStyle = '#aaa'; ctx.fillText("Photons", 20, cy + 85);
                    }
                    this.animId = requestAnimationFrame(() => this.loop());
                },

                freqToColor: function(f) {
                    const hue = 280 - (f * 28);
                    return `hsl(${hue}, 100%, 50%)`;
                }
            },

            // FINANCIAL CALCULATOR SIMULATION
            financialCalculator: {
                p: 1000, r: 5, t: 10,
                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Financial Growth Explorer</h3>
                            
                            <div class="flex gap-4 w-full max-w-3xl mb-4 bg-gray-50 p-3 rounded border text-sm">
                                <div class="flex-1">
                                    <label class="block font-bold text-blue-600">Principal ($)</label>
                                    <input type="range" id="fc-p" min="100" max="10000" step="100" value="1000" class="w-full accent-blue-600" oninput="Simulations.financialCalculator.update()">
                                    <div class="text-right font-mono" id="fc-p-val">$1,000</div>
                                </div>
                                <div class="flex-1">
                                    <label class="block font-bold text-green-600">Interest Rate (%)</label>
                                    <input type="range" id="fc-r" min="1" max="20" step="0.5" value="5" class="w-full accent-green-600" oninput="Simulations.financialCalculator.update()">
                                    <div class="text-right font-mono" id="fc-r-val">5.0%</div>
                                </div>
                                <div class="flex-1">
                                    <label class="block font-bold text-purple-600">Time (Years)</label>
                                    <input type="range" id="fc-t" min="1" max="50" step="1" value="10" class="w-full accent-purple-600" oninput="Simulations.financialCalculator.update()">
                                    <div class="text-right font-mono" id="fc-t-val">10 Years</div>
                                </div>
                            </div>

                            <div class="relative w-full max-w-3xl h-64 bg-white border-2 border-gray-300 rounded-lg shadow-inner mb-4 flex">
                                <canvas id="fc-canvas" class="w-full h-full"></canvas>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 w-full max-w-2xl text-center">
                                <div class="bg-blue-50 p-2 rounded border border-blue-200">
                                    <div class="text-xs font-bold text-gray-500">Simple Interest Total</div>
                                    <div id="fc-simple-total" class="text-xl font-bold text-blue-700">$1,500</div>
                                </div>
                                <div class="bg-green-50 p-2 rounded border border-green-200">
                                    <div class="text-xs font-bold text-gray-500">Compound Interest Total</div>
                                    <div id="fc-compound-total" class="text-xl font-bold text-green-700">$1,628</div>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">Compound Interest assumes annual compounding.</div>
                        </div>
                    `;
                    this.update();
                },
                update: function() {
                    this.p = parseFloat(document.getElementById('fc-p').value);
                    this.r = parseFloat(document.getElementById('fc-r').value);
                    this.t = parseFloat(document.getElementById('fc-t').value);
                    
                    document.getElementById('fc-p-val').textContent = "$" + this.p.toLocaleString();
                    document.getElementById('fc-r-val').textContent = this.r + "%";
                    document.getElementById('fc-t-val').textContent = this.t + " Years";

                    const simpleTotal = this.p * (1 + (this.r/100) * this.t);
                    const compoundTotal = this.p * Math.pow((1 + this.r/100), this.t);

                    document.getElementById('fc-simple-total').textContent = "$" + Math.round(simpleTotal).toLocaleString();
                    document.getElementById('fc-compound-total').textContent = "$" + Math.round(compoundTotal).toLocaleString();

                    this.drawGraph();
                },
                drawGraph: function() {
                    const canvas = document.getElementById('fc-canvas');
                    if(!canvas) return;
                    if(canvas.width !== canvas.clientWidth) { canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    const pad = 80;

                    ctx.clearRect(0,0,w,h);
                    
                    const currentMax = this.p * Math.pow((1 + this.r/100), this.t);
                    const yScale = (h - 2*pad) / currentMax;
                    const xScale = (w - 2*pad) / this.t;

                    // Legend (Centered at top)
                    const legendY = 20;
                    const centerX = w / 2;
                    
                    ctx.font = "bold 12px sans-serif";
                    ctx.textBaseline = "middle";
                    
                    // Simple Interest Legend
                    ctx.beginPath();
                    ctx.strokeStyle = '#2563eb';
                    ctx.lineWidth = 3;
                    ctx.moveTo(centerX - 80, legendY);
                    ctx.lineTo(centerX - 60, legendY);
                    ctx.stroke();
                    ctx.textAlign = "left";
                    ctx.fillStyle = '#2563eb';
                    ctx.fillText("Simple", centerX - 55, legendY);

                    // Compound Interest Legend
                    ctx.beginPath();
                    ctx.strokeStyle = '#16a34a';
                    ctx.lineWidth = 3;
                    ctx.moveTo(centerX + 20, legendY);
                    ctx.lineTo(centerX + 40, legendY);
                    ctx.stroke();
                    ctx.fillStyle = '#16a34a';
                    ctx.fillText("Compound", centerX + 45, legendY);

                    // Axes
                    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(pad, pad); ctx.lineTo(pad, h - pad); ctx.lineTo(w - pad, h - pad);
                    ctx.stroke();

                    // Simple Interest Line (Blue)
                    ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 3; ctx.beginPath();
                    for(let i=0; i<=this.t; i++) {
                        const val = this.p * (1 + (this.r/100) * i);
                        const x = pad + i * xScale;
                        const yPlot = h - pad - (val / currentMax) * (h - 2*pad);
                        if(i===0) ctx.moveTo(x, yPlot); else ctx.lineTo(x, yPlot);
                    }
                    ctx.stroke();

                    // Compound Interest Line (Green)
                    ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 3; ctx.beginPath();
                    for(let i=0; i<=this.t; i++) {
                        const val = this.p * Math.pow((1 + this.r/100), i);
                        const x = pad + i * xScale;
                        const yPlot = h - pad - (val / currentMax) * (h - 2*pad);
                        if(i===0) ctx.moveTo(x, yPlot); else ctx.lineTo(x, yPlot);
                    }
                    ctx.stroke();

                    // Labels
                    ctx.fillStyle = '#6b7280'; ctx.font = "10px sans-serif";
                    
                    // X-Axis
                    ctx.textAlign = "center";
                    ctx.textBaseline = "top";
                    ctx.fillText("0", pad, h - pad + 8);
                    ctx.fillText(this.t + " yrs", w - pad, h - pad + 8);
                    
                    // Y-Axis Label (Max Value)
                    ctx.textAlign = "right";
                    ctx.textBaseline = "middle";
                    ctx.fillText("$" + Math.round(currentMax).toLocaleString(), pad - 8, pad);
                }
            },

            // MATTER LAB SIMULATION
            matterLab: {
                mode: 'states', // states, atom
                animId: null,
                temp: 20, // 0-100
                particles: [],
                
                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Matter & Energy Lab</h3>
                            
                            <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.matterLab.setMode('states')" id="ml-btn-states" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">States of Matter</button>
                                <button onclick="Simulations.matterLab.setMode('atom')" id="ml-btn-atom" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Atomic Structure</button>
                            </div>

                            <div class="relative w-full max-w-lg h-64 bg-gray-900 border-2 border-gray-700 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="ml-canvas" width="500" height="250"></canvas>
                                <div id="ml-overlay" class="absolute top-2 left-2 text-xs text-gray-400 pointer-events-none"></div>
                            </div>
                            
                            <div id="ml-controls" class="w-full max-w-md mt-4 bg-gray-100 p-4 rounded-lg border border-gray-300"></div>
                            <div id="ml-desc" class="mt-4 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.setMode('states');
                },

                setMode: function(m) {
                    this.mode = m;
                    ['states', 'atom'].forEach(k => {
                        const btn = document.getElementById(`ml-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });

                    const controls = document.getElementById('ml-controls');
                    const desc = document.getElementById('ml-desc');

                    if (m === 'states') {
                        controls.innerHTML = `
                            <div class="flex flex-col gap-2">
                                <div class="flex justify-between text-xs font-bold text-gray-600"><span>Solid</span><span>Liquid</span><span>Gas</span><span>Plasma</span></div>
                                <input type="range" id="ml-temp" min="0" max="100" value="${this.temp}" class="w-full accent-red-500" oninput="Simulations.matterLab.update()">
                                <div class="text-center text-sm font-bold text-red-600" id="ml-temp-val">Temperature: Low</div>
                            </div>
                        `;
                        desc.textContent = "Heat Energy determines the state of matter. Add heat to move from Solid ‚Üí Liquid ‚Üí Gas ‚Üí Plasma.";
                        this.initParticles();
                    } else if (m === 'atom') {
                        controls.innerHTML = `
                            <div class="flex justify-center gap-4 text-sm">
                                <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-red-500"></div> Proton (+)</div>
                                <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-gray-400"></div> Neutron (0)</div>
                                <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-blue-400"></div> Electron (-)</div>
                            </div>
                        `;
                        desc.textContent = "The Atom: Protons and Neutrons form the dense Nucleus. Electrons orbit in shells around it.";
                    }
                    
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                initParticles: function() {
                    this.particles = [];
                    for(let i=0; i<100; i++) {
                        this.particles.push({
                            x: Math.random() * 500, y: Math.random() * 250,
                            vx: 0, vy: 0,
                            baseX: (i % 10) * 30 + 110, baseY: Math.floor(i / 10) * 20 + 50
                        });
                    }
                    this.update();
                },

                update: function() {
                    if (this.mode === 'states') {
                        const slider = document.getElementById('ml-temp');
                        if(slider) {
                            this.temp = parseInt(slider.value);
                            const label = document.getElementById('ml-temp-val');
                            if(this.temp < 25) label.textContent = "State: Solid";
                            else if(this.temp < 50) label.textContent = "State: Liquid";
                            else if(this.temp < 75) label.textContent = "State: Gas";
                            else label.textContent = "State: Plasma";
                        }
                    }
                },

                loop: function() {
                    const canvas = document.getElementById('ml-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    ctx.clearRect(0,0,w,h);

                    if (this.mode === 'states') {
                        const speed = this.temp / 10;
                        const jitter = this.temp < 25 ? 1 : (this.temp < 50 ? 3 : 10);
                        this.particles.forEach(p => {
                            if (this.temp < 25) { p.x += (p.baseX - p.x) * 0.1 + (Math.random()-0.5)*jitter; p.y += (p.baseY - p.y) * 0.1 + (Math.random()-0.5)*jitter; }
                            else {
                                if (this.temp < 50) { p.vy += 0.1; if(p.y > h-10) p.y = h-10; }
                                p.vx += (Math.random()-0.5) * speed * 0.1; p.vy += (Math.random()-0.5) * speed * 0.1;
                                p.vx *= 0.99; p.vy *= 0.99; p.x += p.vx; p.y += p.vy;
                                if(p.x < 0 || p.x > w) p.vx *= -1; if(p.y < 0 || p.y > h) p.vy *= -1;
                            }
                            ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
                            if (this.temp > 75) { ctx.fillStyle = '#eab308'; ctx.shadowBlur = 10; ctx.shadowColor = '#eab308'; } else { ctx.fillStyle = '#3b82f6'; ctx.shadowBlur = 0; }
                            ctx.fill(); ctx.shadowBlur = 0;
                        });
                    } else if (this.mode === 'atom') {
                        const cx = w/2; const cy = h/2; const time = Date.now() / 1000;
                        for(let i=0; i<6; i++) {
                            ctx.beginPath(); ctx.arc(cx + Math.cos(i)*8, cy + Math.sin(i)*8, 8, 0, Math.PI*2);
                            ctx.fillStyle = i%2===0 ? '#ef4444' : '#9ca3af'; ctx.fill();
                            ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.stroke();
                            ctx.fillStyle = '#fff'; ctx.font = "10px Arial"; ctx.textAlign = "center"; ctx.fillText(i%2===0 ? "+" : "", cx + Math.cos(i)*8, cy + Math.sin(i)*8 + 3);
                        }
                        ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                        ctx.beginPath(); ctx.ellipse(cx, cy, 60, 20, time, 0, Math.PI*2); ctx.stroke();
                        ctx.beginPath(); ctx.ellipse(cx, cy, 60, 20, time + Math.PI/3, 0, Math.PI*2); ctx.stroke();
                        ctx.beginPath(); ctx.ellipse(cx, cy, 60, 20, time + 2*Math.PI/3, 0, Math.PI*2); ctx.stroke();
                        const drawElectron = (angleOffset) => {
                            const angle = time * 5;
                            const ex = cx + Math.cos(angle) * 60 * Math.cos(angleOffset) - Math.sin(angle) * 20 * Math.sin(angleOffset);
                            const ey = cy + Math.cos(angle) * 60 * Math.sin(angleOffset) + Math.sin(angle) * 20 * Math.cos(angleOffset);
                            ctx.beginPath(); ctx.arc(ex, ey, 5, 0, Math.PI*2); ctx.fillStyle = '#60a5fa'; ctx.fill();
                        };
                        drawElectron(time); drawElectron(time + Math.PI/3); drawElectron(time + 2*Math.PI/3);
                    }
                    this.animId = requestAnimationFrame(() => this.loop());
                }
            },

            // ENERGY LAB SIMULATION
            energyLab: {
                animId: null,
                mass: 5,
                k: 2,
                damping: 0.02,
                block: { y: 150, vy: 0 },
                thermal: 0,
                isDragging: false,
                
                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Spring Energy Lab</h3>
                            
                            <div class="relative w-full max-w-lg h-64 bg-gray-50 border-2 border-gray-400 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="el-canvas" width="500" height="250"></canvas>
                                <div class="absolute top-2 left-2 text-xs text-gray-500 pointer-events-none bg-white/80 p-1 rounded">
                                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-blue-500"></div> KE</div>
                                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-500"></div> PE (Spring)</div>
                                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-orange-500"></div> PE (Gravity)</div>
                                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-500"></div> Thermal</div>
                                </div>
                                <div id="el-overlay" class="absolute bottom-2 text-sm text-gray-500 bg-white/80 px-2 rounded pointer-events-none">Drag the mass to start</div>
                            </div>
                            
                            <div class="w-full max-w-md mt-4 bg-gray-100 p-4 rounded-lg border border-gray-300 flex gap-4 justify-center">
                                <div>
                                    <label class="block text-xs font-bold text-gray-600">Mass</label>
                                    <input type="range" min="2" max="10" value="${this.mass}" class="accent-blue-600" oninput="Simulations.energyLab.mass=parseInt(this.value)">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-600">Spring Stiffness</label>
                                    <input type="range" min="1" max="10" value="${this.k}" class="accent-green-600" oninput="Simulations.energyLab.k=parseInt(this.value)">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-600">Friction</label>
                                    <input type="range" min="0" max="0.1" step="0.01" value="${this.damping}" class="accent-red-600" oninput="Simulations.energyLab.damping=parseFloat(this.value)">
                                </div>
                            </div>
                            <div class="mt-2 text-sm text-gray-600 text-center max-w-md">
                                Observe how energy transforms between Kinetic, Potential (Spring & Gravity), and Heat.
                            </div>
                        </div>
                    `;
                    
                    const canvas = document.getElementById('el-canvas');
                    canvas.addEventListener('mousedown', (e) => this.handleDown(e));
                    canvas.addEventListener('mousemove', (e) => this.handleMove(e));
                    window.addEventListener('mouseup', () => this.handleUp());

                    this.reset();
                    this.start();
                },

                reset: function() {
                    this.block.y = 150;
                    this.block.vy = 0;
                    this.thermal = 0;
                },

                handleDown: function(e) {
                    const canvas = document.getElementById('el-canvas');
                    const rect = canvas.getBoundingClientRect();
                    const mx = e.clientX - rect.left;
                    const my = e.clientY - rect.top;
                    
                    if (Math.abs(mx - 250) < 30 && Math.abs(my - this.block.y) < 30) {
                        this.isDragging = true;
                        this.block.vy = 0;
                    }
                },

                handleMove: function(e) {
                    if (!this.isDragging) return;
                    const canvas = document.getElementById('el-canvas');
                    const rect = canvas.getBoundingClientRect();
                    const my = e.clientY - rect.top;
                    
                    this.block.y = Math.max(50, Math.min(230, my));
                    this.block.vy = 0;
                    this.thermal = 0;
                },

                handleUp: function() {
                    this.isDragging = false;
                },

                start: function() {
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                loop: function() {
                    const canvas = document.getElementById('el-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;

                    ctx.clearRect(0,0,w,h);

                    // Physics
                    if (!this.isDragging) {
                        const displacement = this.block.y - 100; // 100 is anchor Y + natural length approx
                        const springForce = -this.k * 0.5 * displacement; // k is small here for visual scaling
                        const gravityForce = this.mass * 0.2;
                        const dampingForce = -this.damping * this.block.vy * 10;
                        
                        const acceleration = (springForce + gravityForce + dampingForce) / this.mass;
                        this.block.vy += acceleration;
                        this.block.y += this.block.vy;
                        
                        // Energy Loss to Thermal
                        if (this.damping > 0) {
                            this.thermal = (this.thermal || 0) + Math.abs(dampingForce * this.block.vy * 0.1);
                        }
                    }

                    // Draw Spring
                    ctx.beginPath();
                    ctx.moveTo(250, 0);
                    const coils = 10;
                    const springLen = this.block.y;
                    for(let i=0; i<=coils; i++) {
                        const y = (i/coils) * springLen;
                        const x = 250 + (i%2===0 ? -10 : 10) * (i===0 || i===coils ? 0 : 1);
                        ctx.lineTo(x, y);
                    }
                    ctx.strokeStyle = '#4b5563';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Draw Mass
                    ctx.fillStyle = '#ef4444';
                    ctx.fillRect(230, this.block.y, 40, 40);
                    ctx.strokeStyle = '#7f1d1d';
                    ctx.strokeRect(230, this.block.y, 40, 40);
                    ctx.fillStyle = 'white';
                    ctx.font = '12px Arial';
                    ctx.fillText(this.mass + "kg", 238, this.block.y + 25);

                    // Energy Chart
                    const v = this.block.vy;
                    const dist = (this.block.y - 100);
                    const height = h - this.block.y;
                    
                    const ke = 0.5 * this.mass * v * v * 10;
                    const epe = 0.5 * (this.k * 0.5) * dist * dist;
                    const gpe = this.mass * 0.2 * height;
                    const th = this.thermal || 0;
                    
                    const total = ke + epe + gpe + th;
                    const maxBar = 150;
                    const scale = total > 0 ? maxBar / total : 0;

                    const chartX = 400; const chartY = 200;
                    const barW = 15;
                    
                    ctx.fillStyle = '#3b82f6'; ctx.fillRect(chartX, chartY - ke*scale, barW, ke*scale);
                    ctx.fillStyle = '#22c55e'; ctx.fillRect(chartX + 20, chartY - epe*scale, barW, epe*scale);
                    ctx.fillStyle = '#f97316'; ctx.fillRect(chartX + 40, chartY - gpe*scale, barW, gpe*scale);
                    ctx.fillStyle = '#ef4444'; ctx.fillRect(chartX + 60, chartY - th*scale, barW, th*scale);
                    
                    ctx.strokeStyle = '#000';
                    ctx.strokeRect(chartX - 5, chartY - maxBar, 90, maxBar);
                    ctx.fillStyle = '#000';
                    ctx.fillText("Energy", chartX + 10, chartY + 15);

                    this.animId = requestAnimationFrame(() => this.loop());
                }
            },

            // HEAT & GAS LAB SIMULATION
            heatGasLab: {
                mode: 'gas', // gas, heat
                animId: null,
                // Gas props
                volume: 50, // 20-100 (piston height inverted)
                temperature: 300, // Kelvin
                pressure: 0,
                particles: [],
                // Heat props
                heatMode: 'conduction', // conduction, convection, radiation

                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Thermodynamics & Gas Lab</h3>
                            
                            <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.heatGasLab.setMode('gas')" id="hgl-btn-gas" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Gas Laws</button>
                                <button onclick="Simulations.heatGasLab.setMode('heat')" id="hgl-btn-heat" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Heat Transfer</button>
                            </div>

                            <div class="relative w-full max-w-lg h-64 bg-gray-50 border-2 border-gray-400 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="hgl-canvas" width="500" height="250"></canvas>
                                <div id="hgl-overlay" class="absolute top-2 left-2 text-xs text-gray-500 pointer-events-none"></div>
                            </div>
                            
                            <div id="hgl-controls" class="w-full max-w-md mt-4 bg-gray-100 p-4 rounded-lg border border-gray-300"></div>
                            <div id="hgl-desc" class="mt-2 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.initParticles();
                    this.setMode('gas');
                },

                initParticles: function() {
                    this.particles = [];
                    for(let i=0; i<50; i++) {
                        this.particles.push({
                            x: Math.random() * 400 + 50,
                            y: Math.random() * 200 + 25,
                            vx: (Math.random()-0.5) * 2,
                            vy: (Math.random()-0.5) * 2
                        });
                    }
                },

                setMode: function(m) {
                    this.mode = m;
                    ['gas', 'heat'].forEach(k => {
                        const btn = document.getElementById(`hgl-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });

                    const controls = document.getElementById('hgl-controls');
                    const desc = document.getElementById('hgl-desc');

                    if (m === 'gas') {
                        controls.innerHTML = `
                            <div class="flex flex-col gap-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold w-24">Volume (Piston):</span>
                                    <input type="range" min="20" max="100" value="${this.volume}" class="flex-1 accent-blue-600" oninput="Simulations.heatGasLab.volume=parseInt(this.value);Simulations.heatGasLab.update()">
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold w-24">Temperature:</span>
                                    <input type="range" min="100" max="600" value="${this.temperature}" class="flex-1 accent-red-600" oninput="Simulations.heatGasLab.temperature=parseInt(this.value);Simulations.heatGasLab.update()">
                                    <span id="hgl-temp-val" class="text-xs font-mono w-12">${this.temperature}K</span>
                                </div>
                                <div class="flex justify-between text-sm font-bold bg-white p-2 rounded border">
                                    <span>Pressure: <span id="hgl-pressure" class="text-purple-600">--</span> atm</span>
                                </div>
                            </div>
                        `;
                        desc.textContent = "Gas Laws: Adjust Volume (V) and Temperature (T) to see how Pressure (P) changes. (PV = nRT)";
                    } else {
                        controls.innerHTML = `
                            <div class="flex justify-center gap-2">
                                <button onclick="Simulations.heatGasLab.heatMode='conduction';Simulations.heatGasLab.update()" class="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-100">Conduction</button>
                                <button onclick="Simulations.heatGasLab.heatMode='convection';Simulations.heatGasLab.update()" class="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-100">Convection</button>
                                <button onclick="Simulations.heatGasLab.heatMode='radiation';Simulations.heatGasLab.update()" class="px-2 py-1 text-xs bg-white border rounded hover:bg-gray-100">Radiation</button>
                            </div>
                        `;
                        desc.textContent = "Heat Transfer: Visualize how energy moves through materials (Conduction), fluids (Convection), or space (Radiation).";
                    }
                    
                    this.update();
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                update: function() {
                    if (this.mode === 'gas') {
                        const tempVal = document.getElementById('hgl-temp-val');
                        if(tempVal) tempVal.textContent = this.temperature + "K";
                        const P = (this.temperature / this.volume).toFixed(2);
                        const pVal = document.getElementById('hgl-pressure');
                        if(pVal) pVal.textContent = P;
                    }
                },

                loop: function() {
                    const canvas = document.getElementById('hgl-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    const cx = w/2; const cy = h/2;

                    ctx.clearRect(0,0,w,h);

                    if (this.mode === 'gas') {
                        const cylW = 200; const cylH = 200; const cylX = (w - cylW)/2; const cylY = (h - cylH)/2 + 20;
                        ctx.fillStyle = '#f3f4f6'; ctx.fillRect(cylX, cylY, cylW, cylH);
                        ctx.strokeStyle = '#374151'; ctx.lineWidth = 4; ctx.strokeRect(cylX, cylY, cylW, cylH);
                        const pistonH = (this.volume / 100) * cylH; const pistonY = cylY + cylH - pistonH;
                        ctx.fillStyle = '#9ca3af'; ctx.fillRect(cylX + 2, pistonY - 10, cylW - 4, 10);
                        ctx.fillStyle = '#6b7280'; ctx.fillRect(cx - 5, cylY - 40, 10, pistonY - (cylY - 40)); ctx.fillRect(cx - 20, cylY - 40, 40, 10);
                        const speedFactor = Math.sqrt(this.temperature) * 0.15;
                        ctx.fillStyle = '#ef4444';
                        this.particles.forEach(p => {
                            p.x += p.vx * speedFactor; p.y += p.vy * speedFactor;
                            if (p.x < cylX + 5 || p.x > cylX + cylW - 5) p.vx *= -1;
                            if (p.y < pistonY + 5 || p.y > cylY + cylH - 5) p.vy *= -1;
                            p.x = Math.max(cylX + 5, Math.min(cylX + cylW - 5, p.x)); p.y = Math.max(pistonY + 5, Math.min(cylY + cylH - 5, p.y));
                            ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
                        });
                        if (this.temperature > 300) { ctx.fillStyle = `rgba(239, 68, 68, ${(this.temperature-300)/300})`; ctx.font = "20px Arial"; ctx.fillText("üî•", cx - 10, cylY + cylH + 25); }
                        else if (this.temperature < 300) { ctx.fillStyle = `rgba(59, 130, 246, ${(300-this.temperature)/200})`; ctx.font = "20px Arial"; ctx.fillText("‚ùÑÔ∏è", cx - 10, cylY + cylH + 25); }
                    } else if (this.mode === 'heat') {
                        const time = Date.now() / 1000;
                        if (this.heatMode === 'conduction') {
                            const barW = 300; const barH = 40; const barX = (w - barW)/2; const barY = cy - 20;
                            const heatProp = (Math.sin(time) + 1) / 2;
                            const grad = ctx.createLinearGradient(barX, 0, barX + barW, 0); grad.addColorStop(0, '#ef4444'); grad.addColorStop(Math.max(0.1, heatProp), '#3b82f6'); grad.addColorStop(1, '#3b82f6');
                            ctx.fillStyle = grad; ctx.fillRect(barX, barY, barW, barH); ctx.strokeStyle = '#000'; ctx.strokeRect(barX, barY, barW, barH);
                            ctx.fillStyle = '#000'; ctx.fillText("Heat Source", barX - 70, barY + 25); ctx.fillText("Cold End", barX + barW + 10, barY + 25);
                            for(let i=0; i<30; i++) { const px = barX + i * 10 + 5; const py = barY + 20; const dist = (px - barX) / barW; const amp = (1 - dist) * (heatProp * 5); const vibX = Math.sin(time * 20 + i) * amp; const vibY = Math.cos(time * 20 + i) * amp; ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.beginPath(); ctx.arc(px + vibX, py + vibY, 3, 0, Math.PI*2); ctx.fill(); }
                        } else if (this.heatMode === 'convection') {
                            const potX = cx - 75; const potY = cy - 50; const potW = 150; const potH = 100; ctx.fillStyle = '#bfdbfe'; ctx.fillRect(potX, potY, potW, potH); ctx.strokeStyle = '#000'; ctx.strokeRect(potX, potY, potW, potH);
                            ctx.fillStyle = '#ef4444'; for(let i=0; i<10; i++) { const offset = i * (Math.PI * 2 / 10); const r = 30; const py = cy + Math.sin(time * 2 + offset) * r; const temp = (py - potY) / potH; ctx.fillStyle = temp > 0.5 ? '#ef4444' : '#3b82f6'; const cellX = i < 5 ? cx - 35 : cx + 35; const cellY = cy; const angle = time * 2 + offset; const pX = cellX + Math.cos(angle) * 20 * (i<5 ? 1 : -1); const pY = cellY + Math.sin(angle) * 30; ctx.beginPath(); ctx.arc(pX, pY, 4, 0, Math.PI*2); ctx.fill(); }
                            ctx.fillStyle = '#000'; ctx.fillText("Heat Source", cx - 30, potY + potH + 20); ctx.fillText("üî•", cx - 10, potY + potH + 40);
                        } else if (this.heatMode === 'radiation') {
                            ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.arc(100, cy, 40, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(400, cy, 20, 0, Math.PI*2); ctx.fill();
                            ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 2; const waveCount = 5; for(let i=0; i<waveCount; i++) { const progress = (time * 0.5 + i/waveCount) % 1; const x = 140 + progress * 240; const y = cy + Math.sin(x * 0.1 + time * 10) * 10; if (x < 380) { ctx.beginPath(); ctx.arc(x, y, 2, 0, Math.PI*2); ctx.stroke(); } }
                            ctx.fillStyle = '#000'; ctx.fillText("Vacuum of Space", cx - 40, cy - 60);
                        }
                    }
                    this.animId = requestAnimationFrame(() => this.loop());
                }
            },

            // CHEMISTRY LAB SIMULATION
            chemistryLab: {
                mode: 'atom', // atom, bonding, balancing
                animId: null,
                // Atom props
                p: 1, n: 0, e: 1,
                // Bonding props
                bondType: 'ionic',
                // Balancing props
                c1: 1, c2: 1, c3: 1, // H2 + O2 -> H2O

                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Chemistry Laboratory</h3>
                            
                            <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.chemistryLab.setMode('atom')" id="cl-btn-atom" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Atom Builder</button>
                                <button onclick="Simulations.chemistryLab.setMode('bonding')" id="cl-btn-bonding" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Bonding</button>
                                <button onclick="Simulations.chemistryLab.setMode('balancing')" id="cl-btn-balancing" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Balancing Eq</button>
                            </div>

                            <div class="relative w-full max-w-lg h-64 bg-gray-50 border-2 border-gray-400 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="cl-canvas" width="500" height="250"></canvas>
                            </div>
                            
                            <div id="cl-controls" class="w-full max-w-md mt-4 bg-gray-100 p-4 rounded-lg border border-gray-300"></div>
                            <div id="cl-desc" class="mt-4 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.setMode('atom');
                },

                setMode: function(m) {
                    this.mode = m;
                    ['atom', 'bonding', 'balancing'].forEach(k => {
                        const btn = document.getElementById(`cl-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });

                    const controls = document.getElementById('cl-controls');
                    const desc = document.getElementById('cl-desc');

                    if (m === 'atom') {
                        controls.innerHTML = `
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div><label class="text-xs font-bold text-red-600">Protons</label><input type="range" min="1" max="10" value="${this.p}" class="w-full accent-red-600" oninput="Simulations.chemistryLab.p=parseInt(this.value);Simulations.chemistryLab.update()"></div>
                                <div><label class="text-xs font-bold text-gray-600">Neutrons</label><input type="range" min="0" max="12" value="${this.n}" class="w-full accent-gray-600" oninput="Simulations.chemistryLab.n=parseInt(this.value);Simulations.chemistryLab.update()"></div>
                                <div><label class="text-xs font-bold text-blue-600">Electrons</label><input type="range" min="0" max="10" value="${this.e}" class="w-full accent-blue-600" oninput="Simulations.chemistryLab.e=parseInt(this.value);Simulations.chemistryLab.update()"></div>
                            </div>
                        `;
                        desc.textContent = "Build an Atom! Protons define the element. Electrons define the charge.";
                    } else if (m === 'bonding') {
                        controls.innerHTML = `
                            <div class="flex justify-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="btype" value="ionic" checked onchange="Simulations.chemistryLab.bondType='ionic';Simulations.chemistryLab.update()"> Ionic (Na + Cl)</label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="btype" value="covalent" onchange="Simulations.chemistryLab.bondType='covalent';Simulations.chemistryLab.update()"> Covalent (H + H)</label>
                            </div>
                        `;
                        desc.textContent = "Ionic: Transfer of electrons (Attraction of opposites). Covalent: Sharing of electrons.";
                    } else if (m === 'balancing') {
                        controls.innerHTML = `
                            <div class="flex items-center justify-center gap-2 font-mono text-lg">
                                <input type="number" min="1" max="5" value="${this.c1}" class="w-12 text-center border rounded" onchange="Simulations.chemistryLab.c1=parseInt(this.value);Simulations.chemistryLab.update()"> H‚ÇÇ + 
                                <input type="number" min="1" max="5" value="${this.c2}" class="w-12 text-center border rounded" onchange="Simulations.chemistryLab.c2=parseInt(this.value);Simulations.chemistryLab.update()"> O‚ÇÇ ‚Üí 
                                <input type="number" min="1" max="5" value="${this.c3}" class="w-12 text-center border rounded" onchange="Simulations.chemistryLab.c3=parseInt(this.value);Simulations.chemistryLab.update()"> H‚ÇÇO
                            </div>
                        `;
                        desc.textContent = "Balance the equation! Make sure the number of H and O atoms is the same on both sides.";
                    }
                    
                    this.start();
                },

                update: function() { /* Trigger loop redraw */ },

                start: function() {
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                loop: function() {
                    const canvas = document.getElementById('cl-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height; const cx = w/2; const cy = h/2;
                    const time = Date.now() / 1000;

                    ctx.clearRect(0,0,w,h);

                    if (this.mode === 'atom') {
                        // Nucleus
                        for(let i=0; i<this.p; i++) {
                            ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(cx + Math.cos(i)*10, cy + Math.sin(i)*10, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle='#000'; ctx.stroke();
                        }
                        for(let i=0; i<this.n; i++) {
                            ctx.fillStyle = '#9ca3af'; ctx.beginPath(); ctx.arc(cx + Math.cos(i+2)*8, cy + Math.sin(i+2)*8, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle='#000'; ctx.stroke();
                        }
                        // Shells
                        ctx.strokeStyle = 'rgba(0,0,0,0.2)';
                        ctx.beginPath(); ctx.arc(cx, cy, 40, 0, Math.PI*2); ctx.stroke();
                        if(this.e > 2) { ctx.beginPath(); ctx.arc(cx, cy, 70, 0, Math.PI*2); ctx.stroke(); }
                        
                        // Electrons
                        ctx.fillStyle = '#3b82f6';
                        for(let i=0; i<this.e; i++) {
                            let r = i < 2 ? 40 : 70;
                            let angle = time * (i<2 ? 2 : 1) + (i * (Math.PI*2 / (i<2?2:(this.e-2))));
                            ctx.beginPath(); ctx.arc(cx + Math.cos(angle)*r, cy + Math.sin(angle)*r, 5, 0, Math.PI*2); ctx.fill();
                        }

                        // Info
                        const elements = ["?", "Hydrogen", "Helium", "Lithium", "Beryllium", "Boron", "Carbon", "Nitrogen", "Oxygen", "Fluorine", "Neon"];
                        const name = elements[this.p] || "Unknown";
                        const charge = this.p - this.e;
                        const chargeStr = charge > 0 ? `+${charge}` : (charge < 0 ? `${charge}` : "Neutral");
                        
                        ctx.fillStyle = '#000'; ctx.font = "bold 16px Arial"; ctx.textAlign = "left";
                        ctx.fillText(`Element: ${name}`, 10, 30);
                        ctx.fillText(`Atomic #: ${this.p}`, 10, 50);
                        ctx.fillText(`Mass #: ${this.p + this.n}`, 10, 70);
                        ctx.fillText(`Net Charge: ${chargeStr}`, 10, 90);
                    } else if (this.mode === 'bonding') {
                        if (this.bondType === 'ionic') {
                            // Na + Cl
                            const dist = 100;
                            const naX = cx - 60; const clX = cx + 60;
                            
                            // Na
                            ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.arc(naX, cy, 30, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#000'; ctx.textAlign="center"; ctx.fillText("Na", naX, cy+5);
                            ctx.strokeStyle = '#ccc'; ctx.beginPath(); ctx.arc(naX, cy, 45, 0, Math.PI*2); ctx.stroke();
                            // Cl
                            ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.arc(clX, cy, 40, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#000'; ctx.fillText("Cl", clX, cy+5);
                            ctx.strokeStyle = '#ccc'; ctx.beginPath(); ctx.arc(clX, cy, 55, 0, Math.PI*2); ctx.stroke();

                            // Electron Transfer Animation
                            const t = (Math.sin(time * 2) + 1) / 2; // 0 to 1
                            // Na electron
                            const ex = naX + 45 * Math.cos(0) * (1-t) + (clX - 55) * t;
                            const ey = cy;
                            ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(ex, ey, 5, 0, Math.PI*2); ctx.fill();
                            
                            // Cl electrons (7 static)
                            for(let i=1; i<8; i++) {
                                const a = i * (Math.PI*2/8);
                                ctx.beginPath(); ctx.arc(clX + Math.cos(a)*55, cy + Math.sin(a)*55, 5, 0, Math.PI*2); ctx.fill();
                            }

                            ctx.fillStyle = '#000'; ctx.font = "14px Arial";
                            if (t > 0.8) {
                                ctx.fillText("Na‚Å∫", naX, cy - 40);
                                ctx.fillText("Cl‚Åª", clX, cy - 50);
                                ctx.fillText("Ionic Bond Formed!", cx, h - 20);
                            }
                        } else {
                            // H + H
                            const t = (Math.sin(time) + 1) / 2; 
                            const dist = 80 * (1 - t*0.5); // Move closer
                            const h1X = cx - dist/2; const h2X = cx + dist/2;
                            
                            ctx.fillStyle = '#9ca3af'; 
                            ctx.beginPath(); ctx.arc(h1X, cy, 20, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.textAlign="center"; ctx.fillText("H", h1X, cy+5);
                            ctx.fillStyle = '#9ca3af'; 
                            ctx.beginPath(); ctx.arc(h2X, cy, 20, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.fillText("H", h2X, cy+5);
                            
                            // Shared Electrons
                            const angle = time * 5;
                            const e1X = h1X + Math.cos(angle)*30; const e1Y = cy + Math.sin(angle)*30;
                            const e2X = h2X + Math.cos(angle + Math.PI)*30; const e2Y = cy + Math.sin(angle + Math.PI)*30;
                            
                            // If close, orbit both? Simplified: just show them between
                            if (t > 0.8) {
                                ctx.fillStyle = '#3b82f6';
                                ctx.beginPath(); ctx.arc(cx, cy - 10, 5, 0, Math.PI*2); ctx.fill();
                                ctx.beginPath(); ctx.arc(cx, cy + 10, 5, 0, Math.PI*2); ctx.fill();
                                ctx.fillStyle = '#000'; ctx.fillText("Covalent Bond (Sharing)", cx, h - 20);
                            } else {
                                ctx.fillStyle = '#3b82f6';
                                ctx.beginPath(); ctx.arc(h1X + 30, cy, 5, 0, Math.PI*2); ctx.fill();
                                ctx.beginPath(); ctx.arc(h2X - 30, cy, 5, 0, Math.PI*2); ctx.fill();
                            }
                        }
                    } else if (this.mode === 'balancing') {
                        // H2 + O2 -> H2O
                        const hCountL = this.c1 * 2;
                        const oCountL = this.c2 * 2;
                        const hCountR = this.c3 * 2;
                        const oCountR = this.c3 * 1;
                        
                        const balanced = (hCountL === hCountR) && (oCountL === oCountR);
                        
                        // Draw Left Side
                        ctx.fillStyle = '#000'; ctx.font = "14px Arial"; ctx.textAlign = "center";
                        ctx.fillText("Reactants", w/4, 30);
                        ctx.fillText(`H: ${hCountL}`, w/4 - 20, 50); ctx.fillText(`O: ${oCountL}`, w/4 + 20, 50);
                        
                        // Draw Molecules Left
                        for(let i=0; i<this.c1; i++) {
                            const x = w/4 - 40 + (i%3)*30; const y = 80 + Math.floor(i/3)*30;
                            ctx.fillStyle = '#9ca3af'; ctx.beginPath(); ctx.arc(x, y, 8, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x+10, y, 8, 0, Math.PI*2); ctx.fill();
                        }
                        for(let i=0; i<this.c2; i++) {
                            const x = w/4 + 40 + (i%3)*30; const y = 80 + Math.floor(i/3)*30;
                            ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x+12, y, 10, 0, Math.PI*2); ctx.fill();
                        }

                        // Draw Arrow
                        ctx.fillStyle = '#000'; ctx.font = "30px Arial"; ctx.fillText("‚Üí", cx, cy);

                        // Draw Right Side
                        ctx.font = "14px Arial";
                        ctx.fillText("Products", 3*w/4, 30);
                        ctx.fillText(`H: ${hCountR}`, 3*w/4 - 20, 50); ctx.fillText(`O: ${oCountR}`, 3*w/4 + 20, 50);

                        // Draw Molecules Right
                        for(let i=0; i<this.c3; i++) {
                            const x = 3*w/4 + (i%4)*40 - 40; const y = 80 + Math.floor(i/4)*40;
                            ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI*2); ctx.fill(); // O
                            ctx.fillStyle = '#9ca3af'; ctx.beginPath(); ctx.arc(x-8, y-8, 8, 0, Math.PI*2); ctx.fill(); // H
                            ctx.beginPath(); ctx.arc(x+8, y-8, 8, 0, Math.PI*2); ctx.fill(); // H
                        }

                        if(balanced) {
                            ctx.fillStyle = '#22c55e'; ctx.font = "bold 24px Arial"; ctx.fillText("BALANCED!", cx, h - 30);
                        } else {
                            ctx.fillStyle = '#ef4444'; ctx.font = "bold 24px Arial"; ctx.fillText("UNBALANCED", cx, h - 30);
                        }
                    }

                    this.animId = requestAnimationFrame(() => this.loop());
                }
            },

            // MOTION LAB SIMULATION
            motionLab: {
                mode: 'kinematics', // kinematics, forces, newton, friction, com
                animId: null,
                // Kinematics
                car: { x: 50, v: 0, a: 0 },
                // Forces & Friction
                box: { x: 250, v: 0, mass: 10, fApp: 0, fFric: 0, mu: 0.3 },
                // Center of Mass
                comSystem: { m1: 10, m2: 10, dist: 200 },
                
                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Motion & Forces Lab</h3>
                            <div class="flex flex-wrap justify-center gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.motionLab.setMode('kinematics')" id="mlab-btn-kinematics" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Kinematics</button>
                                <button onclick="Simulations.motionLab.setMode('forces')" id="mlab-btn-forces" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Net Force</button>
                                <button onclick="Simulations.motionLab.setMode('newton')" id="mlab-btn-newton" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Newton's 2nd Law</button>
                                <button onclick="Simulations.motionLab.setMode('friction')" id="mlab-btn-friction" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Friction</button>
                                <button onclick="Simulations.motionLab.setMode('com')" id="mlab-btn-com" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Center of Mass</button>
                            </div>
                            <div class="relative w-full max-w-lg h-64 bg-gray-50 border-2 border-gray-400 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="mlab-canvas" width="500" height="250"></canvas>
                            </div>
                            <div id="mlab-controls" class="w-full max-w-md mt-4 bg-gray-100 p-4 rounded-lg border border-gray-300"></div>
                            <div id="mlab-desc" class="mt-4 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.setMode('kinematics');
                },

                setMode: function(m) {
                    this.mode = m;
                    ['kinematics', 'forces', 'newton', 'friction', 'com'].forEach(k => {
                        const btn = document.getElementById(`mlab-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });

                    const controls = document.getElementById('mlab-controls');
                    const desc = document.getElementById('mlab-desc');

                    if (m === 'kinematics') {
                        this.car = { x: 50, v: 0, a: 0 };
                        controls.innerHTML = `
                            <div class="flex flex-col gap-2">
                                <div class="flex justify-between text-xs font-bold"><span>Velocity</span><span id="mlab-v-val">0 m/s</span></div>
                                <input type="range" min="0" max="100" value="0" class="w-full accent-blue-600" oninput="Simulations.motionLab.car.v=parseInt(this.value); document.getElementById('mlab-v-val').textContent=this.value+' m/s'">
                                <div class="flex justify-between text-xs font-bold"><span>Acceleration</span><span id="mlab-a-val">0 m/s¬≤</span></div>
                                <input type="range" min="-5" max="5" value="0" step="0.1" class="w-full accent-red-600" oninput="Simulations.motionLab.car.a=parseFloat(this.value); document.getElementById('mlab-a-val').textContent=this.value+' m/s¬≤'">
                            </div>
                        `;
                        desc.textContent = "Kinematics: Observe how Velocity and Acceleration affect Position. Acceleration changes Velocity.";
                    } else if (m === 'forces') {
                        this.box = { x: 250, v: 0, mass: 10, fApp: 0, fFric: 0, mu: 0 };
                        controls.innerHTML = `
                            <div class="flex flex-col gap-2">
                                <div class="flex justify-between text-xs font-bold"><span>Applied Force (Right)</span><span id="mlab-f-val">0 N</span></div>
                                <input type="range" min="0" max="100" value="0" class="w-full accent-green-600" oninput="Simulations.motionLab.box.fApp=parseInt(this.value); Simulations.motionLab.updateForces()">
                                <div class="flex justify-between text-xs font-bold"><span>Opposing Force (Left)</span><span id="mlab-ff-val">0 N</span></div>
                                <input type="range" min="0" max="100" value="0" class="w-full accent-red-600" oninput="Simulations.motionLab.box.fFric=parseInt(this.value); Simulations.motionLab.updateForces()">
                            </div>
                        `;
                        desc.textContent = "Net Force: When forces are balanced (Net Force = 0), motion doesn't change. Unbalanced forces cause acceleration.";
                    } else if (m === 'newton') {
                        this.box = { x: 250, v: 0, mass: 5, fApp: 0, fFric: 0, mu: 0 }; 
                        controls.innerHTML = `
                            <div class="flex flex-col gap-2">
                                <div class="flex justify-between text-xs font-bold"><span>Mass</span><span id="mlab-m-val">5 kg</span></div>
                                <input type="range" min="1" max="20" value="5" class="w-full accent-purple-600" oninput="Simulations.motionLab.box.mass=parseInt(this.value); document.getElementById('mlab-m-val').textContent=this.value+' kg'">
                                <div class="flex justify-between text-xs font-bold"><span>Force</span><span id="mlab-nf-val">0 N</span></div>
                                <input type="range" min="-50" max="50" value="0" class="w-full accent-orange-600" oninput="Simulations.motionLab.box.fApp=parseInt(this.value); document.getElementById('mlab-nf-val').textContent=this.value+' N'">
                            </div>
                        `;
                        desc.textContent = "Newton's 2nd Law (F=ma): Acceleration depends on Force and Mass. More Force = More Accel. More Mass = Less Accel.";
                    } else if (m === 'friction') {
                        this.box = { x: 250, v: 0, mass: 10, fApp: 0, fFric: 0, mu: 0.3 };
                        controls.innerHTML = `
                            <div class="flex flex-col gap-2">
                                <div class="flex justify-between text-xs font-bold"><span>Applied Force</span><span id="mlab-fric-f-val">0 N</span></div>
                                <input type="range" min="0" max="100" value="0" class="w-full accent-green-600" oninput="Simulations.motionLab.box.fApp=parseInt(this.value); document.getElementById('mlab-fric-f-val').textContent=this.value+' N'">
                                <div class="flex justify-between text-xs font-bold"><span>Surface Roughness (¬µ)</span><span id="mlab-mu-val">0.3</span></div>
                                <input type="range" min="0" max="1" step="0.1" value="0.3" class="w-full accent-gray-600" oninput="Simulations.motionLab.box.mu=parseFloat(this.value); document.getElementById('mlab-mu-val').textContent=this.value">
                            </div>
                        `;
                        desc.textContent = "Friction: Opposes motion. Friction Force = ¬µ √ó Normal Force. If Applied Force > Friction, the box moves.";
                    } else if (m === 'com') {
                        controls.innerHTML = `
                            <div class="flex flex-col gap-2">
                                <div class="flex justify-between text-xs font-bold"><span>Mass 1 (Left)</span><span id="mlab-m1-val">10 kg</span></div>
                                <input type="range" min="1" max="50" value="10" class="w-full accent-blue-600" oninput="Simulations.motionLab.comSystem.m1=parseInt(this.value); document.getElementById('mlab-m1-val').textContent=this.value+' kg'">
                                <div class="flex justify-between text-xs font-bold"><span>Mass 2 (Right)</span><span id="mlab-m2-val">10 kg</span></div>
                                <input type="range" min="1" max="50" value="10" class="w-full accent-red-600" oninput="Simulations.motionLab.comSystem.m2=parseInt(this.value); document.getElementById('mlab-m2-val').textContent=this.value+' kg'">
                            </div>
                        `;
                        desc.textContent = "Center of Mass: The balance point of the system. Heavier masses pull the center of mass closer to them.";
                    }

                    this.start();
                },

                updateForces: function() {
                    document.getElementById('mlab-f-val').textContent = this.box.fApp + " N";
                    document.getElementById('mlab-ff-val').textContent = this.box.fFric + " N";
                },

                start: function() {
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                loop: function() {
                    const canvas = document.getElementById('mlab-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    const dt = 0.016; // approx 60fps

                    ctx.clearRect(0,0,w,h);

                    // Ground
                    ctx.fillStyle = '#e5e7eb'; ctx.fillRect(0, h-50, w, 50);
                    ctx.strokeStyle = '#9ca3af'; ctx.beginPath(); ctx.moveTo(0, h-50); ctx.lineTo(w, h-50); ctx.stroke();

                    if (this.mode === 'kinematics') {
                        // Update physics
                        this.car.v += this.car.a * dt * 10; // Scale up for visual
                        this.car.x += this.car.v * dt * 10;
                        if (this.car.x > w + 50) this.car.x = -50;
                        if (this.car.x < -50) this.car.x = w + 50;

                        // Draw Car
                        const y = h - 70;
                        ctx.fillStyle = '#3b82f6'; ctx.fillRect(this.car.x, y, 60, 30); // Body
                        ctx.fillStyle = '#1e3a8a'; ctx.fillRect(this.car.x + 10, y - 15, 40, 15); // Top
                        ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(this.car.x + 15, y + 30, 8, 0, Math.PI*2); ctx.fill(); // Wheel
                        ctx.beginPath(); ctx.arc(this.car.x + 45, y + 30, 8, 0, Math.PI*2); ctx.fill(); // Wheel

                        // Vectors
                        ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 3; // Velocity
                        ctx.beginPath(); ctx.moveTo(this.car.x + 30, y - 25); ctx.lineTo(this.car.x + 30 + this.car.v, y - 25); ctx.stroke();
                        if(Math.abs(this.car.v) > 1) { ctx.fillStyle='#22c55e'; ctx.beginPath(); ctx.lineTo(this.car.x + 30 + this.car.v, y - 25); ctx.lineTo(this.car.x + 30 + this.car.v - 5 * Math.sign(this.car.v), y - 30); ctx.lineTo(this.car.x + 30 + this.car.v - 5 * Math.sign(this.car.v), y - 20); ctx.fill(); }
                        
                        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3; // Acceleration
                        ctx.beginPath(); ctx.moveTo(this.car.x + 30, y - 40); ctx.lineTo(this.car.x + 30 + this.car.a * 20, y - 40); ctx.stroke();
                        if(Math.abs(this.car.a) > 0.1) { ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.lineTo(this.car.x + 30 + this.car.a * 20, y - 40); ctx.lineTo(this.car.x + 30 + this.car.a * 20 - 5 * Math.sign(this.car.a), y - 45); ctx.lineTo(this.car.x + 30 + this.car.a * 20 - 5 * Math.sign(this.car.a), y - 35); ctx.fill(); }

                        ctx.fillStyle = '#000'; ctx.font = "12px Arial"; ctx.fillText("v", this.car.x + 30, y - 15); ctx.fillText("a", this.car.x + 30, y - 45);

                    } else if (this.mode === 'forces' || this.mode === 'newton' || this.mode === 'friction') {
                        // Physics
                        let netForce = 0;
                        if (this.mode === 'forces') {
                            netForce = this.box.fApp - this.box.fFric;
                        } else if (this.mode === 'friction') {
                            // Calculate friction based on Normal force (mg) and mu
                            const g = 9.8;
                            const normalForce = this.box.mass * g;
                            const maxFriction = this.box.mu * normalForce;
                            
                            // Simple static/kinetic model
                            if (Math.abs(this.box.v) < 0.1 && this.box.fApp <= maxFriction) {
                                this.box.fFric = this.box.fApp; // Static friction matches applied
                                netForce = 0;
                                this.box.v = 0;
                            } else {
                                this.box.fFric = maxFriction; // Kinetic friction
                                netForce = this.box.fApp - this.box.fFric;
                            }
                        } else {
                            netForce = this.box.fApp;
                        }
                        
                        const accel = netForce / this.box.mass;
                        this.box.v += accel * dt;
                        this.box.v *= 0.98; // Friction/Damping for stability in sim
                        this.box.x += this.box.v * dt * 10;

                        if (this.box.x > w - 50) { this.box.x = w - 50; this.box.v *= -0.5; }
                        if (this.box.x < 0) { this.box.x = 0; this.box.v *= -0.5; }

                        // Draw Box
                        const y = h - 100;
                        const size = 50 + this.box.mass * 2; // Size based on mass
                        ctx.fillStyle = '#d97706'; ctx.fillRect(this.box.x, h - 50 - size, size, size);
                        ctx.strokeStyle = '#78350f'; ctx.strokeRect(this.box.x, h - 50 - size, size, size);
                        ctx.fillStyle = '#fff'; ctx.font = "14px Arial"; ctx.textAlign = "center";
                        ctx.fillText(this.box.mass + "kg", this.box.x + size/2, h - 50 - size/2);

                        // Draw Force Vectors
                        const cx = this.box.x + size/2;
                        const cy = h - 50 - size/2;
                        
                        if (this.mode === 'forces' || this.mode === 'friction') {
                            // Applied
                            if (this.box.fApp > 0) {
                                ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 4;
                                ctx.beginPath(); ctx.moveTo(cx + size/2, cy); ctx.lineTo(cx + size/2 + this.box.fApp, cy); ctx.stroke();
                                ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.lineTo(cx + size/2 + this.box.fApp, cy); ctx.lineTo(cx + size/2 + this.box.fApp - 5, cy - 5); ctx.lineTo(cx + size/2 + this.box.fApp - 5, cy + 5); ctx.fill();
                            }
                            // Friction
                            if (this.box.fFric > 0) {
                                ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 4;
                                ctx.beginPath(); ctx.moveTo(cx - size/2, cy); ctx.lineTo(cx - size/2 - this.box.fFric, cy); ctx.stroke();
                                ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.lineTo(cx - size/2 - this.box.fFric, cy); ctx.lineTo(cx - size/2 - this.box.fFric + 5, cy - 5); ctx.lineTo(cx - size/2 - this.box.fFric + 5, cy + 5); ctx.fill();
                            }
                        } else {
                            // Newton mode (single force vector)
                            if (Math.abs(this.box.fApp) > 0) {
                                ctx.strokeStyle = '#f97316'; ctx.lineWidth = 4;
                                const dir = Math.sign(this.box.fApp);
                                const len = Math.abs(this.box.fApp) * 2;
                                const startX = dir > 0 ? cx + size/2 : cx - size/2;
                                ctx.beginPath(); ctx.moveTo(startX, cy); ctx.lineTo(startX + len * dir, cy); ctx.stroke();
                                ctx.fillStyle = '#f97316'; ctx.beginPath(); ctx.lineTo(startX + len * dir, cy); ctx.lineTo(startX + len * dir - 5 * dir, cy - 5); ctx.lineTo(startX + len * dir - 5 * dir, cy + 5); ctx.fill();
                            }
                        }

                        // Net Force / Accel Text
                        ctx.fillStyle = '#000'; ctx.font = "16px Arial"; ctx.textAlign = "center";
                        ctx.fillText(`Net Force: ${netForce} N`, w/2, 30);
                        ctx.fillText(`Accel: ${accel.toFixed(2)} m/s¬≤`, w/2, 50);
                        if (this.mode === 'friction') {
                            ctx.font = "12px Arial";
                            ctx.fillText(`Friction Coeff (¬µ): ${this.box.mu}`, w/2, 70);
                        }
                    } else if (this.mode === 'com') {
                        const m1 = this.comSystem.m1;
                        const m2 = this.comSystem.m2;
                        const dist = this.comSystem.dist;
                        const cx = w/2; const cy = h/2;
                        
                        // Calculate COM relative to m1
                        // x_com = (m1*0 + m2*dist) / (m1+m2)
                        const comX_rel = (m2 * dist) / (m1 + m2);
                        
                        // Draw Seesaw line
                        const startX = cx - dist/2;
                        const endX = cx + dist/2;
                        ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 4;
                        ctx.beginPath(); ctx.moveTo(startX, cy); ctx.lineTo(endX, cy); ctx.stroke();
                        
                        // Draw Masses
                        const r1 = 10 + m1; const r2 = 10 + m2;
                        ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(startX, cy - r1, r1, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.font="12px Arial"; ctx.textAlign="center"; ctx.fillText(m1, startX, cy - r1 + 4);
                        ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(endX, cy - r2, r2, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.fillText(m2, endX, cy - r2 + 4);
                        
                        // Draw COM Indicator
                        const absComX = startX + comX_rel;
                        ctx.fillStyle = '#22c55e';
                        ctx.beginPath(); ctx.moveTo(absComX, cy); ctx.lineTo(absComX - 10, cy + 20); ctx.lineTo(absComX + 10, cy + 20); ctx.fill();
                        ctx.fillStyle = '#000'; ctx.font = "bold 14px Arial"; ctx.fillText("Center of Mass", absComX, cy + 40);
                    }

                    this.animId = requestAnimationFrame(() => this.loop());
                }
            },

            // FORCES LAB SIMULATION
            forcesLab: {
                mode: 'bernoulli', // bernoulli, hydraulics, fluidPressure
                animId: null,
                // Bernoulli
                flowRate: 5,
                particles: [],
                // Hydraulics
                inputForce: 10,
                areaRatio: 4,
                // Fluid
                holes: [],

                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Applied Forces Lab</h3>
                            <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.forcesLab.setMode('bernoulli')" id="flab-btn-bernoulli" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Bernoulli</button>
                                <button onclick="Simulations.forcesLab.setMode('hydraulics')" id="flab-btn-hydraulics" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Hydraulic Lift</button>
                                <button onclick="Simulations.forcesLab.setMode('fluidPressure')" id="flab-btn-fluidPressure" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Fluid Pressure</button>
                            </div>
                            <div class="relative w-full max-w-lg h-64 bg-gray-50 border-2 border-gray-400 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="flab-canvas" width="500" height="250"></canvas>
                            </div>
                            <div id="flab-controls" class="w-full max-w-md mt-4 bg-gray-100 p-4 rounded-lg border border-gray-300"></div>
                            <div id="flab-desc" class="mt-4 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.setMode('bernoulli');
                },

                setMode: function(m) {
                    this.mode = m;
                    ['bernoulli', 'hydraulics', 'fluidPressure'].forEach(k => {
                        const btn = document.getElementById(`flab-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });

                    const controls = document.getElementById('flab-controls');
                    const desc = document.getElementById('flab-desc');

                    if (m === 'bernoulli') {
                        controls.innerHTML = `
                            <div class="flex flex-col gap-2">
                                <div class="flex justify-between text-xs font-bold"><span>Flow Rate</span><span id="flab-flow-val">${this.flowRate} L/s</span></div>
                                <input type="range" min="1" max="10" value="${this.flowRate}" class="w-full accent-blue-600" oninput="Simulations.forcesLab.flowRate=parseInt(this.value); document.getElementById('flab-flow-val').textContent=this.value+' L/s'">
                            </div>
                        `;
                        desc.textContent = "Bernoulli's Principle: As fluid speed increases, pressure decreases. Observe lower pressure (lower gauge) in the narrow section where fluid moves faster.";
                        this.particles = [];
                    } else if (m === 'hydraulics') {
                        controls.innerHTML = `
                            <div class="flex flex-col gap-2">
                                <div class="flex justify-between text-xs font-bold"><span>Input Force</span><span id="flab-force-val">${this.inputForce} N</span></div>
                                <input type="range" min="5" max="50" value="${this.inputForce}" class="w-full accent-green-600" oninput="Simulations.forcesLab.inputForce=parseInt(this.value); document.getElementById('flab-force-val').textContent=this.value+' N'">
                                <div class="flex justify-between text-xs font-bold"><span>Area Ratio (A2/A1)</span><span id="flab-ratio-val">${this.areaRatio}x</span></div>
                                <input type="range" min="2" max="10" value="${this.areaRatio}" class="w-full accent-orange-600" oninput="Simulations.forcesLab.areaRatio=parseInt(this.value); document.getElementById('flab-ratio-val').textContent=this.value+'x'">
                            </div>
                        `;
                        desc.textContent = "Pascal's Principle: Pressure (F/A) is constant in the fluid. A small force on a small area creates a large force on a large area.";
                    } else if (m === 'fluidPressure') {
                        this.holes = [];
                        controls.innerHTML = `<button onclick="Simulations.forcesLab.holes=[]" class="w-full bg-gray-200 hover:bg-gray-300 py-2 rounded font-bold text-sm">Clear Holes</button>`;
                        desc.textContent = "Fluid Pressure increases with depth. Click on the tank to poke a hole and see how fast the water shoots out.";
                    }

                    this.start();
                },

                start: function() {
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                loop: function() {
                    const canvas = document.getElementById('flab-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    
                    ctx.clearRect(0,0,w,h);
                    ctx.textAlign = "center";

                    if (this.mode === 'bernoulli') {
                        const cy = h/2;
                        const getPipeHeight = (x) => {
                            if (x < 150) return 100;
                            if (x < 200) return 100 - (60 * (x-150)/50);
                            if (x < 300) return 40;
                            if (x < 350) return 40 + (60 * (x-300)/50);
                            return 100;
                        };

                        // Draw Pipe
                        ctx.fillStyle = '#e0f2fe'; ctx.beginPath(); ctx.moveTo(0, cy - 50);
                        for(let x=0; x<=w; x+=10) ctx.lineTo(x, cy - getPipeHeight(x)/2);
                        ctx.lineTo(w, cy + 50);
                        for(let x=w; x>=0; x-=10) ctx.lineTo(x, cy + getPipeHeight(x)/2);
                        ctx.closePath(); ctx.fill(); ctx.strokeStyle = '#374151'; ctx.lineWidth = 3; ctx.stroke();

                        // Particles
                        if (this.particles.length < 50) this.particles.push({x: Math.random()*w, y: (Math.random()-0.5)});
                        ctx.fillStyle = '#3b82f6';
                        this.particles.forEach(p => {
                            const hx = getPipeHeight(p.x);
                            const speed = (this.flowRate * 20) / hx;
                            p.x += speed; if (p.x > w) p.x = 0;
                            const py = cy + p.y * hx * 0.8;
                            ctx.beginPath(); ctx.arc(p.x, py, 3, 0, Math.PI*2); ctx.fill();
                        });

                        // Gauges
                        const drawGauge = (x, label) => {
                            const hx = getPipeHeight(x);
                            const speed = (this.flowRate * 20) / hx;
                            
                            // Anchor pressure at inlet (wide section) to be 1.0 (High P) by using relative velocity squared.
                            const hInlet = 100; // Height of the wide input/output sections
                            const speedInlet = (this.flowRate * 20) / hInlet;
                            const k = 0.043; // A constant scaled to make the pressure in the throat drop to ~0.1 at max flow
                            const pressure = Math.max(0.1, Math.min(1.0, 1.0 - (Math.pow(speed, 2) - Math.pow(speedInlet, 2)) * k));
                            
                            const gy = cy - hx/2;
                            ctx.fillStyle = '#9ca3af'; ctx.fillRect(x-5, gy-40, 10, 40);
                            ctx.beginPath(); ctx.arc(x, gy-40, 20, 0, Math.PI*2); ctx.fillStyle='#fff'; ctx.fill(); ctx.stroke();
                            const angle = Math.PI + pressure * Math.PI;
                            ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(x, gy-40); ctx.lineTo(x + Math.cos(angle)*15, gy-40 + Math.sin(angle)*15); ctx.stroke();
                            ctx.fillStyle = '#000'; ctx.font = '10px Arial'; ctx.fillText(label, x, gy - 65); ctx.fillText(pressure < 0.5 ? "Low P" : "High P", x, gy - 30);
                        };
                        drawGauge(250, "Narrow");
                    } else if (this.mode === 'hydraulics') {
                        const p1Area = 20; const p2Area = p1Area * this.areaRatio; const p1Radius = Math.sqrt(p1Area / Math.PI) * 5; const p2Radius = Math.sqrt(p2Area / Math.PI) * 5;
                        const p1X = 150; const p2X = 350; const pressure = this.inputForce / p1Area; const outputForce = pressure * p2Area;
                        const p1Y = 160 + (50 - this.inputForce); const p2Y = 160 - (outputForce / this.areaRatio);
                        ctx.fillStyle = '#bfdbfe'; ctx.fillRect(p1X - p1Radius, p1Y, p1Radius*2, h - p1Y); ctx.fillRect(p2X - p2Radius, p2Y, p2Radius*2, h - p2Y); ctx.fillRect(p1X + p1Radius, h - 40, p2X - p1X - p2Radius - p1Radius, 40);
                        ctx.fillStyle = '#6b7280'; ctx.fillRect(p1X - p1Radius, p1Y - 10, p1Radius*2, 10); ctx.fillRect(p2X - p2Radius, p2Y - 10, p2Radius*2, 10);
                        const fScale = 0.12;
                        ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(p1X, p1Y - 15); ctx.lineTo(p1X, p1Y - 15 - this.inputForce * fScale); ctx.stroke(); ctx.fillStyle = '#16a34a'; ctx.fillText(`${this.inputForce} N`, p1X, p1Y - 20 - this.inputForce * fScale);
                        ctx.strokeStyle = '#ef4444'; ctx.beginPath(); ctx.moveTo(p2X, p2Y - 15); ctx.lineTo(p2X, p2Y - 15 - outputForce * fScale); ctx.stroke(); ctx.fillStyle = '#ef4444'; ctx.fillText(`${outputForce.toFixed(0)} N`, p2X, p2Y - 20 - outputForce * fScale);
                    } else if (this.mode === 'fluidPressure') {
                        const tankW = 100; const tankH = 120; const tankX = (w - tankW)/5; const tankY = 30;
                        ctx.fillStyle = '#bfdbfe'; ctx.fillRect(tankX, tankY, tankW, tankH); ctx.strokeStyle = '#374151'; ctx.lineWidth = 2; ctx.strokeRect(tankX, tankY, tankW, tankH);
                        canvas.onclick = (e) => { if (this.mode !== 'fluidPressure') return; const rect = canvas.getBoundingClientRect(); const mx = e.clientX - rect.left; const my = e.clientY - rect.top; if (mx > tankX && mx < tankX + tankW && my > tankY && my < tankY + tankH) { this.holes.push({y: my}); } };
                        const time = Date.now() / 100;
                        this.holes.forEach(hole => { 
                            const depth = hole.y - tankY; 
                            const velocity = Math.sqrt(depth * 0.5) * 2; 
                            for(let i=0; i<20; i++) {
                                const t = (time + i * 1.5) % 30;
                                const streamX = tankX + tankW + velocity * t; 
                                const streamY = hole.y + 0.5 * 9.8 * t * t * 0.1; 
                                if(streamY < h && streamX < w) { ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(streamX, streamY, 3, 0, Math.PI*2); ctx.fill(); }
                            }
                        });
                    }
                    this.animId = requestAnimationFrame(() => this.loop());
                }
            },

            // NEWTON LAB SIMULATION
            newtonLab: {
                mode: 'inertia', // inertia, secondLaw, thirdLaw, gravity
                animId: null,
                // Inertia
                puck: { x: 50, v: 0 },
                friction: false,
                // 2nd Law
                rocket: { y: 200, v: 0, a: 0, mass: 5, force: 0 },
                // 3rd Law
                cannon: { x: 200, v: 0, m: 100 },
                ball: { x: 200, v: 0, m: 10 },
                fired: false,
                // Gravity
                dropY: 50, dropV: 0, vacuum: false, dropping: false,

                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Newton's Laws Lab</h3>
                            <div class="flex flex-wrap justify-center gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.newtonLab.setMode('inertia')" id="nl-btn-inertia" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Inertia (1st Law)</button>
                                <button onclick="Simulations.newtonLab.setMode('secondLaw')" id="nl-btn-secondLaw" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">F=ma (2nd Law)</button>
                                <button onclick="Simulations.newtonLab.setMode('thirdLaw')" id="nl-btn-thirdLaw" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Action-Reaction (3rd Law)</button>
                                <button onclick="Simulations.newtonLab.setMode('gravity')" id="nl-btn-gravity" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Gravity Drop</button>
                            </div>
                            <div class="relative w-full max-w-lg h-64 bg-gray-50 border-2 border-gray-400 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="nl-canvas" width="500" height="250"></canvas>
                            </div>
                            <div id="nl-controls" class="w-full max-w-md mt-4 bg-gray-100 p-4 rounded-lg border border-gray-300"></div>
                            <div id="nl-desc" class="mt-4 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.setMode('inertia');
                },

                setMode: function(m) {
                    this.mode = m;
                    ['inertia', 'secondLaw', 'thirdLaw', 'gravity'].forEach(k => {
                        const btn = document.getElementById(`nl-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });
                    const controls = document.getElementById('nl-controls');
                    const desc = document.getElementById('nl-desc');

                    if (m === 'inertia') {
                        this.puck = { x: 50, v: 0 };
                        controls.innerHTML = `<div class="flex gap-4 justify-center"><button onclick="Simulations.newtonLab.puck.v=5" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">Push Puck</button><label class="flex items-center gap-2"><input type="checkbox" onchange="Simulations.newtonLab.friction=this.checked"> Enable Friction</label></div>`;
                        desc.textContent = "1st Law: An object in motion stays in motion unless acted upon by a force (like Friction).";
                    } else if (m === 'secondLaw') {
                        this.rocket = { y: 200, v: 0, a: 0, mass: 5, force: 0 };
                        controls.innerHTML = `<div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="text-xs font-bold w-16">Mass:</span><input type="range" min="1" max="10" value="5" class="flex-1" oninput="Simulations.newtonLab.rocket.mass=parseInt(this.value)"></div><div class="flex items-center gap-2"><span class="text-xs font-bold w-16">Thrust:</span><input type="range" min="0" max="100" value="0" class="flex-1" oninput="Simulations.newtonLab.rocket.force=parseInt(this.value)"></div></div>`;
                        desc.textContent = "2nd Law: F=ma. Increase Thrust (Force) or decrease Mass to increase Acceleration.";
                    } else if (m === 'thirdLaw') {
                        this.cannon = { x: 200, v: 0, m: 100 };
                        this.ball = { x: 200, v: 0, m: 10 };
                        this.fired = false;
                        controls.innerHTML = `
                            <div class="flex flex-col gap-3">
                                <div class="flex justify-center gap-4">
                                    <div class="text-center"><span class="text-xs font-bold block text-gray-600">Cannon (kg)</span><input type="range" min="50" max="200" value="100" class="accent-gray-600" oninput="Simulations.newtonLab.cannon.m=parseInt(this.value); document.getElementById('nl-cm-val').textContent=this.value"><div id="nl-cm-val" class="text-xs font-mono">100</div></div>
                                    <div class="text-center"><span class="text-xs font-bold block text-gray-600">Ball (kg)</span><input type="range" min="1" max="20" value="10" class="accent-red-600" oninput="Simulations.newtonLab.ball.m=parseInt(this.value); document.getElementById('nl-bm-val').textContent=this.value"><div id="nl-bm-val" class="text-xs font-mono">10</div></div>
                                </div>
                                <button onclick="Simulations.newtonLab.fireCannon()" class="w-full bg-red-600 text-white py-2 rounded font-bold hover:bg-red-700 transition shadow-md">FIRE CANNON! (& reset)</button>
                            </div>`;
                        desc.textContent = "3rd Law: Action-Reaction. The cannon exerts force on the ball (Action), and the ball exerts an equal and opposite force on the cannon (Reaction/Recoil).";
                    } else if (m === 'gravity') {
                        this.dropY = 60;
                        this.dropV = 0;
                        this.featherY = 60;
                        this.dropping = false;
                        controls.innerHTML = `<div class="flex gap-4 justify-center items-center"><button onclick="Simulations.newtonLab.drop()" class="px-4 py-2 bg-purple-600 text-white rounded font-bold">Drop</button><label class="flex items-center gap-2"><input type="checkbox" onchange="Simulations.newtonLab.vacuum=this.checked"> Vacuum (No Air)</label></div>`;
                        desc.textContent = "Gravity: In a vacuum, all objects fall at the same rate regardless of mass. Air resistance slows the feather down.";
                    }
                    this.start();
                },

                fireCannon: function() {
                    if(this.fired) {
                        this.cannon.x = 200; this.cannon.v = 0;
                        this.ball.x = 200; this.ball.v = 0;
                        this.fired = false;
                        return;
                    }
                    this.fired = true;
                    const impulse = 50 * Math.sqrt(this.ball.m);
                    this.ball.v = impulse / this.ball.m;
                    this.cannon.v = -impulse / this.cannon.m;
                },

                drop: function() {
                    this.dropY = 60;
                    this.dropV = 0; 
                    this.featherY = 60; 
                    this.dropping = true;
                },

                start: function() { if(this.animId) cancelAnimationFrame(this.animId); this.loop(); },

                loop: function() {
                    const canvas = document.getElementById('nl-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    ctx.clearRect(0,0,w,h);

                    if (this.mode === 'inertia') {
                        if (this.friction) this.puck.v *= 0.98;
                        this.puck.x += this.puck.v;
                        if (this.puck.x > w) this.puck.x = -20;
                        ctx.fillStyle = '#e5e7eb'; ctx.fillRect(0, h/2, w, h/2); // Ice
                        ctx.fillStyle = '#374151'; ctx.beginPath(); ctx.ellipse(this.puck.x, h/2 + 10, 20, 10, 0, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = '#000'; ctx.fillText(this.friction ? "Friction ON" : "Friction OFF", 40, 20);
                    } else if (this.mode === 'secondLaw') {
                        const g = 0.1;
                        const netF = this.rocket.force - (this.rocket.mass * g * 10); // Simplified gravity
                        this.rocket.a = netF / this.rocket.mass;
                        this.rocket.v += this.rocket.a * 0.05;
                        this.rocket.y -= this.rocket.v;
                        if (this.rocket.y > 200) { this.rocket.y = 200; this.rocket.v = 0; }
                        if (this.rocket.y < -50) this.rocket.y = 250;
                        ctx.fillStyle = '#ef4444'; ctx.fillRect(w/2 - 10, this.rocket.y, 20, 40); // Rocket
                        if (this.rocket.force > 0) { ctx.fillStyle = '#f59e0b'; ctx.beginPath(); ctx.moveTo(w/2-5, this.rocket.y+40); ctx.lineTo(w/2+5, this.rocket.y+40); ctx.lineTo(w/2, this.rocket.y+40+this.rocket.force/2); ctx.fill(); }
                        ctx.fillStyle = '#000'; ctx.fillText(`Accel: ${this.rocket.a.toFixed(2)}`, 40, 20);
                    } else if (this.mode === 'thirdLaw') {
                        if (this.fired) {
                            this.cannon.x += this.cannon.v;
                            this.ball.x += this.ball.v;
                            this.cannon.v *= 0.95; // Friction
                        }
                        // Ground
                        ctx.fillStyle = '#d1d5db'; ctx.fillRect(0, h-40, w, 40);

                        // Ruler
                        ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1; ctx.beginPath();
                        ctx.fillStyle = '#6b7280'; ctx.font = "10px Arial"; ctx.textAlign = "center";
                        for(let x=0; x<=w; x+=10) {
                            const isMajor = x % 50 === 0;
                            const tickH = isMajor ? 15 : 8;
                            ctx.moveTo(x, h-40); ctx.lineTo(x, h-40+tickH);
                            if(isMajor) ctx.fillText(x, x, h-15);
                        }
                        ctx.stroke();

                        // Cannon
                        const cy = h - 60;
                        // Position Marker
                        ctx.strokeStyle = 'rgba(239, 68, 68, 0.5)'; ctx.setLineDash([5, 3]); ctx.lineWidth = 2; ctx.beginPath();
                        ctx.moveTo(this.cannon.x, cy + 20); ctx.lineTo(this.cannon.x, h - 40); ctx.stroke(); ctx.setLineDash([]);

                        ctx.fillStyle = '#4b5563'; ctx.fillRect(this.cannon.x - 20, cy, 40, 20); // Body
                        ctx.beginPath(); ctx.arc(this.cannon.x - 15, cy + 20, 8, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(this.cannon.x + 15, cy + 20, 8, 0, Math.PI*2); ctx.fill(); // Wheels
                        ctx.fillStyle = '#374151'; ctx.beginPath(); ctx.moveTo(this.cannon.x, cy+5); ctx.lineTo(this.cannon.x+30, cy-5); ctx.lineTo(this.cannon.x+30, cy+15); ctx.lineTo(this.cannon.x, cy+15); ctx.fill(); // Barrel
                        // Ball
                        const bx = this.fired ? this.ball.x : this.cannon.x + 10; const by = cy + 5;
                        ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(bx, by, this.ball.m/2 + 2, 0, Math.PI*2); ctx.fill();
                        // Info
                        ctx.fillStyle = '#000'; ctx.font = "12px Arial"; ctx.textAlign = "center"; ctx.fillText(`${this.cannon.m}kg`, this.cannon.x, cy - 10);
                        if(this.fired) ctx.fillText(`${this.ball.m}kg`, bx, by - 15);
                    } else if (this.mode === 'gravity') {
                        const groundY = h - 20;
                        if (this.dropping) {
                            // Hammer Physics
                            if (this.dropY < groundY) {
                                this.dropV += 0.2; // Gravity
                                this.dropY += this.dropV;
                                if (this.dropY > groundY) this.dropY = groundY;
                            }

                            // Feather Physics
                            if (this.vacuum) {
                                this.featherY = this.dropY; // In vacuum, it falls with the hammer
                            } else {
                                if (this.featherY < groundY) {
                                    this.featherY += 1.5; // Steady slow motion (Terminal Velocity)
                                    if (this.featherY > groundY) this.featherY = groundY;
                                }
                            }

                            // Stop simulation when both hit the ground
                            if (this.dropY >= groundY && this.featherY >= groundY) {
                                this.dropping = false;
                            }
                        }
                        // Hammer
                        ctx.fillStyle = '#4b5563'; ctx.fillRect(150, this.dropY, 30, 20); ctx.fillRect(160, this.dropY-30, 10, 30);
                        // Feather
                        ctx.save();
                        ctx.translate(350, this.featherY);
                        ctx.rotate(-0.1);
                        ctx.fillStyle = '#fff'; ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 1;
                        ctx.beginPath(); ctx.moveTo(0, -20); ctx.quadraticCurveTo(-15, -5, -2, 20); ctx.lineTo(0, 20); ctx.fill(); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(0, -20); ctx.quadraticCurveTo(15, -5, 2, 20); ctx.lineTo(0, 20); ctx.fill(); ctx.stroke();
                        ctx.strokeStyle = '#6b7280'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0, -20); ctx.lineTo(0, 25); ctx.stroke();
                        ctx.restore();

                        // Text
                        ctx.fillStyle = '#000'; ctx.textAlign = "center"; ctx.font = "bold 14px Arial";
                        ctx.fillText("Hammer", 165, 20); ctx.fillText("Feather", 350, 20);
                        ctx.textAlign = "start";
                    }
                    this.animId = requestAnimationFrame(() => this.loop());
                }
            }
            ,

            // ENERGY & RAMP LAB SIMULATION (Lesson 3)
            energyRampLab: {
                mode: 'forces', // forces, energy
                animId: null,
                angle: 30,
                mass: 10,
                block: { x: 0, v: 0, sliding: false },
                
                render: function(container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center h-full w-full">
                            <h3 class="font-bold text-lg mb-2 text-gray-700">Ramp Dynamics Lab</h3>
                            <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded">
                                <button onclick="Simulations.energyRampLab.setMode('forces')" id="erl-btn-forces" class="px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600">Force Components</button>
                                <button onclick="Simulations.energyRampLab.setMode('energy')" id="erl-btn-energy" class="px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200">Energy Transformation</button>
                            </div>
                            <div class="relative w-full max-w-lg h-64 bg-gray-50 border-2 border-gray-400 rounded-lg shadow-inner flex items-center justify-center overflow-hidden">
                                <canvas id="erl-canvas" width="500" height="250"></canvas>
                                <div id="erl-overlay" class="absolute top-2 left-2 text-xs text-gray-500 pointer-events-none"></div>
                            </div>
                            <div id="erl-controls" class="w-full max-w-md mt-4 bg-gray-100 p-4 rounded-lg border border-gray-300"></div>
                            <div id="erl-desc" class="mt-4 text-sm text-gray-600 font-medium text-center max-w-md bg-blue-50 p-2 rounded border border-blue-100"></div>
                        </div>
                    `;
                    this.setMode('forces');
                },

                setMode: function(m) {
                    this.mode = m;
                    this.resetBlock();
                    
                    ['forces', 'energy'].forEach(k => {
                        const btn = document.getElementById(`erl-btn-${k}`);
                        if(k === m) btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow text-blue-600";
                        else btn.className = "px-3 py-1 rounded text-sm font-bold text-gray-500 hover:bg-gray-200";
                    });

                    const controls = document.getElementById('erl-controls');
                    const desc = document.getElementById('erl-desc');

                    if (m === 'forces') {
                        controls.innerHTML = `
                            <div class="flex flex-col gap-2">
                                <div class="flex justify-between text-xs font-bold"><span>Ramp Angle</span><span id="erl-angle-val">${this.angle}¬∞</span></div>
                                <input type="range" min="10" max="60" value="${this.angle}" class="w-full accent-blue-600" oninput="Simulations.energyRampLab.angle=parseInt(this.value); document.getElementById('erl-angle-val').textContent=this.value+'¬∞'">
                                <div class="flex justify-between text-xs font-bold"><span>Mass</span><span id="erl-mass-val">${this.mass} kg</span></div>
                                <input type="range" min="5" max="50" value="${this.mass}" class="w-full accent-purple-600" oninput="Simulations.energyRampLab.mass=parseInt(this.value); document.getElementById('erl-mass-val').textContent=this.value+' kg'">
                            </div>
                        `;
                        desc.textContent = "Gravity ($F_g$) splits into Parallel ($F_{\\parallel}$) and Perpendicular ($F_{\\perp}$) components. Steeper angle = More Parallel force.";
                    } else {
                        controls.innerHTML = `
                            <div class="flex flex-col gap-3">
                                <div class="flex justify-between text-xs font-bold"><span>Ramp Angle (Height)</span><span id="erl-angle-val">${this.angle}¬∞</span></div>
                                <input type="range" min="10" max="60" value="${this.angle}" class="w-full accent-blue-600" oninput="Simulations.energyRampLab.angle=parseInt(this.value); document.getElementById('erl-angle-val').textContent=this.value+'¬∞'; Simulations.energyRampLab.resetBlock()">
                                <button onclick="Simulations.energyRampLab.toggleSlide()" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Start / Reset Slide</button>
                            </div>
                        `;
                        desc.textContent = "Conservation of Energy: As the block slides down, Potential Energy (Height) converts into Kinetic Energy (Motion).";
                    }
                    this.start();
                },

                resetBlock: function() {
                    this.block.x = 0; // Relative to ramp top
                    this.block.v = 0;
                    this.block.sliding = false;
                },

                toggleSlide: function() {
                    if (this.block.sliding && this.block.x > 0) {
                        this.resetBlock();
                    } else {
                        this.block.sliding = true;
                    }
                },

                start: function() {
                    if(this.animId) cancelAnimationFrame(this.animId);
                    this.loop();
                },

                loop: function() {
                    const canvas = document.getElementById('erl-canvas');
                    if(!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const w = canvas.width; const h = canvas.height;
                    
                    ctx.clearRect(0,0,w,h);

                    // Physics Constants
                    const g = 9.8;
                    const simLen = 400; // Fixed physical length
                    const angleRad = this.angle * Math.PI / 180;

                    // Physics Update
                    if (this.mode === 'energy' && this.block.sliding) {
                        const a = g * Math.sin(angleRad);
                        this.block.v += a * 0.05; // dt
                        this.block.x += this.block.v * 0.5;
                        if (this.block.x > simLen - 50) {
                            this.block.x = simLen - 50;
                            this.block.sliding = false;
                        }
                    }

                    // Drawing Geometry (Scale to fit)
                    const maxRampHeight = h - 100;
                    const maxRampWidth = w - 100;
                    
                    // Calculate dimensions of the ramp at current angle
                    const physW = simLen * Math.cos(angleRad);
                    const physH = simLen * Math.sin(angleRad);
                    
                    // Determine scale factor
                    let scale = 1;
                    if (physH > maxRampHeight) scale = maxRampHeight / physH;
                    if (physW * scale > maxRampWidth) scale = maxRampWidth / physW;
                    
                    const drawLen = simLen * scale;
                    
                    // Positioning
                    const startX = 50; 
                    const endY = h - 50;
                    const startY = endY - (drawLen * Math.sin(angleRad));
                    const endX = startX + drawLen * Math.cos(angleRad);

                    // Draw Ramp
                    ctx.fillStyle = '#d1d5db'; 
                    ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(endX, endY); ctx.lineTo(startX, endY); ctx.closePath(); ctx.fill();
                    ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 2; ctx.stroke();

                    // Draw Block
                    const simDist = this.mode === 'forces' ? simLen / 2 : this.block.x;
                    const drawDist = simDist * scale;
                    
                    const blockX = startX + drawDist * Math.cos(angleRad);
                    const blockY = startY + drawDist * Math.sin(angleRad);
                    
                    ctx.save();
                    ctx.translate(blockX, blockY);
                    ctx.rotate(angleRad);
                    ctx.fillStyle = '#f59e0b'; ctx.fillRect(0, -30, 50, 30);
                    ctx.strokeStyle = '#b45309'; ctx.strokeRect(0, -30, 50, 30);
                    ctx.restore();

                    // Vectors or Energy Bars
                    if (this.mode === 'forces') {
                        const cx = blockX + 25 * Math.cos(angleRad) + 15 * Math.sin(angleRad);
                        const cy = blockY + 25 * Math.sin(angleRad) - 15 * Math.cos(angleRad);
                        const scale = this.mass * 1.5;
                        const gForce = scale * 2;
                        const perp = gForce * Math.cos(angleRad);
                        const para = gForce * Math.sin(angleRad);

                        // Fg (Gravity)
                        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3;
                        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx, cy + gForce); ctx.stroke();
                        ctx.fillStyle = '#ef4444'; ctx.fillText("Fg", cx + 5, cy + gForce);

                        // F_perp
                        ctx.strokeStyle = '#3b82f6';
                        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx - perp * Math.sin(angleRad), cy + perp * Math.cos(angleRad)); ctx.stroke();
                        
                        // F_para
                        ctx.strokeStyle = '#22c55e';
                        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx + para * Math.cos(angleRad), cy + para * Math.sin(angleRad)); ctx.stroke();
                        
                        // Components text
                        ctx.fillStyle = '#000'; ctx.font = "12px Arial";
                        ctx.fillText(`F_perp: ${Math.round(this.mass * 9.8 * Math.cos(angleRad))}N`, 10, 20);
                        ctx.fillText(`F_para: ${Math.round(this.mass * 9.8 * Math.sin(angleRad))}N`, 10, 40);
                    } else {
                        // Energy Bars
                        const maxSimH = simLen * Math.sin(angleRad);
                        const currentSimH = (simLen - simDist) * Math.sin(angleRad);
                        
                        const pe = this.mass * g * currentSimH;
                        const ke = this.mass * g * (maxSimH - currentSimH);
                        
                        // Max Possible Energy for CURRENT MASS (Angle=60, Len=400)
                        const maxPossibleEnergy = this.mass * g * (400 * Math.sin(60 * Math.PI / 180));
                        
                        const barX = w - 100; const barY = 50; const barW = 20; const barH = 100;
                        
                        // PE Bar
                        const peH = (pe / maxPossibleEnergy) * barH;
                        ctx.fillStyle = '#3b82f6'; ctx.fillRect(barX, barY + (barH - peH), barW, peH);
                        ctx.strokeRect(barX, barY, barW, barH);
                        ctx.fillStyle = '#000'; ctx.fillText("PE", barX, barY + barH + 15);

                        // KE Bar
                        const keH = (ke / maxPossibleEnergy) * barH;
                        ctx.fillStyle = '#22c55e'; ctx.fillRect(barX + 40, barY + (barH - keH), barW, keH);
                        ctx.strokeRect(barX + 40, barY, barW, barH);
                        ctx.fillStyle = '#000'; ctx.fillText("KE", barX + 40, barY + barH + 15);
                    }

                    this.animId = requestAnimationFrame(() => this.loop());
                }
            },
        };

        // Initialize App
        window.onload = function() {
            App.init();
        };
    </script>
</body>
</html>